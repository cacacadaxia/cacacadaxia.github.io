I"óÛ<p>[TOC]</p>

<h4 id="0-å‚è€ƒèµ„æ–™">0. å‚è€ƒèµ„æ–™</h4>

<h4 id="1-æç¾¤ä¸æä»£æ•°">1. æç¾¤ä¸æä»£æ•°</h4>

<p>æä»£æ•°ä¸æç¾¤çš„å…³ç³»å‚è€ƒã€ŒSLAM14è®²ã€ã€‚</p>

<p>å°½ç®¡åˆšä½“çš„å§¿æ€æœ‰å¾ˆå¤šç§ä¸åŒçš„è¡¨ç¤ºæ–¹æ³•ï¼Œå®ƒä»¬çš„ç§¯åˆ†æ–¹æ³•ä¹Ÿä¸ç›¸åŒï¼Œä½†è¿™å…¶ä¸­æœ‰ä¸€äº›å…±é€šçš„åœ°æ–¹ï¼Œåœ¨è¿™é‡Œä½œä¸€äº›ç®€è¦ä½†ä¸ä¸¥æ ¼çš„ä»‹ç»ã€‚åˆšä½“æ—‹è½¬ç¾¤ SO(3) æ˜¯ä¸€ä¸ªæç¾¤ï¼Œæ‰€è°“æç¾¤æ˜¯æŒ‡åŒæ—¶å…·æœ‰å…‰æ»‘æµå½¢å’Œç¾¤çš„ç»“æ„çš„ç©ºé—´ï¼ŒåŒæ—¶ç¾¤å†…çš„è¿ç®—ä¹Ÿæ˜¯å…‰æ»‘çš„ã€‚æç¾¤çš„å®šä¹‰éœ€è¦èŠ±å¾ˆé•¿ç¯‡å¹…è§£é‡Šæ¸…æ¥šï¼Œä¹Ÿä¸é‡è¦ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ SO(3) ä¸Šçš„æ¯ä¸€ä¸ªæ—‹è½¬ï¼Œéƒ½æœ‰ä¸€ä¸ªåˆ‡ç©ºé—´ã€‚è¿™ä¸ªåˆ‡ç©ºé—´æ˜¯ä¸€ä¸ª<strong>çº¿æ€§ç©ºé—´</strong>ï¼Œå®ƒçš„ç»´æ•°ä¸ SO(3) ç›¸åŒï¼Œå³å…·æœ‰ä¸‰ä¸ªè‡ªç”±åº¦ã€‚åœ¨æç¾¤çš„è¯­è¨€ä¸­ï¼Œåˆ‡ç©ºé—´ä¹Ÿå«åšæä»£æ•°ï¼ˆLie Algebraï¼‰ã€‚åˆ‡ç©ºé—´çš„ç›´è§‚ç†è§£æ˜¯ï¼šåˆ‡ç©ºé—´å†…çš„æ¯ä¸€ä¸ªå‘é‡ä»£è¡¨äº†ä¸€ä¸ªé€Ÿåº¦ï¼Œå¹¶ä¸”è¿™ä¸ªé€Ÿåº¦å¯ä»¥é€šè¿‡æç¾¤çš„æ€§è´¨ç§¯åˆ†æˆä¸€ä¸ªä½ç§»ï¼Œè€Œè¿™ä¸ªç§¯åˆ†å°±æ˜¯æç¾¤çš„æŒ‡æ•°æ˜ å°„ï¼ˆexponential mapï¼‰ã€‚å¯ä»¥è¯æ˜æŒ‡æ•°æ˜ å°„åœ¨<strong>å±€éƒ¨</strong>æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œ<a href="https://zhuanlan.zhihu.com/p/68294744">ä¹Ÿå°±æ˜¯æ¯ä¸ªé€Ÿåº¦éƒ½å¯¹åº”äº†å”¯ä¸€ä¸€ä¸ªä½ç§»</a>ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200526105822.png" alt="20200526105822" /></p>

<p>å¯¹ä¸Šè¿°ç†è®ºå¼•ç”¨åˆ°slamä¸­å»æœ‰ä¸‹é¢çš„å…³ç³»ã€‚</p>

<p>åœ¨ä¸‰ç»´è¡¨ç¤ºä¸­æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„å°±æ˜¯è½¬æ¢çŸ©é˜µä¸­çš„Rä¸tçš„æ–¹å‘é—®é¢˜ã€‚<span style="color:red"><strong>ä¸‹é¢è®°å½•ä¸€ç§æ¯”è¾ƒç›´æ¥çš„ç†è§£</strong></span>ã€‚
\(T_{w}^{c}=R_{w}^{c} P_{w}+t_{\overrightarrow{c w}}^{c}\)
ä¸‹é¢å¯¹æä»£æ•°ç›¸å…³é—®é¢˜è¿›è¡Œæ±‚å¯¼ã€‚æ±‚å¾®å°çš„å˜åŒ–è¿›è¡Œæ±‚å¯¼ã€‚</p>

\[\lim _{\delta \xi \rightarrow 0} \frac{\exp \left([\delta \xi+\xi]_{\times}\right) P_{w}-\exp (\hat{\xi}) P_{w}}{\delta \xi}
=\lim _{\delta \xi \rightarrow 0} \frac{\left[\mathbf{J}_{\ell}(\xi) \delta \xi\right]_{\times} P_{c}}{\delta \xi}=\left[\left[-P_{c}\right]_{\times}, \mathbf{I}_{3}\right]_{3 \times 6} \mathbf{J}_{\ell}\]

<p>å‡è®¾é›…å¯æ¯”çŸ©é˜µä¸º$\boldsymbol{H}=\frac{\partial h}{\partial \delta \boldsymbol{x}}$ï¼Œå¯ä»¥ç”¨é“¾å¼æ³•åˆ™è®¡ç®—$\boldsymbol{H}=\frac{\partial h}{\partial \delta x}=\frac{\partial h}{\partial x} \frac{\partial x}{\partial \delta x}$ã€‚</p>

<h5 id="é‚£ä¹ˆå¦‚ä½•å¯¹æä»£æ•°çš„éƒ¨åˆ†è¿›è¡Œæ±‚å¯¼å‘¢">é‚£ä¹ˆå¦‚ä½•å¯¹æä»£æ•°çš„éƒ¨åˆ†è¿›è¡Œæ±‚å¯¼å‘¢ï¼Ÿ</h5>

<p>åœ¨SLAMä¸­ç»å¸¸ç”¨åˆ°çš„æä»£æ•°çš„å†…å®¹ï¼Œè®¾å®šæ±‚è§£å˜æ¢çŸ©é˜µTçš„é€†ä¸ºï¼š
\(\boldsymbol{T}^{-1}=\left[\begin{array}{cc}
\boldsymbol{R}^{T} &amp; -\boldsymbol{R}^{T} \boldsymbol{t} \\
\boldsymbol{0}^{T} &amp; 1
\end{array}\right]\)</p>

<p>å‡è®¾æœ‰ä¸€ä¸ªæ—‹è½¬è½´ä¸º nï¼Œè§’åº¦ä¸º Î¸ çš„æ—‹è½¬ï¼Œç”±æ—‹è½¬å‘é‡åˆ°æ—‹è½¬çŸ©é˜µçš„è¿‡ç¨‹ç”±<strong>ç½—å¾·é‡Œæ ¼æ–¯å…¬å¼</strong>è¡¨æ˜å¦‚ä¸‹ï¼ŒåŒæ—¶ï¼Œä»–ä»¬æ­£æ˜¯ SO(3) ä¸Šæç¾¤ä¸æä»£ æ•°çš„å¯¹åº”å…³ç³»ã€‚
\(\boldsymbol{R}=\exp \left(\boldsymbol{\xi}^{\wedge}\right)=\cos \theta \boldsymbol{I}+(1-\cos \theta) \boldsymbol{n} \boldsymbol{n}^{T}+\sin \theta \boldsymbol{n}^{\wedge}\)
å¯¹äºSEï¼ˆ3ï¼‰ä¸Šçš„æŒ‡æ•°æ˜ å°„ï¼Œ
\(\exp \left(\boldsymbol{\xi}^{\wedge}\right)
\triangleq\left[\begin{array}{cc}
\boldsymbol{R} &amp; \boldsymbol{J} \rho \\
\boldsymbol{0}^{T} &amp; 1
\end{array}\right]=\boldsymbol{T}\)
é›…å¯æ¯”çŸ©é˜µå¯ä»¥å†™æˆï¼š
\(\boldsymbol{J}=\frac{\sin \theta}{\theta} \boldsymbol{I}+\left(1-\frac{\sin \theta}{\theta}\right) \boldsymbol{a} \boldsymbol{a}^{T}+\frac{1-\cos \theta}{\theta} \boldsymbol{a}^{\wedge}\)
ä¸‹é¢çš„å›¾ç›´è§‚çš„å±•ç¤ºäº†è¿™æ ·çš„å…³ç³»ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200518161621.png" alt="20200518161621" /></p>

<p>åœ¨å¯¹ç›¸æœºä½å§¿çš„æ±‚å¯¼é—®é¢˜ä¸­ï¼Œslam14è®² æœ‰æ¯”è¾ƒç›´æ¥çš„è®ºè¿°ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªæ–¹å‘ï¼š</p>

<p><span style="color:red">1. ç›´æ¥å¯¹æä»£æ•°æ±‚å¯¼ï¼Œåˆ©ç”¨æä»£æ•°çš„åŠ æ³•ï¼Œä½†æ˜¯å­˜åœ¨éš¾ä»¥æ¶ˆé™¤çš„é›…å¯æ¯”çŸ©é˜µ</span></p>

<p><span style="color:red">2.å·¦ä¹˜æ‰°åŠ¨çš„æ–¹æ³•ï¼Œå¹¶å¯¹æ‰°åŠ¨é¡¹è¿›è¡Œæ±‚å¯¼ï¼Œæœ€åçš„ç»“æœæ›´åŠ ç®€ç»ƒ</span></p>

<p>åœ¨slamåå››è®²ä¸­è¯¦ç»†ä»‹ç»äº†è¿™ä¸¤ç§æ±‚å¯¼çš„æ–¹æ³•ï¼š</p>

<h5 id="ä¸ºä»€ä¹ˆå¯¹äºå¾®å°å˜é‡çš„æ±‚å¯¼ç­‰äºç›´æ¥å¯¹å˜é‡è¿›è¡Œæ±‚å¯¼">ä¸ºä»€ä¹ˆå¯¹äºå¾®å°å˜é‡çš„æ±‚å¯¼ç­‰äºç›´æ¥å¯¹å˜é‡è¿›è¡Œæ±‚å¯¼ï¼Ÿ</h5>

<p>å‡è®¾$f(x)=x^2+2<em>x$ï¼Œç›´æ¥å¯¹xæ±‚å¯¼ï¼š$2</em>x+2$ï¼Œç„¶åå¯¹delta_xæ±‚å¯¼ï¼š$2<em>\delta x+2</em>x*2$ã€‚<span style="color:blue;"><strong>è¿™ä¸€ç‚¹å¾ˆé‡è¦</strong></span>ã€‚</p>

<h4 id="2-å›¾åƒå¤„ç†åŸºç¡€çŸ¥è¯†">2. å›¾åƒå¤„ç†åŸºç¡€çŸ¥è¯†</h4>

<p>ä¸»è¦ä¾§é‡äºå›¾åƒå¤„ç†ã€ç‰¹å¾ç‚¹æå–éƒ¨åˆ†ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200519182014480.png" alt="image-20200519182014480" /></p>

<h4 id="åæ ‡ç³»">åæ ‡ç³»</h4>

<h4 id="3-2d-2d-å¯¹æå‡ ä½•">3. 2D-2D å¯¹æå‡ ä½•</h4>

<p><span style="color:red"> <strong>è¿™é‡Œçš„åŒç›®æ¨¡å‹å¾ˆé‡è¦</strong></span></p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200610084527.png" alt="20200610084527" style="zoom:15%;" /></p>

<p>ä¸‹é¢ä»‹ç»ç«‹ä½“è§†è§‰ä¸­çš„è§†å·®ä¸æ·±åº¦ä¹‹é—´çš„å…³ç³»ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200526110018.png" alt="20200526110018" style="zoom:25%;" /></p>

<blockquote>
  <p>PnP(Perspective-n-Point)æ˜¯æ±‚è§£ 3D åˆ° 2D ç‚¹å¯¹è¿åŠ¨çš„æ–¹æ³•ã€‚å®ƒæè¿°äº†å½“æˆ‘ä»¬çŸ¥é“ n ä¸ª 3D ç©ºé—´ç‚¹ä»¥åŠå®ƒä»¬çš„æŠ•å½±ä½ç½®æ—¶ï¼Œå¦‚ä½•ä¼°è®¡ç›¸æœºæ‰€åœ¨çš„ä½å§¿ã€‚ä¸¤å¼ å›¾åƒä¸­ï¼Œå…¶ä¸­ä¸€å¼ ç‰¹å¾ç‚¹çš„ 3D ä½ç½®å·²çŸ¥ï¼Œé‚£ä¹ˆæœ€å°‘åªéœ€ ä¸‰ä¸ªç‚¹å¯¹(éœ€è¦è‡³å°‘ä¸€ä¸ªé¢å¤–ç‚¹éªŒè¯ç»“æœ)å°±å¯ä»¥ä¼°è®¡ç›¸æœºè¿åŠ¨ã€‚ç‰¹å¾ç‚¹çš„ 3D ä½ç½®å¯ä»¥ ç”±ä¸‰è§’åŒ–ï¼Œæˆ–è€…ç”± RGB-D ç›¸æœºçš„æ·±åº¦å›¾ç¡®å®šã€‚</p>
</blockquote>

<blockquote>
  <p>å› æ­¤ï¼Œåœ¨åŒç›®æˆ– RGB-D çš„è§†è§‰é‡Œç¨‹è®¡ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ PnP ä¼°è®¡ç›¸æœºè¿åŠ¨ã€‚è€Œåœ¨å•ç›®è§†è§‰é‡Œç¨‹è®¡ä¸­ï¼Œå¿…é¡»å…ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶å æ‰èƒ½ä½¿ç”¨ PnPã€‚<strong>3D-2D æ–¹æ³•ä¸éœ€è¦ä½¿ç”¨å¯¹æçº¦æŸï¼Œåˆå¯ä»¥åœ¨å¾ˆå°‘çš„åŒ¹é…ç‚¹ä¸­è·å¾—è¾ƒå¥½çš„è¿ åŠ¨ä¼°è®¡ï¼Œæ˜¯æœ€é‡è¦çš„ä¸€ç§å§¿æ€ä¼°è®¡æ–¹æ³•ã€‚</strong></p>
</blockquote>

<p>é‚£ä¹ˆå¯¹æå‡ ä½•çš„å‡ ç§é—®é¢˜ç±»å‹å¦‚ä¸‹ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200604153051.png" alt="20200604153051" style="zoom:15%;" /></p>

<p><span style="color:blue;"><strong>å…¶ä¸­æ¯”è¾ƒç‰¹åˆ«çš„æ˜¯ï¼š3d-3dã€‚ä¹Ÿå°±æ˜¯ç”¨ICPæ–¹æ³•æ±‚è§£ã€‚ICPçš„ç”¨æ³•æœ‰å¾ˆå¤šæ–¹é¢ï¼Œå¯ä»¥å»åŒ¹é…ä¸¤æ¡è½¨è¿¹ï¼ŒåŒ¹é…ä¸¤ä¸ªå…·æœ‰æ·±åº¦çš„å›¾ç‰‡ï¼Œä»¥ç®—å‡ºâ€œRå’ŒTçŸ©é˜µâ€ã€‚å¦å¤–ï¼Œåœ¨ä¸‰ç»´ç‚¹åŒ¹é…çš„æ—¶å€™ä¹Ÿå¾ˆå¸¸ç”¨</strong></span>ã€‚</p>

<p>ç”¨å›¾ä¾‹æ¥è¡¨ç¤ºå¯¹æå‡ ä½•é—®é¢˜åŒæ ·æ¯”è¾ƒç›´è§‚ï¼Œä¸‹é¢å±•ç¤ºäº†2dåˆ°2dçš„è¿‡ç¨‹ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200526091608.png" alt="20200526091608" style="zoom:25%;" /></p>

<p><span style="color:blue;">åŒç›®æ ‡å®šå¸¸å¸¸ç”¨P2Pçš„æ–¹æ³•å»æ±‚è§£æœ¬è´¨çŸ©é˜µEï¼Œæ¥è·å¾—åŒç›®ä¹‹é—´çš„Rå’ŒTçŸ©é˜µã€‚å…¶ä¸ä¼šä¸å•ç›®ç›¸æœºä¸€æ ·äº§ç”Ÿå°ºåº¦ä¸ç¡®å®šæ€§ï¼Œå› ä¸ºåŒç›®çš„åŸºçº¿æ˜¯å·²çŸ¥é‡ï¼Œå¯ä»¥ä¸ºå…¶æä¾›å°ºåº¦ã€‚å®é™…ä¸Šp2på°±å¯ä»¥è§£å†³ä¸¤å¼ å›¾ç‰‡ï¼ˆéæ·±åº¦å›¾ï¼‰ä¹‹é—´çš„ä½å§¿ä¼°è®¡ï¼Œå› æ­¤å¸¸å¸¸è¢«ç”¨ä½œçº¯å•ç›®çš„slamä¸­ã€‚ä½†æ˜¯å¯¹äºç›¸æœºçš„è¿åŠ¨æœ‰æ‰€é™åˆ¶ï¼Œå½“ç›¸æœºåªè¿›è¡Œæ—‹è½¬æ—¶ï¼Œé‚£ä¹ˆå°†æ— æ³•æ±‚è§£æœ¬è´¨çŸ©é˜µã€‚åŒæ—¶ï¼Œæ±‚è§£æœ¬è´¨çŸ©é˜µæœ‰ä¸¤ç§æ–¹æ³•â€“SVDä¸æœ€å°äºŒä¹˜ä¼˜åŒ–SVDï¼ˆå¥‡å¼‚å€¼åˆ†è§£ï¼‰è¦æ±‚åªæœ‰8ä¸ªåŒ¹é…ç‚¹ï¼Œå¦‚æœçŸ©é˜µçš„ç§©ä¸º8ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æ±‚å‡ºè§£æè§£ã€‚ä½†æ˜¯æœ€å°äºŒä¹˜çš„æ–¹æ³•å¯ä»¥åˆ©ç”¨æ›´å¤šåŒ¹é…ç‚¹ä¿¡æ¯ã€‚é’ˆå¯¹è¯¯åŒ¹é…çš„æƒ…å†µï¼Œå¯ä»¥ç”¨RANSACæ–¹æ³•å‰”é™¤ï¼Œï¼Œè¿™æ˜¯ä¸€ç§å¯ä»¥å–ä»£æœ€å°äºŒä¹˜çš„é€šç”¨æ–¹æ³•ã€‚å› æ­¤PnPå°±æˆä¸ºäº†æœ€é‡è¦çš„æ–¹æ³•ï¼Œä»–å¯ä»¥åˆ©ç”¨ä¸€å¼ å›¾ç‰‡çš„æ·±åº¦ä¿¡æ¯ï¼Œæ´»å¾—æ›´å‡†ç¡®çš„ä½å§¿ä¼°è®¡</span>ã€‚</p>

<p>å¥‡å¼‚å€¼åˆ†è§£ï¼šhttps://www.cnblogs.com/endlesscoding/p/10033527.htmlï¼ˆ<span style="color:red">è¿™ä¸ªåšå®¢å†™çš„ç›¸å½“å¥½</span>ï¼‰</p>

<table>
  <thead>
    <tr>
      <th>æ±‚è§£æœ¬è´¨çŸ©é˜µ<br />çš„ä¼˜åŒ–ç®—æ³•</th>
      <th>æ¦‚è¿°</th>
      <th>ç‰¹ç‚¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SVD</td>
      <td>å¥‡å¼‚å€¼åˆ†è§£</td>
      <td>1. ç‚¹æ•°æœ‰æ‰€é™åˆ¶ï¼Œå¿…é¡»æ˜¯å…«ä¸ªç‚¹<br />2. éœ€è¦æ»¡è¶³ç§©çš„è¦æ±‚ï¼Œä¸ç„¶ä¼šäº§ç”Ÿå¥‡å¼‚ç‚¹</td>
    </tr>
    <tr>
      <td>æœ€å°äºŒä¹˜</td>
      <td>æœ€å¤§ä¼¼ç„¶ä¼°è®¡/æœ€å¤§åéªŒä¼°è®¡</td>
      <td>1. åˆ©ç”¨ç®—æ³•è¿­ä»£ä¼˜åŒ–<br />2. å®é™…ä¸Šæ˜¯æ›²çº¿æ‹Ÿåˆï¼Œä¸èƒ½å‰”é™¤é”™è¯¯ç‚¹</td>
    </tr>
    <tr>
      <td><a href="https://zhuanlan.zhihu.com/p/45532306">RANSAC</a></td>
      <td>åŸºäºRANSACçš„é²æ£’æ–¹æ³•</td>
      <td>1. å¯ä»¥å‰”é™¤é”™è¯¯ç‚¹<br />2. è¢«å¹¿æ³›é‡‡ç”¨</td>
    </tr>
  </tbody>
</table>

<h4 id="4-2d-3dpnpä¸å›¾ä¼˜åŒ–">4. 2D-3Dï¼ˆPnPï¼‰ä¸å›¾ä¼˜åŒ–</h4>

<p>å›¾ä¼˜åŒ–æ¡†æ¶è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200520163055421.png" alt="image-20200520163055421" /></p>

<p>åœ¨å›¾ä¼˜åŒ–ä¸­å‡æœ‰æ ‡å‡†çš„åº“å¯ä»¥ä½¿ç”¨ï¼Œå› æ­¤ï¼Œä¸‹é¢ç»™å‡ºä¹¦ä¸­çš„å®ä¾‹ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;opencv2/core/core.hpp&gt;
#include &lt;opencv2/features2d/features2d.hpp&gt;
#include &lt;opencv2/highgui/highgui.hpp&gt;
#include &lt;opencv2/calib3d/calib3d.hpp&gt;
#include &lt;Eigen/Core&gt;
#include &lt;Eigen/Geometry&gt;
#include &lt;g2o/core/base_vertex.h&gt;
#include &lt;g2o/core/base_unary_edge.h&gt;
#include &lt;g2o/core/block_solver.h&gt;
#include &lt;g2o/core/optimization_algorithm_levenberg.h&gt;
</span><span class="c1">// #include &lt;g2o/solvers/csparse/linear_solver_csparse.h&gt;</span>
<span class="cp">#include &lt;g2o/solvers/eigen/linear_solver_eigen.h&gt;
#include &lt;g2o/types/sba/types_six_dof_expmap.h&gt;
#include &lt;chrono&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">cv</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">find_feature_matches</span> <span class="p">(</span>
    <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">img_1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">img_2</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span> <span class="n">keypoints_1</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span> <span class="n">keypoints_2</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">DMatch</span> <span class="o">&gt;&amp;</span> <span class="n">matches</span> <span class="p">);</span>

<span class="c1">// åƒç´ åæ ‡è½¬ç›¸æœºå½’ä¸€åŒ–åæ ‡</span>
<span class="n">Point2d</span> <span class="nf">pixel2cam</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Point2d</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">K</span> <span class="p">);</span>

<span class="kt">void</span> <span class="nf">bundleAdjustment</span> <span class="p">(</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Point3f</span><span class="o">&gt;</span> <span class="n">points_3d</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Point2f</span><span class="o">&gt;</span> <span class="n">points_2d</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">K</span><span class="p">,</span>
    <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">R</span><span class="p">,</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">t</span>
<span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">!=</span> <span class="mi">5</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"usage: pose_estimation_3d2d img1 img2 depth1 depth2"</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//-- è¯»å–å›¾åƒ</span>
    <span class="n">Mat</span> <span class="n">img_1</span> <span class="o">=</span> <span class="n">imread</span> <span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">CV_LOAD_IMAGE_COLOR</span> <span class="p">);</span>
    <span class="n">Mat</span> <span class="n">img_2</span> <span class="o">=</span> <span class="n">imread</span> <span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">CV_LOAD_IMAGE_COLOR</span> <span class="p">);</span>

    <span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;</span> <span class="n">keypoints_1</span><span class="p">,</span> <span class="n">keypoints_2</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">DMatch</span><span class="o">&gt;</span> <span class="n">matches</span><span class="p">;</span>
    <span class="n">find_feature_matches</span> <span class="p">(</span> <span class="n">img_1</span><span class="p">,</span> <span class="n">img_2</span><span class="p">,</span> <span class="n">keypoints_1</span><span class="p">,</span> <span class="n">keypoints_2</span><span class="p">,</span> <span class="n">matches</span> <span class="p">);</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"ä¸€å…±æ‰¾åˆ°äº†"</span><span class="o">&lt;&lt;</span><span class="n">matches</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span><span class="s">"ç»„åŒ¹é…ç‚¹"</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">// å»ºç«‹3Dç‚¹</span>
    <span class="n">Mat</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">imread</span> <span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">CV_LOAD_IMAGE_UNCHANGED</span> <span class="p">);</span>       <span class="c1">// æ·±åº¦å›¾ä¸º16ä½æ— ç¬¦å·æ•°ï¼Œå•é€šé“å›¾åƒ</span>
    <span class="n">Mat</span> <span class="n">K</span> <span class="o">=</span> <span class="p">(</span> <span class="n">Mat_</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span><span class="mi">3</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mf">520.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">325.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">521.0</span><span class="p">,</span> <span class="mf">249.7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="cm">/*å†…å‚*/</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Point3f</span><span class="o">&gt;</span> <span class="n">pts_3d</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">Point2f</span><span class="o">&gt;</span> <span class="n">pts_2d</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">DMatch</span> <span class="n">m</span><span class="o">:</span><span class="n">matches</span> <span class="p">)</span>
    <span class="p">{</span>       <span class="cm">/*keypoints_1ä¸­æ‰¾åˆ°matchesåˆ°çš„ç‚¹ï¼Œç„¶åå°±å¯¹åº”ä¸Šäº†*/</span>
        <span class="n">ushort</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span> <span class="p">(</span> <span class="n">keypoints_1</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">queryIdx</span><span class="p">].</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span> <span class="p">))</span> <span class="p">[</span> <span class="kt">int</span> <span class="p">(</span> <span class="n">keypoints_1</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">queryIdx</span><span class="p">].</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span> <span class="p">)</span> <span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>   <span class="c1">// bad depth</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">dd</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">;</span>
        <span class="n">Point2d</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">pixel2cam</span> <span class="p">(</span> <span class="n">keypoints_1</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">queryIdx</span><span class="p">].</span><span class="n">pt</span><span class="p">,</span> <span class="n">K</span> <span class="p">);</span>
        <span class="n">pts_3d</span><span class="p">.</span><span class="n">push_back</span> <span class="p">(</span> <span class="n">Point3f</span> <span class="p">(</span> <span class="n">p1</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">p1</span><span class="p">.</span><span class="n">y</span><span class="o">*</span><span class="n">dd</span><span class="p">,</span> <span class="n">dd</span> <span class="p">)</span> <span class="p">);</span>
        <span class="n">pts_2d</span><span class="p">.</span><span class="n">push_back</span> <span class="p">(</span> <span class="n">keypoints_2</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">trainIdx</span><span class="p">].</span><span class="n">pt</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"3d-2d pairs: "</span><span class="o">&lt;&lt;</span><span class="n">pts_3d</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">Mat</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">solvePnP</span> <span class="p">(</span> <span class="n">pts_3d</span><span class="p">,</span> <span class="n">pts_2d</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Mat</span><span class="p">(),</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">false</span> <span class="p">);</span> <span class="c1">// è°ƒç”¨OpenCV çš„ PnP æ±‚è§£ï¼Œå¯é€‰æ‹©EPNPï¼ŒDLSç­‰æ–¹æ³•</span>
    <span class="n">Mat</span> <span class="n">R</span><span class="p">;</span>
    <span class="n">cv</span><span class="o">::</span><span class="n">Rodrigues</span> <span class="p">(</span> <span class="n">r</span><span class="p">,</span> <span class="n">R</span> <span class="p">);</span> <span class="c1">// rä¸ºæ—‹è½¬å‘é‡å½¢å¼ï¼Œç”¨Rodrigueså…¬å¼è½¬æ¢ä¸ºçŸ©é˜µ</span>

    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"R="</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">&lt;&lt;</span><span class="n">R</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"t="</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"calling bundle adjustment"</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">bundleAdjustment</span> <span class="p">(</span> <span class="n">pts_3d</span><span class="p">,</span> <span class="n">pts_2d</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span> <span class="p">);</span><span class="cm">/*åç«¯ï¼Ÿä¼˜åŒ–çš„è¿‡ç¨‹ï¼Ÿ*/</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">find_feature_matches</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">img_1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">img_2</span><span class="p">,</span>
                            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span> <span class="n">keypoints_1</span><span class="p">,</span>
                            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyPoint</span><span class="o">&gt;&amp;</span> <span class="n">keypoints_2</span><span class="p">,</span>
                            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">DMatch</span> <span class="o">&gt;&amp;</span> <span class="n">matches</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//-- åˆå§‹åŒ–</span>
    <span class="n">Mat</span> <span class="n">descriptors_1</span><span class="p">,</span> <span class="n">descriptors_2</span><span class="p">;</span>
    <span class="c1">// used in OpenCV3</span>
    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">FeatureDetector</span><span class="o">&gt;</span> <span class="n">detector</span> <span class="o">=</span> <span class="n">ORB</span><span class="o">::</span><span class="n">create</span><span class="p">();</span>
    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DescriptorExtractor</span><span class="o">&gt;</span> <span class="n">descriptor</span> <span class="o">=</span> <span class="n">ORB</span><span class="o">::</span><span class="n">create</span><span class="p">();</span>
    <span class="c1">// use this if you are in OpenCV2</span>
    <span class="c1">// Ptr&lt;FeatureDetector&gt; detector = FeatureDetector::create ( "ORB" );</span>
    <span class="c1">// Ptr&lt;DescriptorExtractor&gt; descriptor = DescriptorExtractor::create ( "ORB" );</span>
    <span class="n">Ptr</span><span class="o">&lt;</span><span class="n">DescriptorMatcher</span><span class="o">&gt;</span> <span class="n">matcher</span>  <span class="o">=</span> <span class="n">DescriptorMatcher</span><span class="o">::</span><span class="n">create</span> <span class="p">(</span> <span class="s">"BruteForce-Hamming"</span> <span class="p">);</span>
    <span class="c1">//-- ç¬¬ä¸€æ­¥:æ£€æµ‹ Oriented FAST è§’ç‚¹ä½ç½®</span>
    <span class="n">detector</span><span class="o">-&gt;</span><span class="n">detect</span> <span class="p">(</span> <span class="n">img_1</span><span class="p">,</span><span class="n">keypoints_1</span> <span class="p">);</span>
    <span class="n">detector</span><span class="o">-&gt;</span><span class="n">detect</span> <span class="p">(</span> <span class="n">img_2</span><span class="p">,</span><span class="n">keypoints_2</span> <span class="p">);</span>

    <span class="c1">//-- ç¬¬äºŒæ­¥:æ ¹æ®è§’ç‚¹ä½ç½®è®¡ç®— BRIEF æè¿°å­</span>
    <span class="n">descriptor</span><span class="o">-&gt;</span><span class="n">compute</span> <span class="p">(</span> <span class="n">img_1</span><span class="p">,</span> <span class="n">keypoints_1</span><span class="p">,</span> <span class="n">descriptors_1</span> <span class="p">);</span>
    <span class="n">descriptor</span><span class="o">-&gt;</span><span class="n">compute</span> <span class="p">(</span> <span class="n">img_2</span><span class="p">,</span> <span class="n">keypoints_2</span><span class="p">,</span> <span class="n">descriptors_2</span> <span class="p">);</span>

    <span class="c1">//-- ç¬¬ä¸‰æ­¥:å¯¹ä¸¤å¹…å›¾åƒä¸­çš„BRIEFæè¿°å­è¿›è¡ŒåŒ¹é…ï¼Œä½¿ç”¨ Hamming è·ç¦»</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">DMatch</span><span class="o">&gt;</span> <span class="n">match</span><span class="p">;</span>
    <span class="c1">// BFMatcher matcher ( NORM_HAMMING );</span>
    <span class="n">matcher</span><span class="o">-&gt;</span><span class="n">match</span> <span class="p">(</span> <span class="n">descriptors_1</span><span class="p">,</span> <span class="n">descriptors_2</span><span class="p">,</span> <span class="n">match</span> <span class="p">);</span>

    <span class="c1">//-- ç¬¬å››æ­¥:åŒ¹é…ç‚¹å¯¹ç­›é€‰</span>
    <span class="kt">double</span> <span class="n">min_dist</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

    <span class="c1">//æ‰¾å‡ºæ‰€æœ‰åŒ¹é…ä¹‹é—´çš„æœ€å°è·ç¦»å’Œæœ€å¤§è·ç¦», å³æ˜¯æœ€ç›¸ä¼¼çš„å’Œæœ€ä¸ç›¸ä¼¼çš„ä¸¤ç»„ç‚¹ä¹‹é—´çš„è·ç¦»</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">descriptors_1</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">double</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">distance</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">min_dist</span> <span class="p">)</span> <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="n">max_dist</span> <span class="p">)</span> <span class="n">max_dist</span> <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span> <span class="p">(</span> <span class="s">"-- Max dist : %f </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">max_dist</span> <span class="p">);</span>
    <span class="n">printf</span> <span class="p">(</span> <span class="s">"-- Min dist : %f </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">min_dist</span> <span class="p">);</span>

    <span class="c1">//å½“æè¿°å­ä¹‹é—´çš„è·ç¦»å¤§äºä¸¤å€çš„æœ€å°è·ç¦»æ—¶,å³è®¤ä¸ºåŒ¹é…æœ‰è¯¯.ä½†æœ‰æ—¶å€™æœ€å°è·ç¦»ä¼šéå¸¸å°,è®¾ç½®ä¸€ä¸ªç»éªŒå€¼30ä½œä¸ºä¸‹é™.</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">descriptors_1</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">match</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">max</span> <span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">min_dist</span><span class="p">,</span> <span class="mf">30.0</span> <span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
            <span class="n">matches</span><span class="p">.</span><span class="n">push_back</span> <span class="p">(</span> <span class="n">match</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">Point2d</span> <span class="nf">pixel2cam</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Point2d</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">K</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Point2d</span>
           <span class="p">(</span>
               <span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span>
               <span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="p">)</span>
           <span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bundleAdjustment</span> <span class="p">(</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span> <span class="n">Point3f</span> <span class="o">&gt;</span> <span class="n">points_3d</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span> <span class="n">Point2f</span> <span class="o">&gt;</span> <span class="n">points_2d</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">K</span><span class="p">,</span>
    <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">R</span><span class="p">,</span> <span class="n">Mat</span><span class="o">&amp;</span> <span class="n">t</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// åˆå§‹åŒ–g2o</span>
    <span class="k">typedef</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver</span><span class="o">&lt;</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolverTraits</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Block</span><span class="p">;</span>  <span class="c1">// pose ç»´åº¦ä¸º 6, landmark ç»´åº¦ä¸º 3</span>
    <span class="cm">/*æ³¨æ„è¿™é‡Œçš„ç»´åº¦è®¾å®š*/</span>
    <span class="c1">// Block::LinearSolverType* linearSolver = new g2o::LinearSolverCSparse&lt;Block::PoseMatrixType&gt;(); // çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨</span>
    <span class="n">Block</span><span class="o">::</span><span class="n">LinearSolverType</span><span class="o">*</span> <span class="n">linearSolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverEigen</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span> <span class="c1">// çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨</span>
    <span class="n">Block</span><span class="o">*</span> <span class="n">solver_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Block</span> <span class="p">(</span> <span class="n">linearSolver</span> <span class="p">);</span>     <span class="c1">// çŸ©é˜µå—æ±‚è§£å™¨</span>
    <span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span> <span class="n">solver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span> <span class="p">(</span> <span class="n">solver_ptr</span> <span class="p">);</span>
    <span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span> <span class="n">optimizer</span><span class="p">;</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span> <span class="p">(</span> <span class="n">solver</span> <span class="p">);</span><span class="cm">/*åˆå§‹åŒ–å®Œæˆ*/</span>

    <span class="c1">// vertex</span>
    <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">pose</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">();</span> <span class="c1">// camera pose</span>
    <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">R_mat</span><span class="p">;</span>
    <span class="n">R_mat</span> <span class="o">&lt;&lt;</span>
          <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span> <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="p">),</span> <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span> <span class="p">),</span>
               <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span> <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="p">),</span> <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="p">),</span>
               <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span> <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="p">),</span> <span class="n">R</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span><span class="mi">2</span> <span class="p">);</span>
    <span class="n">pose</span><span class="o">-&gt;</span><span class="n">setId</span> <span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="cm">/*step1: å°†ç›¸æœºçš„ä½å§¿è¾“å…¥è¿›å»*/</span>
    <span class="n">pose</span><span class="o">-&gt;</span><span class="n">setEstimate</span> <span class="p">(</span> <span class="n">g2o</span><span class="o">::</span><span class="n">SE3Quat</span> <span class="p">(</span>
                            <span class="n">R_mat</span><span class="p">,</span>
                            <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="p">(</span> <span class="n">t</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span> <span class="n">t</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span> <span class="n">t</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span><span class="mi">0</span> <span class="p">)</span> <span class="p">)</span>
                        <span class="p">)</span> <span class="p">);</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span> <span class="p">(</span> <span class="n">pose</span> <span class="p">);</span>

    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cm">/*points_3d   step2:å°†è·¯æ ‡ç‚¹è¾“å…¥è¿›å»*/</span>
		<span class="c1">//æ³¨æ„è¿™é‡Œæœ‰å¾ˆå¤šæ­Œè·¯æ ‡ç‚¹çš„</span>
    <span class="k">for</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Point3f</span> <span class="n">p</span><span class="o">:</span><span class="n">points_3d</span> <span class="p">)</span>   <span class="c1">// landmarks</span>
    <span class="p">{</span>
        <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">point</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
        <span class="n">point</span><span class="o">-&gt;</span><span class="n">setId</span> <span class="p">(</span> <span class="n">index</span><span class="o">++</span> <span class="p">);</span>
        <span class="n">point</span><span class="o">-&gt;</span><span class="n">setEstimate</span> <span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">z</span> <span class="p">)</span> <span class="p">);</span>
        <span class="n">point</span><span class="o">-&gt;</span><span class="n">setMarginalized</span> <span class="p">(</span> <span class="nb">true</span> <span class="p">);</span> <span class="c1">// g2o ä¸­å¿…é¡»è®¾ç½® marg å‚è§ç¬¬åè®²å†…å®¹ï¼Œï¼ˆä¿¡æ¯çŸ©é˜µï¼‰</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span> <span class="p">(</span> <span class="n">point</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// parameter: camera intrinsics</span>
    <span class="n">g2o</span><span class="o">::</span><span class="n">CameraParameters</span><span class="o">*</span> <span class="n">camera</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">CameraParameters</span> <span class="p">(</span>
        <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">),</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span> <span class="p">(</span> <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">2</span> <span class="p">),</span> <span class="n">K</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="p">)</span> <span class="p">),</span> <span class="mi">0</span>
    <span class="p">);</span>
    <span class="n">camera</span><span class="o">-&gt;</span><span class="n">setId</span> <span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">addParameter</span> <span class="p">(</span> <span class="n">camera</span> <span class="p">);</span>

    <span class="c1">// edges</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Point2f</span> <span class="n">p</span><span class="o">:</span><span class="n">points_2d</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeProjectXYZ2UV</span><span class="o">*</span> <span class="n">edge</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeProjectXYZ2UV</span><span class="p">();</span>
        <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setId</span> <span class="p">(</span> <span class="n">index</span> <span class="p">);</span>
        <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setVertex</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span> <span class="p">(</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span> <span class="p">(</span> <span class="n">index</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
        <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setVertex</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pose</span> <span class="p">);</span>
        <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setMeasurement</span> <span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span> <span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="p">)</span> <span class="p">);</span>
        <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setParameterId</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">);</span>
        <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setInformation</span> <span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span> <span class="p">);</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span> <span class="p">(</span> <span class="n">edge</span> <span class="p">);</span>
        <span class="n">index</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">setVerbose</span> <span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span> <span class="p">(</span> <span class="mi">100</span> <span class="p">);</span>
    <span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">time_used</span> <span class="o">=</span> <span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span> <span class="p">(</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span> <span class="p">);</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"optimization costs time: "</span><span class="o">&lt;&lt;</span><span class="n">time_used</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;&lt;</span><span class="s">" seconds."</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">&lt;&lt;</span><span class="s">"after optimization:"</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"T="</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">&lt;&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Isometry3d</span> <span class="p">(</span> <span class="n">pose</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()</span> <span class="p">).</span><span class="n">matrix</span><span class="p">()</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">//Eigen::Isometry3d ( pose-&gt;estimate() ).matrix() å°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„çŸ©é˜µ</span>
<span class="p">}</span>

</code></pre></div></div>

<p>cmakeæ–‡ä»¶å¦‚ä¸‹ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cmake_minimum_required</span><span class="p">(</span> <span class="n">VERSION</span> <span class="mf">2.8</span> <span class="p">)</span>
<span class="n">project</span><span class="p">(</span> <span class="n">vo1</span> <span class="p">)</span>

<span class="nb">set</span><span class="p">(</span> <span class="n">CMAKE_BUILD_TYPE</span> <span class="s">"Release"</span> <span class="p">)</span>
<span class="nb">set</span><span class="p">(</span> <span class="n">CMAKE_CXX_FLAGS</span> <span class="s">"-std=c++11 -O3"</span> <span class="p">)</span>

<span class="c1"># æ·»åŠ cmakeæ¨¡å—ä»¥ä½¿ç”¨g2o
</span><span class="nb">list</span><span class="p">(</span> <span class="n">APPEND</span> <span class="n">CMAKE_MODULE_PATH</span> <span class="err">$</span><span class="p">{</span><span class="n">PROJECT_SOURCE_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">cmake_modules</span> <span class="p">)</span>

<span class="n">find_package</span><span class="p">(</span> <span class="n">OpenCV</span> <span class="mf">3.1</span> <span class="n">REQUIRED</span> <span class="p">)</span>
<span class="c1"># find_package( OpenCV REQUIRED ) # use this if in OpenCV2 
</span><span class="n">find_package</span><span class="p">(</span> <span class="n">G2O</span> <span class="n">REQUIRED</span> <span class="p">)</span>
<span class="c1">#find_package( CSparse REQUIRED )
</span>
<span class="n">include_directories</span><span class="p">(</span> 
    <span class="err">$</span><span class="p">{</span><span class="n">OpenCV_INCLUDE_DIRS</span><span class="p">}</span> 
    <span class="err">$</span><span class="p">{</span><span class="n">G2O_INCLUDE_DIRS</span><span class="p">}</span>
<span class="c1">#    ${CSPARSE_INCLUDE_DIR}
</span>    <span class="s">"/usr/include/eigen3/"</span>
<span class="p">)</span>

<span class="n">add_executable</span><span class="p">(</span> <span class="n">pose_estimation_3d2d</span> <span class="n">pose_estimation_3d2d</span><span class="p">.</span><span class="n">cpp</span> <span class="p">)</span>
<span class="n">target_link_libraries</span><span class="p">(</span> <span class="n">pose_estimation_3d2d</span> 
   <span class="err">$</span><span class="p">{</span><span class="n">OpenCV_LIBS</span><span class="p">}</span>
   <span class="err">$</span><span class="p">{</span><span class="n">CSPARSE_LIBRARY</span><span class="p">}</span>
   <span class="n">g2o_core</span> <span class="n">g2o_stuff</span> <span class="n">g2o_types_sba</span> <span class="n">g2o_csparse_extension</span>
<span class="p">)</span>
</code></pre></div></div>

<h4 id="5-arucoå›¾ç‰‡å¤„ç†">5. arucoå›¾ç‰‡å¤„ç†</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="p">::</span><span class="n">Point2f</span><span class="o">&gt;&gt;</span> <span class="n">marker_corners</span><span class="p">;</span>
    <span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span> <span class="n">IDs</span><span class="p">;</span>
    <span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="p">::</span><span class="n">Vec3d</span><span class="o">&gt;</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">tvs</span><span class="p">;</span>
    <span class="n">cv</span><span class="p">::</span><span class="n">aruco</span><span class="p">::</span><span class="n">detectMarkers</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dictionary_</span> <span class="p">,</span> <span class="n">marker_corners</span><span class="p">,</span> <span class="n">IDs</span><span class="p">);</span>
    <span class="n">cv</span><span class="p">::</span><span class="n">aruco</span><span class="p">::</span><span class="n">estimatePoseSingleMarkers</span><span class="p">(</span><span class="n">marker_corners</span><span class="p">,</span> <span class="n">marker_length_</span><span class="p">,</span> <span class="n">K_</span><span class="p">,</span> <span class="n">dist_</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="n">tvs</span><span class="p">);</span>
    <span class="n">cv</span><span class="p">::</span><span class="n">Rodrigues</span><span class="p">(</span><span class="n">rvec</span><span class="p">,</span> <span class="n">R</span><span class="p">);</span>
<span class="o">///</span><span class="n">å¾—åˆ°tcm</span>
<span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix4d</span> <span class="n">T_c_m</span><span class="p">;</span>
</code></pre></div></div>

:ET