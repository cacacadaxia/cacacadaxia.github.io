---
layout: post
title: IMUçš„ç§¯åˆ†è¡¨ç¤º
date: 2016-11-20 
tags: markdown    

---

[TOC]

å‚è€ƒç›®å½•ï¼š

[^1]: Quaternion kinematics for the error-state Kalman Filter.pdf
[^2]: ESKF Attitude Algorithm.pdf
[^3]:https://github.com/ydsf16/IMUOrientationEstimator
[^4]:å¾ˆæ£’çš„å¼€æºï¼šhttps://github.com/yuzhou42/ESKF-Attitude-Estimation
[^5]:https://www.cnblogs.com/MerakXuan/p/12148013.html
[^6]: å¼€æºSLAMé¡¹ç›®ï¼šMSEKF
[^7]:IMUæ ‡å®šå·¥å…·ï¼Œåˆ†æè¯¯å·®æ¨¡å‹ï¼šhttps://github.com/ethz-asl/kalibr/wiki/IMU-Noise-Model
[^8]:ä»å¤´æ‰‹å†™VIO ---- é«˜ã€è´º
[^9]: [å››å…ƒæ•°çš„ä¸€äº›æ¯”è¾ƒæœ‰ç”¨çš„æ€§è´¨](https://blog.csdn.net/Night___Raid/article/details/105607245)ï¼ŒåŒ…å«å‰ä¹˜çš„å±æ€§

### åšå®¢æ•´ç†

åœ¨æ–‡çŒ®[^1]çš„åšæ³•ä¸­ï¼Œ

#### æƒ¯æ€§å¯¼èˆªä¸­çš„ä¸€äº›é—®é¢˜

#####  å››å…ƒæ•°çš„è¿ç®—æ€»ç»“

ç¦»æ•£ä¸è¿ç»­ä¹‹é—´çš„å…³ç³»ï¼Œæ¯”è¾ƒè®©äººè¿·æƒ‘ã€‚

<img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200629093038.png" alt="20200629093038" style="zoom:10%;" />

#####  å››å…ƒæ•°çš„è¡¨ç¤ºæ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ

å¯ä»¥è¿™æ ·è¡¨ç¤ºï¼š
$$
\dot{q}_{e}^{b}(t)=\frac{1}{2}\left[\begin{array}{cccc}
0 & -\omega_{x} & -\omega_{y} & -\omega_{z} \\
\omega_{x} & 0 & \omega_{z} & -\omega_{y} \\
\omega_{y} & -\omega_{z} & 0 & \omega_{x} \\
\omega_{z} & \omega_{y} & -\omega_{x} & 0
\end{array}\right] q_{e}^{b}(t)
$$
åœ¨MEKFç®—æ³•çš„å·®åˆ†åŒ–ä¹‹åï¼Œæœ‰è¿™æ ·çš„ç»“æœï¼š
$$
\boldsymbol{q}(t+\Delta t)=\boldsymbol{q}(t) \otimes e^{\frac{1}{2} \boldsymbol{q}_{\omega} \Delta t}
$$
ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºï¼š
$$
\mathbf{q}_{b, b_{k}} \otimes \delta \mathbf{q}_{b_{k} b_{k}^{\prime}}=\delta \mathbf{q}_{b, b_{k}} \otimes\left[\begin{array}{c}
1 \\
\frac{1}{2} \delta \theta_{b_{k} b_{k}}
\end{array}\right]
$$

#####    ç§‘å¼åŠ é€Ÿåº¦çš„è¡¨ç¤º

[å‚è€ƒ](https://fzheng.me/2016/11/20/imu_model_eq/)ï¼›

ç§‘å¼åŠ é€Ÿåº¦ä¸»è¦ç”¨æ¥æè¿°å‚è€ƒç³»ä¸æƒ¯æ€§ç³»ä¹‹é—´çš„å…³ç³»ã€‚

![20200620182700](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200620182700.png)

æˆ‘ä»¬æ¥é€é¡¹åˆ†æä¸Šé¢è¿™ä¸ªå¼å­ã€‚ç¬¬ä¸€é¡¹ä¸­ Î±Î± ä¸º {B} çš„è§’åŠ é€Ÿåº¦ï¼Œæ‰€ä»¥ç¬¬ä¸€é¡¹çš„ç‰©ç†æ„ä¹‰æ˜¯ {B} æ—‹è½¬æ‰€é€ æˆçš„ P çš„åˆ‡å‘åŠ é€Ÿåº¦ã€‚ç¬¬äºŒé¡¹æ˜¯ {B} æ—‹è½¬æ‰€é€ æˆçš„å‘å¿ƒåŠ é€Ÿåº¦ã€‚ç¬¬å››é¡¹ä¸º P ç›¸å¯¹äº {B} çš„åŠ é€Ÿåº¦ï¼Œä½†åœ¨æƒ¯æ€§ç³» {A} ä¸‹è¡¨è¾¾â€”â€”ç±»ä¼¼äº vrvrï¼Œå®šä¹‰ç›¸å¯¹åŠ é€Ÿåº¦ ararã€‚ç¬¬ä¸‰é¡¹æ¯”è¾ƒç‰¹æ®Šï¼Œä¸º {B} çš„æ—‹è½¬è¿åŠ¨ä¸ P ç›¸å¯¹ {B} çš„å¹³ç§»è¿åŠ¨è€¦åˆäº§ç”Ÿçš„åŠ é€Ÿåº¦ï¼Œç§°ä¸ºã€Œç§‘æ°åŠ é€Ÿåº¦ã€ã€‚å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†ç¬¬å››é¡¹å¤–ï¼Œå¦å¤–ä¸‰é¡¹éƒ½å’Œ {B} çš„æ—‹è½¬æœ‰å…³ã€‚

#####   ä»€ä¹ˆæ—¶å€™èƒ½å¤Ÿç”¨åˆ°ç§‘å¼åŠ é€Ÿåº¦å‘¢ï¼Ÿ

åœ¨MSCKF1ä¸­ï¼Œè€ƒè™‘çš„æ˜¯å‚è€ƒç³»ï¼ˆbï¼‰ï¼Œå› æ­¤éœ€è¦è€ƒè™‘ï¼›ä½†åœ¨MSCKF2ä¸­ï¼Œè€ƒè™‘çš„æ˜¯æƒ¯æ€§ç³»ï¼ˆaï¼‰ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦è€ƒè™‘ç§‘å¼åŠ é€Ÿåº¦äº†ã€‚

> è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ—¢ç„¶ä¸è€ƒè™‘ç§‘å¼åŠ é€Ÿåº¦åˆç®€ä¾¿ä¹Ÿç¬¦åˆé€»è¾‘ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸€äº›æ–‡çŒ®ä¸­é‡‡ç”¨è€ƒè™‘ç§‘å¼åŠ é€Ÿåº¦çš„åšæ³•å‘¢ï¼Ÿ

#####   åœ¨IMUä¸­å¦‚ä½•ç¡®å®šåæ–¹å·®çŸ©é˜µï¼Ÿæœ‰æ²¡æœ‰ä¸€ä¸ªç®€å•çš„ç†è§£ï¼Ÿæˆ–è€…é€šç”¨çš„è§£é‡Šï¼Ÿ

è¿™ä¸ªåˆ†æè¿‡ç¨‹éœ€è¦éšæœºè¿‡ç¨‹çš„çŸ¥è¯†ï¼Œä¸»è¦å‚è€ƒ[åšå®¢](https://fzheng.me/2016/11/20/imu_model_eq/)ä¸[åšå®¢](https://zhuanlan.zhihu.com/p/71202672)çš„å†…å®¹ã€‚

<img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200620191047.png" alt="20200620191047" style="zoom:20%;" />



> è¿™é‡Œå·²ç»ç»™å‡ºäº†æ¯”è¾ƒåˆç†çš„è§£é‡Šï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªå…³ç³»å»ç¡®å®šQçŸ©é˜µä¸RçŸ©é˜µã€‚ä¸Šé¢çš„noiseæ˜¯ç™½å™ªå£°ï¼Œbiasä»£è¡¨éšæœºæ¸¸èµ°åå·®ï¼Œä¸ºç™½å™ªå£°çš„ç§¯åˆ†ã€‚
>
> è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼š**è¿™ä¸ªéƒ¨åˆ†åˆ°åº•æ˜¯ä¸æ˜¯ä¸ºäº†ç¡®å®šQçš„å¤§å°ï¼Ÿ**å…¶å®æˆ‘è§‰å¾—è¿™é‡Œçš„æè¿°æœªå¿…å‡†ç¡®ã€‚
>
> <span style="color:blue;">**è¿™é‡Œç»™å‡ºäº†è¿ç»­ä¸ç¦»æ•£ä¹‹é—´çš„å…³ç³»ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æœ‰ä¸€å±‚å…³ç³»ï¼šç§¯åˆ†ä¸æœªç§¯åˆ†çš„å…³ç³»**</span>ã€‚	

- åœ¨ä¹‹å‰çš„è®ºæ–‡é‡Œæ˜¯è¿™ä¹ˆåšçš„

$$
Q_{d}=Q_{c} \Delta t \quad Q_{c}=\text 
{blkdiag}\left(\sigma_{a c c}^{2}\right)
$$

> æˆ‘è§‰å¾—è¿™ä¸ªå’ŒåŠ é€Ÿåº¦è®¡çš„å›ºæœ‰æ€§è´¨ç›¸å…³ã€‚

- [åšå®¢](https://zhuanlan.zhihu.com/p/71202672)çš„å†…å®¹	

è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š<span style="color:red;">ä½†æ˜¯è¿™é‡Œæ˜¯ç™½å™ªå£°è¿˜æ˜¯éšæœºæ¸¸èµ°ï¼Ÿ</span>ç†è®ºä¸Šåº”è¯¥æ˜¯ç™½å™ªå£°ï¼Œå› ä¸ºæ²¡æœ‰è®¨è®ºéšæœºæ¸¸èµ°ã€‚
$$
\frac{Q_{c}}{\Delta t} *{\Delta t}^{2}=\frac{b l k d i a g\left(\sigma_{g y r o}^{2}\right)}{\Delta t} *{\Delta t^{2}}
$$

- åœ¨[åšå®¢](https://zhuanlan.zhihu.com/p/88756311)ä¸­ï¼Œæåˆ°ä¸€ç§ESKFçš„å§¿æ€è§’åº¦ä¼°è®¡æ–¹æ³•ï¼Œå¯¹äºQçš„æ±‚è§£ï¼Œç»™å‡ºä¸‹é¢çš„ç»“æœï¼š

$$
\begin{array}{l}
\boldsymbol{V}_{i}=\sigma_{a_{n}}^{2} \Delta t^{2} \boldsymbol{I} \\
\mathbf{\Theta}_{i}=\sigma_{\omega_{n}}^{2} \Delta t^{2} \boldsymbol{I} \\
\boldsymbol{A}_{i}=\sigma_{a_{\omega}}^{2} \Delta t \boldsymbol{I} \\
\boldsymbol{\Omega}_{i}=\sigma_{\omega_{\omega}}^{2} \Delta t \boldsymbol{I}
\end{array}
$$

> ä½†æ˜¯è¿™é‡Œé¢çš„åŠ é€Ÿåº¦è®¡äºé™€èºçš„è¡¨ç¤ºéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ€ä¹ˆè§£é‡Šï¼Ÿ
>
> è¿™é‡Œæåˆ°äº†ä¸€ä¸ªç§¯åˆ†çš„è¿‡ç¨‹ã€‚

æ˜¾ç„¶ä¸ä¸Šé¢çš„çŸ›ç›¾ï¼Œè¿™æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ

#####   å¦‚ä½•ç¡®å®šåæ–¹å·®çŸ©é˜µçš„æ›´æ–°ï¼Ÿ

è¦æ¨å¯¼é¢„ç§¯åˆ†é‡çš„åæ–¹å·®ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ imu å™ªå£°å’Œé¢„ç§¯åˆ†é‡ ä¹‹é—´çš„çº¿æ€§é€’æ¨å…³ç³»ã€‚åæ–¹å·®çŸ©é˜µå¯ä»¥è¿™æ ·æ¨å¯¼ï¼š<span style="color:blue;">**è¿™ä¸ªæ–¹å·®çš„ç§¯ç´¯å…¬å¼éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå®é™…ä¸ŠçŠ¶æ€ä¼°è®¡å¤§å¤šéƒ½æ˜¯è¿™ä¹ˆåšçš„ã€‚**</span>
$$
\boldsymbol{\Sigma}_{i k}=\mathbf{F}_{k-1} \boldsymbol{\Sigma}_{i k-1} \mathbf{F}_{k-1}^{\top}+\mathbf{G}_{k-1} \boldsymbol{\Sigma}_{\mathbf{n}} \mathbf{G}_{k-1}^{\top}
$$
å…¶ä¸­ï¼Œ$Î£_n$ æ˜¯æµ‹é‡å™ªå£°çš„åæ–¹å·®çŸ©é˜µï¼Œæ–¹å·®ä» i æ—¶åˆ»å¼€å§‹è¿›è¡Œé€’æ¨ï¼Œ$Î£_{ii} = 0$ã€‚

ä½†æ˜¯åœ¨ä¼ ç»Ÿçš„å¡å°”æ›¼æ»¤æ³¢å™¨çš„é€’æ¨å…¬å¼ä¸­ï¼Œæœ‰ä¸‹é¢çš„ç»“æœï¼š

<img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200621091350.png" alt="20200621091350" style="zoom:50%;" />

åœ¨è¿™é‡Œæ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ§åˆ¶é‡uçš„é›…å¯æ¯”çŸ©é˜µï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<span style="color:blue;">**å› ä¸ºuçš„é›…å¯æ¯”çŸ©é˜µåªå½±å“åˆ°PçŸ©é˜µçš„æ›´æ–°ï¼Œè€Œå¹¶ä¸å½±å“æ ‡ç§°å€¼çš„æ›´æ–°ã€‚ï¼ˆæ ‡ç§°å€¼çš„æ›´æ–°ä¾èµ–äºæ›´åŠ å‡†ç¡®çš„éçº¿æ€§çŠ¶æ€æ›´æ–°æ–¹ç¨‹ï¼‰**</span>ã€‚

è¿™é‡ŒQä»£è¡¨çš„è¿‡ç¨‹è¯¯å·®æ–¹å·®çŸ©é˜µï¼Œå¯¹åº”çš„ç»´åº¦æ˜¯çŠ¶æ€é‡ã€‚åˆ©ç”¨æ§åˆ¶é‡ä¸è¿åŠ¨å­¦æ–¹ç¨‹ï¼Œç¡®å®å¯ä»¥æ±‚å‡ºæ¥çŠ¶æ€é‡çš„è¯¯å·®æ–¹å·®çŸ©é˜µã€‚ç›¸å½“äºçŠ¶æ€é‡çš„æ–¹å·®æœ‰ä¸€éƒ¨åˆ†æ˜¯ç”±æ§åˆ¶é‡å†³å®šçš„ã€‚ä½†æ˜¯å¦‚æœç³»ç»Ÿä¸­æ²¡æœ‰æ§åˆ¶é‡ï¼Œåªæœ‰çŠ¶æ€é‡ï¼Œé‚£ä¹ˆå°±éœ€è¦ç›´æ¥ç»™å‡ºQçŸ©é˜µçš„å€¼ã€‚å®é™…ä¸Šè¿™ç§ç³»ç»Ÿä¹Ÿæ˜¯æ¯”è¾ƒå¤šçš„ã€‚

åœ¨ä¸€ä¸ªå¼€æºé¡¹ç›®ä¸­æ˜¯è¿™æ ·ç¡®å®šQçš„å¤§å°çš„ï¼š

 ```python
sGPS     = 0.5*8.8*dt**2  # assume 8.8m/s2 as maximum acceleration, forcing the vehicle
sCourse  = 0.1*dt # assume 0.1rad/s as maximum turn rate for the vehicle
sVelocity= 8.8*dt # assume 8.8m/s2 as maximum acceleration, forcing the vehicle
sYaw     = 1.0*dt # assume 1.0rad/s2 as the maximum turn rate acceleration for the vehicle

Q = np.diag([sGPS**2, sGPS**2, sCourse**2, sVelocity**2, sYaw**2])
 ```

> å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„Qæ˜¯ç”¨æ¥æè¿°è¿ç»­å¾®åˆ†è¿åŠ¨å­¦æ–¹ç¨‹ä¸­çš„å¾®åˆ†é‡çš„ã€‚å› ä¸ºè¿™é‡Œçš„Qåªæ˜¯åœ¨å®šä¹‰è¯¯å·®é‡çš„è¿‡ç¨‹å™ªå£°ï¼Œæ‰€ä»¥æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚
>

æœ€ç»ˆåœ¨MEKF[çš„åšå®¢ä¸­æ‰¾åˆ°ç­”æ¡ˆ](https://zhuanlan.zhihu.com/p/71202815)ï¼š

åœ¨æ–‡çŒ®1ä¸­æ‰¾åˆ°ä¸‹é¢çš„ä½è¯ï¼ˆé™„å½•éƒ¨åˆ†ï¼‰ã€‚ä¸‹é¢çš„å·®åˆ†åŒ–æ˜¯åˆ©ç”¨äº†ç¬¬äºŒç§çŠ¶æ€æ–¹ç¨‹çš„é€’æ¨æ–¹æ³•ï¼Œç„¶åè¿›è¡Œç¦»æ•£åŒ–ã€‚

<img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623100552.png" alt="20200623100552" style="zoom:25%;" />

ç”±æ­¤ä¾¿å¾—çŸ¥åæ–¹å·®QçŸ©é˜µçš„ç¡®å®šè¿‡ç¨‹ã€‚å®é™…ä¸Š<span style="color:green;">**åœ¨å®éªŒä¸­ï¼Œå¹¶æ²¡æœ‰ç‰¹åˆ«ä¸¥æ ¼çš„å®šä¹‰ï¼Œå®é™…ä¸Šä¸¤ç§éƒ½å¯ä»¥**</span>ã€‚å¯¹æ¯”è¯•éªŒç»“æœå‘ç°å…¶å½±å“æ¯”è¾ƒå°ã€‚

#####   å¦‚ä½•å°†è§’åº¦ç§¯åˆ†å·®åˆ†åŒ–è¡¨ç¤ºï¼Ÿ

åœ¨VIOä¸­ï¼Œå¯¹äºIMUçš„å¤„ç†æµç¨‹æ˜¯ï¼šé¢„ç§¯åˆ†--é¢„ç§¯åˆ†çš„ç¦»æ•£å½¢å¼--æ¨å¯¼é¢„ç§¯åˆ†çš„æ–¹å·®ã€‚

| ç±»åˆ« | æ–¹æ³•                                                         |
| ---- | ------------------------------------------------------------ |
| åšä¸» | å·®åˆ†åŒ–-->ç¦»æ•£åŒ–                                              |
| VIO  | ç¦»æ•£åŒ–-->å·®åˆ†åŒ–                                              |
|      | <span style="color:blue;">**å®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼šç¦»æ•£åŒ–ï¼Œå·®åˆ†åŒ–ã€‚è™½ç„¶éƒ½ä¸æ˜¯<br />ä»€ä¹ˆå¤æ‚çš„æ•°å­¦ç†è®ºï¼Œä½†æ˜¯å¸¸å¸¸è®©äººæ„Ÿåˆ°confused**</span> |

![image-20200619081139836](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619081139836.png)

> å®é™…ä¸ŠIMUç»„ä»¶ç»™ç³»ç»Ÿç³»ç»Ÿçš„è¿åŠ¨å­¦æ–¹ç¨‹ï¼Œåœ¨çŠ¶æ€ä¼°è®¡ä¸­å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§çº¦æŸã€‚åŒæ—¶æµ‹é‡æ–¹ç¨‹ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯å¦å¤–ä¸€ç§çº¦æŸã€‚
>
> åœ¨ä¼˜åŒ–ç³»ç»Ÿä¸­ï¼Œå°†è¿™ä¸¤ç§çº¦æŸéƒ½å†™å…¥åˆ°ä¼˜åŒ–å‡½æ•°ä¸­ï¼Œå¹¶ä¸”ä¿è¯æƒ©ç½šå‡½æ•°æ˜¯çº¿æ€§çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨æ¢¯åº¦ä¸‹é™æ³•ç®€å•æ±‚è§£äº†ã€‚

| ç±»åˆ«                                | æ–¹æ³•                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| åŸºäºä¸€é˜¶æ³°å‹’å±•å¼€è¯¯å·®é€’æ¨æ–¹ç¨‹ï¼šæ–¹æ³•1 | ç¦»æ•£åŒ–-->å·®åˆ†åŒ–                                              |
| åŸºäºè¯¯å·®éšæ—¶é—´å˜åŒ–çš„é€’æ¨æ–¹ç¨‹ï¼šæ–¹æ³•2 | å·®åˆ†åŒ–-->ç¦»æ•£åŒ–                                              |
| å¤‡æ³¨                                | <span style="color:blue;">**å®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼šç¦»æ•£åŒ–ï¼Œå·®åˆ†åŒ–ã€‚è™½ç„¶éƒ½ä¸æ˜¯<br />ä»€ä¹ˆå¤æ‚çš„æ•°å­¦ç†è®ºï¼Œä½†æ˜¯å¸¸å¸¸è®©äººæ„Ÿåˆ°confused<br />å¦å¤–ï¼Œå·®åˆ†åŒ–å°±æ˜¯å°†å…¶å†™æˆè¯¯å·®çŠ¶æ€çš„å½¢å¼**</span> |

ä½†æ˜¯å› ä¸ºæ–¹æ³•2ä¸­éœ€è¦çŸ¥é“çŠ¶æ€é‡çš„è¿ç»­å¯¼æ•°å…³ç³»ï¼ˆéšæ—¶é—´å˜åŒ–çš„å…³ç³»ï¼‰ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½æ²¡åŠæ³•æ±‚è§£è¿™éƒ¨åˆ†ï¼ˆåœ¨PVQç³»ç»Ÿä¸­å¯ä»¥åšï¼‰ã€‚æ–¹æ³•1ä¸­çš„ç¦»æ•£å½¢å¼æ¯”è¾ƒç¬¦åˆå¯¹EKFçš„è§£é‡Šå’ŒEKFä¸­åæ–¹å·®æ›´æ–°çš„æ–¹æ³•ï¼Œå› æ­¤æ›´åŠ å¸¸ç”¨ã€‚

<span style="color:blue;">**æ€»ç»“æ¥è¯´ï¼Œå¦‚æœç³»ç»Ÿæ˜¯è¿ç»­æ–¹ç¨‹ï¼Œé‚£ä¹ˆéœ€è¦å…ˆè¿›è¡Œerror stateåŒ–ä¹‹åå†è¿›è¡Œç¦»æ•£åŒ–ã€‚å¦‚æœç³»ç»Ÿæ˜¯ç¦»æ•£æ–¹ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è¿›è¡Œerror stateåŒ–å³å¯**</span>ã€‚

ä¸‹é¢æ˜¯è¯¦ç»†å®šä¹‰ï¼š

![image-20200619092634104](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619092634104.png)

<span style="color:blue;">**äºæ˜¯æœ‰ä¸‹é¢çš„ç»“æœï¼Œè¿™é‡Œçš„å˜åŒ–å¾ˆé‡è¦**</span>ï¼š

![20200619092641](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200619092641.png)

![image-20200619092726511](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619092726511.png)

#####  ä½†æ˜¯æœ€åä¸€æ­¥æ˜¯æ€ä¹ˆæ¨å¯¼çš„ï¼Ÿ

åœ¨ä¸Šé¢çš„ä¸¤ç§æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€ç§æ˜¯ç¬¦åˆEKFçš„çŠ¶æ€æ–¹ç¨‹çš„é€’æ¨å…³ç³»çš„ï¼›ç¬¬äºŒç§æ˜¯ç›®å‰VIOç®—æ³•ä¸­çš„ä¸»æµåšæ³•ã€‚åº”è¯¥æ˜¯æ®Šé€”åŒå½’çš„ä¸¤ç§åšæ³•ï¼Œä½†æ˜¯ç¬¬ä¸€ç§æ›´ä¸ºé€šç”¨ã€‚

<span style="color:red;">ä¸‹é¢çš„æ¨å¯¼æ˜¯æ€ä¹ˆå®Œæˆçš„</span>ï¼Ÿ
$$
\begin{array}{l}
\dot{\delta \mathbf{v}}=\mathbf{R} \delta \mathbf{a}^{b}+\mathbf{R}[\delta \boldsymbol{\theta}]_{\times}\left(\mathbf{a}^{b}+\delta \mathbf{a}^{b}\right)+\delta \mathbf{g} \\
\dot{\delta \mathbf{v}}=\mathbf{R} \delta \mathbf{a}^{\mathbf{b}}-\mathbf{R}\left[\mathbf{a}^{b}\right]_{\times} \delta \boldsymbol{\theta}+\delta \mathbf{g}
\end{array}
$$

æœ€ç¬¦åˆé€»è¾‘çš„å°±æ˜¯ï¼š<span style="color:red;">**ä¸¤ä¸ªå°é‡ç›¸ä¹˜ï¼Œæœ€åçš„ç»“æœå°±æ˜¯æ— ç©·å°ï¼Œå¯ä»¥å¿½ç•¥**</span>ã€‚

ä¸ESKFçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸‹é¢ç»™å‡ºESKFçš„å®šä¹‰ã€‚
$$
\dot{\delta \mathbf{v}}=-\mathbf{R}\left[\mathbf{a}_{m}-\mathbf{a}_{b}\right]_{\times} \delta \boldsymbol{\theta}-\mathbf{R} \delta \mathbf{a}_{b}+\delta \mathbf{g}-\mathbf{R} \mathbf{a}_{n}
$$
ä½†æ˜¯å¦‚ä½•æ¯”è¾ƒä¸¤è€…çš„åŒºåˆ«ï¼Ÿæœ‰å¾…åç»­å®Œæˆã€‚

#####  ä¸ºä»€ä¹ˆè¦ç”¨è¯¯å·®çŠ¶æ€é‡å»è¡¨ç¤ºå‘¢ï¼Ÿ

è¿™éƒ¨åˆ†å‚è€ƒQuaternion kinematics for the error-state Kalman filte[å’Œåšå®¢](https://zhuanlan.zhihu.com/p/88756311)ã€‚

- å®šå‘è¯¯å·®çŠ¶æ€æ˜¯æœ€å°çš„ï¼Œé¿å…äº†ä¸è¿‡åº¦å‚æ•°åŒ–ç›¸å…³çš„é—®é¢˜ï¼Œä»¥åŠç›¸å…³åæ–¹å·®çŸ©é˜µå¥‡å¼‚æ€§çš„é£é™©ï¼Œè¿™é€šå¸¸æ˜¯ç”±å¼ºåˆ¶çº¦æŸå¼•èµ·çš„
- è¯¯å·®çŠ¶æ€ç³»ç»Ÿæ€»æ˜¯åœ¨æ¥è¿‘åŸå§‹ç³»ç»Ÿçš„æƒ…å†µä¸‹è¿è¡Œï¼Œå› æ­¤è¿œç¦»å¯èƒ½çš„å‚æ•°å¥‡ç‚¹ã€ä¸‡å‘é”é—®é¢˜ç­‰ï¼Œä»è€Œä¿è¯çº¿æ€§åŒ–çš„æœ‰æ•ˆæ€§å§‹ç»ˆä¿æŒä¸å˜
- é”™è¯¯çŠ¶æ€æ€»æ˜¯å¾ˆå°ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰äºŒé˜¶éƒ¨åˆ†éƒ½å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è¿™ä½¿å¾—é›…å¯æ¯”çŸ©é˜µçš„è®¡ç®—å˜å¾—éå¸¸ç®€å•å’Œå¿«é€Ÿã€‚æœ‰äº›é›…å¯æ¯”æ•°ç”šè‡³å¯èƒ½æ˜¯å¸¸æ•°æˆ–ç­‰äºå¯ç”¨çŠ¶æ€é‡ã€‚
- è¯¯å·®åŠ¨åŠ›å­¦æ˜¯ç¼“æ…¢çš„ï¼Œå› ä¸ºæ‰€æœ‰çš„å¤§ä¿¡å·åŠ¨åŠ›å­¦éƒ½å·²é›†æˆåˆ°æ ‡ç§°çŠ¶æ€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä»¥ä½äºé¢„æµ‹çš„é€Ÿåº¦åº”ç”¨KFä¿®æ­£

> ä»€ä¹ˆæ˜¯åŠ¨åŠ›å­¦æ˜¯ç¼“æ…¢çš„ï¼Ÿå˜åŒ–æ˜¯ç¼“æ…¢çš„ï¼Ÿ

> <span style="color:green;">**æ˜¯ä¸æ˜¯ç”¨æ¥æè¿°æŒ¯åŠ¨å˜åŒ–ï¼Œæœ‰ç€æ›´ä¸ºå‡ºè‰²çš„æ€§èƒ½**</span>ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¯ä»¥å‘è®ºæ–‡çš„ç‚¹ã€‚
>
> æ˜¯ä¸æ˜¯å’Œæä»£æ•°å»è¡¨ç¤ºæ˜¯æœ‰å…³ç³»çš„ï¼Œåªæœ‰åœ¨å°é‡çš„æ—¶å€™ï¼Œåœ¨åˆ‡ç©ºé—´çš„æ€§è´¨æ‰å¯ä»¥æˆç«‹ã€‚

#####  æ˜¯å¦‚ä½•å°†è¯¯å·®çŠ¶æ€ä¸æ§åˆ¶é‡ç›¸ç»“åˆçš„ï¼Ÿ

è§’é€Ÿåº¦ç§¯åˆ†è¡¨ç¤ºï¼š
$$
\begin{aligned}
_{I}^{G} \dot{\boldsymbol{R}} &=_{I}^{G} \boldsymbol{R}\left[\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}-\boldsymbol{n}_{w}\right] \times \\
\dot{\boldsymbol{b}}_{g} &=\mathbf{0}+\boldsymbol{n}_{g}
\end{aligned}
$$
ä¸‹é¢æ˜¯æ—‹è½¬çŸ©é˜µçš„ç§¯åˆ†è¿‡ç¨‹ï¼š
$$
\frac{\mathrm{d} \mathbf{R}}{\mathrm{d} t}=\mathbf{R}[\boldsymbol{\omega}]_{\times}
$$
å¾—åˆ°ç¦»æ•£åŒ–ä¹‹åçš„ï¼š
$$
\mathbf{R}(t+\Delta t)=\mathbf{R}(t) e^{[\omega]_{\times} \Delta t}
$$

å‚è€ƒEKF-Based IMU Orientation Estimationï¼Œæœ‰ä¸‹é¢çš„è¿åŠ¨å­¦æ–¹ç¨‹ï¼š
$$
\begin{aligned}
\delta \boldsymbol{\theta} &=\operatorname{Exp}\left[\left(\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}\right) \Delta t\right]^{T} \delta \boldsymbol{\theta}-\delta \boldsymbol{b}_{g} \Delta t+\boldsymbol{\theta}_{i} \\
\delta \boldsymbol{b}_{g} &=\delta \boldsymbol{b}_{g}+\boldsymbol{\omega}_{i}
\end{aligned}
$$
è¡¨ç¤ºä¸ºï¼š
$$
\left[\begin{array}{c}
\delta \boldsymbol{\theta} \\
\delta \boldsymbol{b}_{g}
\end{array}\right]=\underbrace{\left[\begin{array}{cc}
\operatorname{Exp}\left[\left(\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}\right) \Delta t\right]^{T} & -\boldsymbol{I} \Delta t \\
\boldsymbol{0} & \boldsymbol{I}
\end{array}\right]}_{\boldsymbol{F}_{\boldsymbol{x}}}\left[\begin{array}{c}
\boldsymbol{\delta} \boldsymbol{\theta} \\
\delta \boldsymbol{b}_{g}
\end{array}\right]+\underbrace{\left[\begin{array}{cc}
\boldsymbol{I} & \boldsymbol{0} \\
\boldsymbol{0} & \boldsymbol{I}
\end{array}\right]}_{\boldsymbol{F}_{i}}\left[\begin{array}{c}
\boldsymbol{\theta}_{i} \\
\boldsymbol{\omega}_{i}
\end{array}\right]
$$

è¿™é‡Œå…¶å®å°±è¯´æ˜äº†ï¼šsitaä¸delta_sitaçš„æ–¹å·®çš„å¯¹åº”å…³ç³»ã€‚

#####  å››å…ƒæ•°çš„è¿ç®—æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

å››å…ƒæ•°ç›¸ä¹˜å¯ä»¥å†™æˆï¼š
$$
\mathbf{q}_{1} \otimes \mathbf{q}_{2}=[\mathbf{q}]_{L} \mathbf{q}_{2}=[\mathbf{q}]_{R} \mathbf{q}
$$
å…¶ä¸­
$$
[\mathbf{q}]_{L}=\left[\begin{array}{cccc}
q_{w} & -q_{x} & -q_{y} & -q_{z} \\
q_{x} & q_{w} & -q_{z} & q_{y} \\
q_{y} & q_{z} & q_{w} & -q_{x} \\
q_{z} & -q_{y} & q_{x} & q_{w}
\end{array}\right]=q_{w} \mathbf{I}+\left[\begin{array}{cc}
0 & -\mathbf{q}_{v}^{\mathrm{T}} \\
\mathbf{q}_{v} & {\left[\mathbf{q}_{v}\right]_{\times}}
\end{array}\right]
$$

#####  æœ€åä¸€ç‚¹ï¼šå››å…ƒæ•°ä¸æä»£æ•°ä¹‹é—´çš„å…³ç³»ï¼Ÿ

1. é¦–å…ˆæ˜¯æä»£æ•°çš„éƒ¨åˆ†ï¼š

![image-20200622104950178](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622104950178.png)

2. å…¶æ¬¡æ˜¯ç½—å¾·é‡Œæ ¼æ–¯æ—‹è½¬å…¬å¼ï¼š

$$
\mathbf{R}=\mathbf{I}+\sin \phi[\mathbf{u}]_{\times}+(1-\cos \phi)[\mathbf{u}]_{\times}^{2}
$$

3. æè¿°æ—‹è½¬ç¾¤ä¸å››å…ƒæ•°ä¹‹é—´çš„å…³ç³»ï¼šå‚è€ƒæ–‡çŒ®[^1]çš„ 4.2.2

#### ESKFæ€»ç»“é™ˆè¿°

ESKFå°±æ˜¯ç”¨äº†ä¸Šè¿°â€œåŸºäºè¯¯å·®éšæ—¶é—´å˜åŒ–â€æ±‚è§£æ–¹æ³•ï¼Œé¦–å…ˆå†™æˆerror stateï¼Œç„¶åè¿›è¡Œç¦»æ•£åŒ–å¾—åˆ°IMUçš„é€’æ¨æ–¹ç¨‹ã€‚/

å‚æ•°è¡¨å¦‚ä¸‹ï¼š

![20200622112302](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200622112302.png)

| English       | ä¸­æ–‡     |
| ------------- | -------- |
| nominal state | æ ‡ç§°çŠ¶æ€ |
| true state    | çœŸå®çŠ¶æ€ |
| error state   | è¯¯å·®çŠ¶æ€ |

#####  é¦–å…ˆæ˜¯è¿åŠ¨å­¦æ–¹ç¨‹ä¸­ï¼š

ç»™å‡ºä¸‹é¢ï¼š

![image-20200622084611877](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622084611877.png)

å…¶ä¸­ ğœƒğ‘– ğ‘¤ğ‘– ä¸ºé«˜æ–¯éšæœºè„‰å†²å™ªå£°ï¼Œå‡å€¼ä¸º0ï¼Œåæ–¹å·®ä¸º ğ‘¤ğ‘› ï¼Œğ‘¤ğ‘ğ‘› åœ¨ ğ›¥ğ‘¡æ—¶é—´å†…çš„ç§¯åˆ†å€¼ã€‚

å› æ­¤ç»™å‡ºè¯¯å·®ä¼ æ’­æ–¹ç¨‹ï¼š
$$
\begin{aligned}
\delta \mathbf{p} & \leftarrow \delta \mathbf{p}+\delta \mathbf{v} \Delta t \\
\delta \mathbf{v} & \leftarrow \delta \mathbf{v}+\left(-\mathbf{R}\left[\mathbf{a}_{m}-\mathbf{a}_{b}\right]_{\times} \delta \boldsymbol{\theta}-\mathbf{R} \delta \mathbf{a}_{b}+\delta \mathbf{g}\right) \Delta t+\mathbf{v}_{\mathbf{i}} \\
\delta \boldsymbol{\theta} & \leftarrow \mathbf{R}^{\top}\left\{\left(\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{b}\right) \Delta t\right\} \delta \boldsymbol{\theta}-\delta \boldsymbol{\omega}_{b} \Delta t+\boldsymbol{\theta}_{\mathbf{i}} \\
\delta \mathbf{a}_{b} & \leftarrow \delta \mathbf{a}_{b}+\mathbf{a}_{\mathbf{i}} \\
\delta \boldsymbol{\omega}_{b} & \leftarrow \delta \boldsymbol{\omega}_{b}+\boldsymbol{\omega}_{\mathbf{i}} \\
\delta \mathbf{g} & \leftarrow \delta \mathbf{g}
\end{aligned}
$$

#####  å…¶æ¬¡æ˜¯æµ‹é‡æ–¹ç¨‹ï¼š

æµ‹é‡æ–¹ç¨‹æ±‚å–é›…å¯æ¯”çŸ©é˜µé‡‡ç”¨é“¾å¼æ³•åˆ™ã€‚

æ­¤å¤–æœ‰ï¼š

![image-20200622084626045](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622084626045.png)
$$
\left.\mathbf{X}_{\delta \mathbf{x}} \triangleq \frac{\partial \mathbf{x}_{t}}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\left[\begin{array}{ccc}
\mathbf{I}_{6} & 0 & 0 \\
0 & \mathbf{Q}_{\delta \boldsymbol{\theta}} & 0 \\
0 & 0 & \mathbf{I}_{9}
\end{array}\right]
$$
æ€»ç»“æ¥è¯´ï¼Œæ±‚å–å·®åˆ†çš„åå¯¼æ•°å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ç”¨åˆ°çš„æ˜¯å·¦æ çš„ç»“æœï¼Œå³æ ä¸­æœªä½œè€ƒè™‘ã€‚

![20200623093941](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623093941.png)

#####  å…¶ä¸­æœ‰æ¯”è¾ƒé‡è¦çš„æ¨å¯¼æ–¹æ³•

ä¸‹é¢æ˜¯ä¸¤ç§é“¾å¼æ±‚å¯¼çš„æ–¹æ³•ï¼Œæ¯”è¾ƒé‡è¦ã€‚
$$
\left.\mathbf{H} \triangleq \frac{\partial h}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\left.\left.\frac{\partial h}{\partial \mathbf{x}_{t}}\right|_{\mathbf{x}} \frac{\partial \mathbf{x}_{t}}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\mathbf{H}_{\mathbf{x}} \mathbf{X}_{\delta \mathbf{x}}
$$

$$
\left.\mathbf{Q}_{\delta \boldsymbol{\theta}} \triangleq \frac{\partial(\mathbf{q} \otimes \delta \mathbf{q})}{\partial \delta \boldsymbol{\theta}}\right|_{\mathbf{q}}=\left.\left.\frac{\partial(\mathbf{q} \otimes \delta \mathbf{q})}{\partial \delta \mathbf{q}}\right|_{\mathbf{q}} \frac{\partial \delta \mathbf{q}}{\partial \delta \boldsymbol{\theta}}\right|_{\hat{\delta} \hat{\theta}=0}
$$

<span style="color:blue;">**å¦å¤–ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œåœ¨å…¶ä¸­çš„æ—‹è½¬çŸ©é˜µè¡¨ç¤ºä¸º**</span>ï¼š

å…¶ä¸­ç‰¹åˆ«è¦æ³¨æ„å››å…ƒæ•°çš„æ—‹è½¬æ–¹å¼ã€‚
$$
R=_{b}^{w}R=Exp[_{I}^{G}\delta\theta]=_{I}^{G}\delta q
$$
![20200623140517](https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623140517.png)

> æ€»ä½“æ¥è¯´ï¼Œéœ€è¦åŒºåˆ†æ ‡ç§°å€¼ä¸è¯¯å·®çŠ¶æ€é‡ä¹‹é—´çš„å…³ç³»ã€‚

cvä¸­çš„3dæ ‡å®šï¼š<span style="color:blue;">**T21 = Tbw = 2d2d(pw,pb) = 2d2d(p1,p2)**</span>

#####  æ¬§æ‹‰è§’çš„è¡¨ç¤º

<span style="color:blue;">**å¦å¤–ï¼Œè§‚å¯Ÿåˆ°qä¸Réƒ½æ˜¯æœ‰æ–¹å‘çš„ï¼Œé‚£ä¹ˆæ¬§æ‹‰è§’æœ‰æ²¡æœ‰æ–¹å‘å‘¢ï¼Ÿ**</span>äº‹å®è¯æ˜æ˜¯æœ‰çš„ã€‚

![image-20200625102854467](/Users/chenshiming/Library/Application%20Support/typora-user-images/image-20200625102854467.png)

å…¶ä¸­ï¼ŒWæ˜¯å¯é€†çŸ©é˜µï¼Œè¿™é‡Œè¯´æ˜äº†æ¬§æ‹‰è§’ä¹Ÿæ˜¯å­˜åœ¨æ–¹å‘çš„ã€‚ä¸Šé¢è¯´æ˜äº†eulerRatesä¸bodyRatesä¹‹é—´çš„å…³ç³»ï¼Œä¸‹é¢è¡¨ç¤ºäº†é€†çŸ©é˜µã€‚

 ```python
 cr = cos(roll);
 sr = sin(roll);
 cp = cos(pitch);
 sp = sin(pitch);
R = [1, 0, -sp;
    0, cr, sr * cp;
    0, -sr, cr * cp];
 ```

##### å››å…ƒæ•°ä¸­å‚ä¸çš„è¿ç®—

#### ESKFçš„å®ç°

 ```python
% =========================================================================
%
%                  ESKFçš„å®ç°
% 
%
% =========================================================================
%
%ã€€(C)2020-2022 China Academy of Railway Sciences 
%   ç‰ˆæœ¬ï¼šV1.0
%   æ—¥æœŸï¼š2020å¹´ 6æœˆ23æ—¥
%   ä½œè€…ï¼šs.m.
%--------------------------------------------------------------------------
%  åŠŸèƒ½ï¼š1.å®ç°ESKFç®—æ³•ï¼ŒåŠ æ·±å¯¹äºçŠ¶æ€ä¼°è®¡çš„ç†è§£
%        2.å…¶ä¸­çš„é—®é¢˜ï¼š
%     1ï¼‰ æµ‹é‡åŠ ä¸Šåœ°ç£è®¡
%     2ï¼‰ æ³¨æ„è¯¯å·®é‡ä¸æ ‡ç§°é‡
%     3ï¼‰ å››å…ƒæ•°è½¬è§’åº¦æ—¶æœ‰è¯¯å·®ï¼Œå°±æ˜¯è¿™ä¸ªå¯¼è‡´äº†è¯¯å·®é‡
%
%
%
%--------------------------------------------------------------------------
clear all;
close all;
addpath('../../ESKF-Attitude-Estimation-master')
addpath('../utils')
% -------------------- import data-------------------
fileName = '../NAV_1';
Data = importdata(sprintf('%s.mat',fileName));
lengthtp = size(Data,1);

time    = zeros(lengthtp,1);
roll    = zeros(lengthtp,1);
pitch   = zeros(lengthtp,1);
yaw     = zeros(lengthtp,1);
imuNominalStates = cell(1,lengthtp);
imuErrorStates   = cell(1,lengthtp);
measurements = cell(1,lengthtp);
%groundTruth
for state_k = 1:lengthtp 
    measurements{state_k}.dt    = 0.02;                      % sampling times 50Hz
    measurements{state_k}.omega = Data(state_k,27:29)';            
    measurements{state_k}.acc   = Data(state_k,9:11)';
    measurements{state_k}.mag   = Data(state_k,15:17)';
    time(state_k)=state_k*0.02;
end
rad2deg = 180/pi;
rollRef   = Data(:,30)*rad2deg;
pitchRef  = Data(:,31)*rad2deg;
yawRef    = Data(:,32)*rad2deg;
% --------------------Data analysis------------------
% ++++++++++++++++++++1.initialization++++++++++++++++
dt = measurements{1}.dt;

% æ€ä¹ˆå¤„ç†åˆå§‹åŒ–çš„thetaï¼Ÿ
omega_b = zeros(3,1);%%è¿™ä¸ªç”¨åˆ°
theta = zeros(3,1);%%è¿™ä¸ªç”¨ä¸åˆ°

% error state initialization
dt_theta = zeros(3,1);
dt_omega_b = zeros(3,1);

% Keep updated status
err_state = [dt_theta;dt_omega_b];
quat = zeros(4,1);

% --------Refer to previous practice for initialization-----------------------------------
init_angle = [Data(1,30),Data(1,31),Data(1,32)]';
init_quat = oula2q(init_angle);
quat = init_quat';
% -------------------------2.covariance matrix ---------------------
p1 = 1e-5;p2 =  1e-7;
P = blkdiag(p1,p1,p1,p2,p2,p2);%%åˆå§‹åŒ–

sigma_wn = 1e-5;
sigma_wbn = 1e-9;
Theta_i = sigma_wn*dt^2*eye(3);
Omega_i = sigma_wbn*dt^2*eye(3);
Fi = eye(6);
Qi = blkdiag(Theta_i , Omega_i);
Q = Fi*Qi*Fi';

sigma_acc = 1e-3;
sigma_mn = 1e-4;
R = blkdiag(eye(3)*sigma_acc,eye(3)*sigma_mn);
for index = 1:lengthtp-1
    % --------------------------forecast------------
    omega_m = (measurements{index+1}.omega + measurements{index}.omega)/2;
    av = (omega_m - omega_b)*dt;
     det_q = [1;0.5*av];
     quat = quatLeftComp(quat)*det_q;
     omega_b = omega_b;
     % è®¡ç®—æ ‡ç§°å€¼
    F1 = Exp_lee((measurements{index+1}.omega - omega_b)*dt);
    F1 = F1';
    Fx = [F1  , -eye(3)*dt;
    zeros(3)  , eye(3)];
     P_ = Fx*P*Fx' + Q;
     % -----------------------observation---------------------
     % Prediction results and observations
     [H,detZ] = calH(quat,  measurements{index+1});
     % --------------------update-----------------
     K = P_*H'*inv(H*P_*H' + R)/2;
     err_state = K*detZ;
     P = P_ - K*(H*P_*H' + R)*K';
     % ----------------------update state----------------------
     % å‚è€ƒä¹‹å‰çš„å‡½æ•°ï¼Œdt_theta-->quat, quatçš„å·¦ä¹˜æ–¹æ³•
     
     dt_theta = err_state(1:3);
     dt_omega_b = err_state(4:6);
     dt_q = buildUpdateQuat(dt_theta);
     quat = quatLeftComp(quat)*dt_q;
     quat = quat/norm(quat);
     omega_b = omega_b + dt_omega_b;
     
     % ------save angle-----------------------------
     [a1,a2,a3] = quattoeuler(quat);
     oula(index+1,:) = [a1,a2,a3]/180*pi;
     dt_theta_save(index+1,:) = err_state';
     % ----------------------------reset-------------------
     err_state = zeros(6,1);
     G = blkdiag(eye(3) - omegaMatrix(dt_theta/2) ,eye(3));
     P = G*P*G';
end

% figure;
% subplot(3,1,1)
% plot(pitchRef);
% hold on;plot(oula(:,2)/pi*180);
% subplot(3,1,2)
% plot(rollRef);
% hold on;plot(oula(:,1)/pi*180);
% subplot(3,1,3)
% plot(yawRef);
% hold on;plot(oula(:,3)/pi*180);
% legend 1 2 

 rotLim = [-5 5];
figure;
subplot(3,1,1)
plot(oula(:,1)/pi*180 - rollRef);
subplot(3,1,2)
plot(oula(:,2)/pi*180 - pitchRef);
subplot(3,1,3)
plot(oula(:,3)/pi*180 - yawRef);
legend 1 2 
% ylim(rotLim)



function R = q2R(q)
%å››å…ƒæ•°è½¬æ—‹è½¬çŸ©é˜µ
R=[ 2*q(1).^2-1+2*q(2)^2    2*(q(2)*q(3)-q(1)*q(4)) 2*(q(2)*q(4)+q(1)*q(3));
    2*(q(2)*q(3)+q(1)*q(4)) 2*q(1)^2-1+2*q(3)^2     2*(q(3)*q(4)-q(1)*q(2));
    2*(q(2)*q(4)-q(1)*q(3)) 2*(q(3)*q(4)+q(1)*q(2)) 2*q(1)^2-1+2*q(4)^2];
R2 = R;
end

function Q_dt_theta = cal_Q_dt_theta(quat)
Q_dt_theta = 0.5* [-quat(2)  -quat(3)   -quat(4); ...
                quat(1)  -quat(4)    quat(3); ...
                quat(4)   quat(1)   -quat(2); ...
               -quat(3)   quat(2)    quat(1)]; 
end

function F = Exp_lee(in)
S = omegaMatrix(in);
    normV  = sqrt(S(1,2)^2+S(1,3)^2+S(1,3)^2);
    F = eye(3)+sin(normV)/normV*S(:,:)+...
            (1-cos(normV))/normV^2*S(:,:)^2;
end
function [omega]=omegaMatrix(data)
% wx=data(1)*pi/180;
% wy=data(2)*pi/180;
% wz=data(3)*pi/180;
wx=data(1);
wy=data(2);
wz=data(3);
omega=[
    0,-wz,wy;
    wz,0,-wx;
    -wy,wx,0
    ];
end
function q = R2q(R)
%æ—‹è½¬çŸ©é˜µè½¬å››å…ƒæ•°
t=sqrt(1+R(1,1)+R(2,2)+R(3,3))/2;
q=[t (R(3,2)-R(2,3))/(4*t) (R(1,3)-R(3,1))/(4*t) (R(2,1)-R(1,2))/(4*t)];
Q1 = q;
end

function  q = oula2q(in)
x = in(1);
y = in(2);
z = in(3);
%æ¬§æ‹‰è§’è½¬å››å…ƒæ•°
q = [cos(x/2)*cos(y/2)*cos(z/2) + sin(x/2)*sin(y/2)*sin(z/2) ...
    sin(x/2)*cos(y/2)*cos(z/2) - cos(x/2)*sin(y/2)*sin(z/2) ...
    cos(x/2)*sin(y/2)*cos(z/2) + sin(x/2)*cos(y/2)*sin(z/2) ...
    cos(x/2)*cos(y/2)*sin(z/2) - sin(x/2)*sin(y/2)*cos(z/2)];

end
function Ang3 = q2oula(q)
%å››å…ƒæ•°è½¬æ¬§æ‹‰è§’
x = atan2(2*(q(1)*q(2)+q(3)*q(4)),1 - 2*(q(2)^2+q(3)^2));
y = asin(2*(q(1)*q(3) - q(2)*q(4)));
z = atan2(2*(q(1)*q(4)+q(2)*q(3)),1 - 2*(q(3)^2+q(4)^2));
Ang3 = [x y z];
end

function updateQuat = buildUpdateQuat(deltaTheta)
    deltaq = 0.5 * deltaTheta;
    updateQuat = [1; deltaq];
    updateQuat = updateQuat / norm(updateQuat);
end

function qLC = quatLeftComp(quat)
    vector = quat(2:4);
    scalar = quat(1);
    
    qLC = [  scalar ,  -vector';
             vector , scalar*eye(3) + crossMat(vector)  ];
end

function [H,detZ] = calH(q,measurements_k)
    % Normalise magnetometer measurement
    if(norm(measurements_k.mag) == 0), return; end	% 
    measurements_k.mag = measurements_k.mag / norm(measurements_k.mag);	% normalise magnitude,very important!!!!
    % Normalise accelerometer measurement
    if(norm(measurements_k.acc) == 0), return; end	% handle NaN
    measurements_k.acc  = measurements_k.acc / norm(measurements_k.acc);	% normalise accelerometer ,very important!!!!
    % Reference direction of Earth's magnetic feild
    h = quaternProd(q, quaternProd([0; measurements_k.mag], quatInv(q)));
    b = [0 norm([h(2) h(3)]) 0 h(4)];
    Ha = [2*q(3),                 	-2*q(4),                    2*q(1),                         -2*q(2)
         -2*q(2),                 	-2*q(1),                   -2*q(4),                         -2*q(3)
          0,                         4*q(2),                    4*q(3),                         0];
    Hm = [-2*b(4)*q(3),                2*b(4)*q(4),               -4*b(2)*q(3)-2*b(4)*q(1),       -4*b(2)*q(4)+2*b(4)*q(2)
          -2*b(2)*q(4)+2*b(4)*q(2),	   2*b(2)*q(3)+2*b(4)*q(1),    2*b(2)*q(2)+2*b(4)*q(4),       -2*b(2)*q(1)+2*b(4)*q(3)
           2*b(2)*q(3),                2*b(2)*q(4)-4*b(4)*q(2),	   2*b(2)*q(1)-4*b(4)*q(3),        2*b(2)*q(2)];
    Hx = [Ha, zeros(3,3)
          Hm, zeros(3,3)];
%     Hx = [Ha, zeros(3,3)];
    Q_detTheta  = [-q(2),    -q(3),      -q(4)
                    q(1),    -q(4),       q(3) 
                    q(4),     q(1),      -q(2) 
                   -q(3),     q(2),       q(1)];
    Xx = [0.5*Q_detTheta , zeros(4,3)
          zeros(3)       , eye(3)];
    H = Hx*Xx; 
    
    detZ_a = [ 2*(q(2)*q(4)  - q(1)*q(3)) + measurements_k.acc(1)
               2*(q(1)*q(2) + q(3)*q(4)) + measurements_k.acc(2)
               2*(0.5 - q(2)^2 - q(3)^2) + measurements_k.acc(3)];
%     detZ   = detZ_a;
    detZ_m =[((2*b(2)*(0.5 - q(3)^2 - q(4)^2) + 2*b(4)*(q(2)*q(4) - q(1)*q(3))) + measurements_k.mag(1))
             ((2*b(2)*(q(2)*q(3) - q(1)*q(4)) + 2*b(4)*(q(1)*q(2) + q(3)*q(4))) + measurements_k.mag(2))
             ((2*b(2)*(q(1)*q(3) + q(2)*q(4)) + 2*b(4)*(0.5 - q(2)^2 - q(3)^2)) + measurements_k.mag(3))]; 
    detZ   = [detZ_a;detZ_m];
end


function [roll,pitch,yaw] = quattoeuler(q)
rad2deg=180/pi;
T=[ 1 - 2 * (q(4) *q(4) + q(3) * q(3))  2 * (q(2) * q(3) +q(1) * q(4))         2 * (q(2) * q(4)-q(1) * q(3));
    2 * (q(2) * q(3)-q(1) * q(4))       1 - 2 * (q(4) *q(4) + q(2) * q(2))     2 * (q(3) * q(4)+q(1) * q(2));
    2 * (q(2) * q(4) +q(1) * q(3))      2 * (q(3) * q(4)-q(1) * q(2))          1 - 2 * (q(2) *q(2) + q(3) * q(3))];%cnb
roll  = atan2(T(2,3),T(3,3))*rad2deg;
pitch = asin(-T(1,3))*rad2deg;
yaw   = atan2(T(1,2),T(1,1))*rad2deg-8.3;%%è¿™ä¸ªå›ºå®šåå·®æ˜¯ä»€ä¹ˆé¬¼  
yaw   = atan2(T(1,2),T(1,1))*rad2deg;%%è¿™ä¸ªå›ºå®šåå·®æ˜¯ä»€ä¹ˆé¬¼  
end
 ```

è¿™é‡Œé¢ä¸€ä¸ªå¾ˆé‡è¦çš„æ€§è´¨å°±æ˜¯ï¼š
$$
\delta q=\left[\begin{array}{l}1 \\ \frac{1}{2} \delta \theta\end{array}\right]
$$
