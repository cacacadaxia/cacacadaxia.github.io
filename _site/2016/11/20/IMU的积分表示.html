<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>IMU的积分表示 | Your awesome title</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="IMU的积分表示" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="[TOC]" />
<meta property="og:description" content="[TOC]" />
<link rel="canonical" href="http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html" />
<meta property="og:url" content="http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-20T00:00:00+08:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html"},"description":"[TOC]","headline":"IMU的积分表示","dateModified":"2016-11-20T00:00:00+08:00","datePublished":"2016-11-20T00:00:00+08:00","@type":"BlogPosting","url":"http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IMU的积分表示</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-11-20T00:00:00+08:00" itemprop="datePublished">Nov 20, 2016
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>[TOC]</p>

<p>参考目录：</p>

<h3 id="博客整理">博客整理</h3>

<p>在文献<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>的做法中，</p>

<h4 id="惯性导航中的一些问题">惯性导航中的一些问题</h4>

<h5 id="四元数的运算总结">四元数的运算总结</h5>

<p>离散与连续之间的关系，比较让人迷惑。</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200629093038.png" alt="20200629093038" style="zoom:10%;" /></p>

<h5 id="四元数的表示方法是什么">四元数的表示方法是什么？</h5>

<p>可以这样表示：
\(\dot{q}_{e}^{b}(t)=\frac{1}{2}\left[\begin{array}{cccc}
0 &amp; -\omega_{x} &amp; -\omega_{y} &amp; -\omega_{z} \\
\omega_{x} &amp; 0 &amp; \omega_{z} &amp; -\omega_{y} \\
\omega_{y} &amp; -\omega_{z} &amp; 0 &amp; \omega_{x} \\
\omega_{z} &amp; \omega_{y} &amp; -\omega_{x} &amp; 0
\end{array}\right] q_{e}^{b}(t)\)
在MEKF算法的差分化之后，有这样的结果：
\(\boldsymbol{q}(t+\Delta t)=\boldsymbol{q}(t) \otimes e^{\frac{1}{2} \boldsymbol{q}_{\omega} \Delta t}\)
也可以表示为：
\(\mathbf{q}_{b, b_{k}} \otimes \delta \mathbf{q}_{b_{k} b_{k}^{\prime}}=\delta \mathbf{q}_{b, b_{k}} \otimes\left[\begin{array}{c}
1 \\
\frac{1}{2} \delta \theta_{b_{k} b_{k}}
\end{array}\right]\)</p>

<h5 id="科式加速度的表示">科式加速度的表示</h5>

<p><a href="https://fzheng.me/2016/11/20/imu_model_eq/">参考</a>；</p>

<p>科式加速度主要用来描述参考系与惯性系之间的关系。</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200620182700.png" alt="20200620182700" /></p>

<p>我们来逐项分析上面这个式子。第一项中 αα 为 {B} 的角加速度，所以第一项的物理意义是 {B} 旋转所造成的 P 的切向加速度。第二项是 {B} 旋转所造成的向心加速度。第四项为 P 相对于 {B} 的加速度，但在惯性系 {A} 下表达——类似于 vrvr，定义相对加速度 arar。第三项比较特殊，为 {B} 的旋转运动与 P 相对 {B} 的平移运动耦合产生的加速度，称为「科氏加速度」。可以看到，除了第四项外，另外三项都和 {B} 的旋转有关。</p>

<h5 id="什么时候能够用到科式加速度呢">什么时候能够用到科式加速度呢？</h5>

<p>在MSCKF1中，考虑的是参考系（b），因此需要考虑；但在MSCKF2中，考虑的是惯性系（a），所以就不需要考虑科式加速度了。</p>

<blockquote>
  <p>这里存在一个问题：既然不考虑科式加速度又简便也符合逻辑，那么为什么一些文献中采用考虑科式加速度的做法呢？</p>
</blockquote>

<h5 id="在imu中如何确定协方差矩阵有没有一个简单的理解或者通用的解释">在IMU中如何确定协方差矩阵？有没有一个简单的理解？或者通用的解释？</h5>

<p>这个分析过程需要随机过程的知识，主要参考<a href="https://fzheng.me/2016/11/20/imu_model_eq/">博客</a>与<a href="https://zhuanlan.zhihu.com/p/71202672">博客</a>的内容。</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200620191047.png" alt="20200620191047" style="zoom:20%;" /></p>

<blockquote>
  <p>这里已经给出了比较合理的解释，可以根据这个关系去确定Q矩阵与R矩阵。上面的noise是白噪声，bias代表随机游走偏差，为白噪声的积分。</p>

  <p>这里的问题是：<strong>这个部分到底是不是为了确定Q的大小？</strong>其实我觉得这里的描述未必准确。</p>

  <p><span style="color:blue;"><strong>这里给出了连续与离散之间的关系，但是实际上还有一层关系：积分与未积分的关系</strong></span>。</p>
</blockquote>

<ul>
  <li>在之前的论文里是这么做的</li>
</ul>

\[Q_{d}=Q_{c} \Delta t \quad Q_{c}=\text 
{blkdiag}\left(\sigma_{a c c}^{2}\right)\]

<blockquote>
  <p>我觉得这个和加速度计的固有性质相关。</p>
</blockquote>

<ul>
  <li><a href="https://zhuanlan.zhihu.com/p/71202672">博客</a>的内容</li>
</ul>

<p>计算方法如下：<span style="color:red;">但是这里是白噪声还是随机游走？</span>理论上应该是白噪声，因为没有讨论随机游走。
\(\frac{Q_{c}}{\Delta t} *{\Delta t}^{2}=\frac{b l k d i a g\left(\sigma_{g y r o}^{2}\right)}{\Delta t} *{\Delta t^{2}}\)</p>

<ul>
  <li>在<a href="https://zhuanlan.zhihu.com/p/88756311">博客</a>中，提到一种ESKF的姿态角度估计方法，对于Q的求解，给出下面的结果：</li>
</ul>

\[\begin{array}{l}
\boldsymbol{V}_{i}=\sigma_{a_{n}}^{2} \Delta t^{2} \boldsymbol{I} \\
\mathbf{\Theta}_{i}=\sigma_{\omega_{n}}^{2} \Delta t^{2} \boldsymbol{I} \\
\boldsymbol{A}_{i}=\sigma_{a_{\omega}}^{2} \Delta t \boldsymbol{I} \\
\boldsymbol{\Omega}_{i}=\sigma_{\omega_{\omega}}^{2} \Delta t \boldsymbol{I}
\end{array}\]

<blockquote>
  <p>但是这里面的加速度计于陀螺的表示都是一样的，怎么解释？</p>

  <p>这里提到了一个积分的过程。</p>
</blockquote>

<p>显然与上面的矛盾，这怎么处理呢？</p>

<h5 id="如何确定协方差矩阵的更新">如何确定协方差矩阵的更新？</h5>

<p>要推导预积分量的协方差，我们需要知道 imu 噪声和预积分量 之间的线性递推关系。协方差矩阵可以这样推导：<span style="color:blue;"><strong>这个方差的积累公式需要注意一下，实际上状态估计大多都是这么做的。</strong></span>
\(\boldsymbol{\Sigma}_{i k}=\mathbf{F}_{k-1} \boldsymbol{\Sigma}_{i k-1} \mathbf{F}_{k-1}^{\top}+\mathbf{G}_{k-1} \boldsymbol{\Sigma}_{\mathbf{n}} \mathbf{G}_{k-1}^{\top}\)
其中，$Σ_n$ 是测量噪声的协方差矩阵，方差从 i 时刻开始进行递推，$Σ_{ii} = 0$。</p>

<p>但是在传统的卡尔曼滤波器的递推公式中，有下面的结果：</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200621091350.png" alt="20200621091350" style="zoom:50%;" /></p>

<p>在这里更新的过程并没有考虑到控制量u的雅可比矩阵，这是为什么呢？<span style="color:blue;"><strong>因为u的雅可比矩阵只影响到P矩阵的更新，而并不影响标称值的更新。（标称值的更新依赖于更加准确的非线性状态更新方程）</strong></span>。</p>

<p>这里Q代表的过程误差方差矩阵，对应的维度是状态量。利用控制量与运动学方程，确实可以求出来状态量的误差方差矩阵。相当于状态量的方差有一部分是由控制量决定的。但是如果系统中没有控制量，只有状态量，那么就需要直接给出Q矩阵的值。实际上这种系统也是比较多的。</p>

<p>在一个开源项目中是这样确定Q的大小的：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sGPS</span>     <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="mf">8.8</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># assume 8.8m/s2 as maximum acceleration, forcing the vehicle
</span><span class="n">sCourse</span>  <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># assume 0.1rad/s as maximum turn rate for the vehicle
</span><span class="n">sVelocity</span><span class="o">=</span> <span class="mf">8.8</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># assume 8.8m/s2 as maximum acceleration, forcing the vehicle
</span><span class="n">sYaw</span>     <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># assume 1.0rad/s2 as the maximum turn rate acceleration for the vehicle
</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">diag</span><span class="p">([</span><span class="n">sGPS</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sGPS</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sCourse</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sVelocity</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sYaw</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div></div>

<blockquote>
  <p>可以看到这里的Q是用来描述连续微分运动学方程中的微分量的。因为这里的Q只是在定义误差量的过程噪声，所以是比较合理的。</p>

</blockquote>

<p>最终在MEKF<a href="https://zhuanlan.zhihu.com/p/71202815">的博客中找到答案</a>：</p>

<p>在文献1中找到下面的佐证（附录部分）。下面的差分化是利用了第二种状态方程的递推方法，然后进行离散化。</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623100552.png" alt="20200623100552" style="zoom:25%;" /></p>

<p>由此便得知协方差Q矩阵的确定过程。实际上<span style="color:green;"><strong>在实验中，并没有特别严格的定义，实际上两种都可以</strong></span>。对比试验结果发现其影响比较小。</p>

<h5 id="如何将角度积分差分化表示">如何将角度积分差分化表示？</h5>

<p>在VIO中，对于IMU的处理流程是：预积分–预积分的离散形式–推导预积分的方差。</p>

<table>
  <thead>
    <tr>
      <th>类别</th>
      <th>方法</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>博主</td>
      <td>差分化–&gt;离散化</td>
    </tr>
    <tr>
      <td>VIO</td>
      <td>离散化–&gt;差分化</td>
    </tr>
    <tr>
      <td> </td>
      <td><span style="color:blue;"><strong>实际上就是两个部分：离散化，差分化。虽然都不是<br />什么复杂的数学理论，但是常常让人感到confused</strong></span></td>
    </tr>
  </tbody>
</table>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619081139836.png" alt="image-20200619081139836" /></p>

<blockquote>
  <p>实际上IMU组件给系统系统的运动学方程，在状态估计中可以认为是一种约束。同时测量方程也可以认为是另外一种约束。</p>

  <p>在优化系统中，将这两种约束都写入到优化函数中，并且保证惩罚函数是线性的，这样就可以利用梯度下降法简单求解了。</p>
</blockquote>

<table>
  <thead>
    <tr>
      <th>类别</th>
      <th>方法</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>基于一阶泰勒展开误差递推方程：方法1</td>
      <td>离散化–&gt;差分化</td>
    </tr>
    <tr>
      <td>基于误差随时间变化的递推方程：方法2</td>
      <td>差分化–&gt;离散化</td>
    </tr>
    <tr>
      <td>备注</td>
      <td><span style="color:blue;"><strong>实际上就是两个部分：离散化，差分化。虽然都不是<br />什么复杂的数学理论，但是常常让人感到confused<br />另外，差分化就是将其写成误差状态的形式</strong></span></td>
    </tr>
  </tbody>
</table>

<p>但是因为方法2中需要知道状态量的连续导数关系（随时间变化的关系），很多系统都没办法求解这部分（在PVQ系统中可以做）。方法1中的离散形式比较符合对EKF的解释和EKF中协方差更新的方法，因此更加常用。</p>

<p><span style="color:blue;"><strong>总结来说，如果系统是连续方程，那么需要先进行error state化之后再进行离散化。如果系统是离散方程，那么直接进行error state化即可</strong></span>。</p>

<p>下面是详细定义：</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619092634104.png" alt="image-20200619092634104" /></p>

<p><span style="color:blue;"><strong>于是有下面的结果，这里的变化很重要</strong></span>：</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200619092641.png" alt="20200619092641" /></p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619092726511.png" alt="image-20200619092726511" /></p>

<h5 id="但是最后一步是怎么推导的">但是最后一步是怎么推导的？</h5>

<p>在上面的两种方法中，第一种是符合EKF的状态方程的递推关系的；第二种是目前VIO算法中的主流做法。应该是殊途同归的两种做法，但是第一种更为通用。</p>

<p><span style="color:red;">下面的推导是怎么完成的</span>？
\(\begin{array}{l}
\dot{\delta \mathbf{v}}=\mathbf{R} \delta \mathbf{a}^{b}+\mathbf{R}[\delta \boldsymbol{\theta}]_{\times}\left(\mathbf{a}^{b}+\delta \mathbf{a}^{b}\right)+\delta \mathbf{g} \\
\dot{\delta \mathbf{v}}=\mathbf{R} \delta \mathbf{a}^{\mathbf{b}}-\mathbf{R}\left[\mathbf{a}^{b}\right]_{\times} \delta \boldsymbol{\theta}+\delta \mathbf{g}
\end{array}\)</p>

<p>最符合逻辑的就是：<span style="color:red;"><strong>两个小量相乘，最后的结果就是无穷小，可以忽略</strong></span>。</p>

<p>与ESKF的区别是什么？下面给出ESKF的定义。
\(\dot{\delta \mathbf{v}}=-\mathbf{R}\left[\mathbf{a}_{m}-\mathbf{a}_{b}\right]_{\times} \delta \boldsymbol{\theta}-\mathbf{R} \delta \mathbf{a}_{b}+\delta \mathbf{g}-\mathbf{R} \mathbf{a}_{n}\)
但是如何比较两者的区别？有待后续完成。</p>

<h5 id="为什么要用误差状态量去表示呢">为什么要用误差状态量去表示呢？</h5>

<p>这部分参考Quaternion kinematics for the error-state Kalman filte<a href="https://zhuanlan.zhihu.com/p/88756311">和博客</a>。</p>

<ul>
  <li>定向误差状态是最小的，避免了与过度参数化相关的问题，以及相关协方差矩阵奇异性的风险，这通常是由强制约束引起的</li>
  <li>误差状态系统总是在接近原始系统的情况下运行，因此远离可能的参数奇点、万向锁问题等，从而保证线性化的有效性始终保持不变</li>
  <li>错误状态总是很小，这意味着所有二阶部分都可以忽略不计。这使得雅可比矩阵的计算变得非常简单和快速。有些雅可比数甚至可能是常数或等于可用状态量。</li>
  <li>误差动力学是缓慢的，因为所有的大信号动力学都已集成到标称状态。这意味着我们可以以低于预测的速度应用KF修正</li>
</ul>

<blockquote>
  <p>什么是动力学是缓慢的？变化是缓慢的？</p>
</blockquote>

<blockquote>
  <p><span style="color:green;"><strong>是不是用来描述振动变化，有着更为出色的性能</strong></span>？如果是的话，这也是一个可以发论文的点。</p>

  <p>是不是和李代数去表示是有关系的，只有在小量的时候，在切空间的性质才可以成立。</p>
</blockquote>

<h5 id="是如何将误差状态与控制量相结合的">是如何将误差状态与控制量相结合的？</h5>

<p>角速度积分表示：
\(\begin{aligned}
_{I}^{G} \dot{\boldsymbol{R}} &amp;=_{I}^{G} \boldsymbol{R}\left[\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}-\boldsymbol{n}_{w}\right] \times \\
\dot{\boldsymbol{b}}_{g} &amp;=\mathbf{0}+\boldsymbol{n}_{g}
\end{aligned}\)
下面是旋转矩阵的积分过程：
\(\frac{\mathrm{d} \mathbf{R}}{\mathrm{d} t}=\mathbf{R}[\boldsymbol{\omega}]_{\times}\)
得到离散化之后的：
\(\mathbf{R}(t+\Delta t)=\mathbf{R}(t) e^{[\omega]_{\times} \Delta t}\)</p>

<p>参考EKF-Based IMU Orientation Estimation，有下面的运动学方程：
\(\begin{aligned}
\delta \boldsymbol{\theta} &amp;=\operatorname{Exp}\left[\left(\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}\right) \Delta t\right]^{T} \delta \boldsymbol{\theta}-\delta \boldsymbol{b}_{g} \Delta t+\boldsymbol{\theta}_{i} \\
\delta \boldsymbol{b}_{g} &amp;=\delta \boldsymbol{b}_{g}+\boldsymbol{\omega}_{i}
\end{aligned}\)
表示为：
\(\left[\begin{array}{c}
\delta \boldsymbol{\theta} \\
\delta \boldsymbol{b}_{g}
\end{array}\right]=\underbrace{\left[\begin{array}{cc}
\operatorname{Exp}\left[\left(\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}\right) \Delta t\right]^{T} &amp; -\boldsymbol{I} \Delta t \\
\boldsymbol{0} &amp; \boldsymbol{I}
\end{array}\right]}_{\boldsymbol{F}_{\boldsymbol{x}}}\left[\begin{array}{c}
\boldsymbol{\delta} \boldsymbol{\theta} \\
\delta \boldsymbol{b}_{g}
\end{array}\right]+\underbrace{\left[\begin{array}{cc}
\boldsymbol{I} &amp; \boldsymbol{0} \\
\boldsymbol{0} &amp; \boldsymbol{I}
\end{array}\right]}_{\boldsymbol{F}_{i}}\left[\begin{array}{c}
\boldsymbol{\theta}_{i} \\
\boldsymbol{\omega}_{i}
\end{array}\right]\)</p>

<p>这里其实就说明了：sita与delta_sita的方差的对应关系。</p>

<h5 id="四元数的运算是什么样的">四元数的运算是什么样的？</h5>

<p>四元数相乘可以写成：
\(\mathbf{q}_{1} \otimes \mathbf{q}_{2}=[\mathbf{q}]_{L} \mathbf{q}_{2}=[\mathbf{q}]_{R} \mathbf{q}\)
其中
\([\mathbf{q}]_{L}=\left[\begin{array}{cccc}
q_{w} &amp; -q_{x} &amp; -q_{y} &amp; -q_{z} \\
q_{x} &amp; q_{w} &amp; -q_{z} &amp; q_{y} \\
q_{y} &amp; q_{z} &amp; q_{w} &amp; -q_{x} \\
q_{z} &amp; -q_{y} &amp; q_{x} &amp; q_{w}
\end{array}\right]=q_{w} \mathbf{I}+\left[\begin{array}{cc}
0 &amp; -\mathbf{q}_{v}^{\mathrm{T}} \\
\mathbf{q}_{v} &amp; {\left[\mathbf{q}_{v}\right]_{\times}}
\end{array}\right]\)</p>

<h5 id="最后一点四元数与李代数之间的关系">最后一点：四元数与李代数之间的关系？</h5>

<ol>
  <li>首先是李代数的部分：</li>
</ol>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622104950178.png" alt="image-20200622104950178" /></p>

<ol>
  <li>其次是罗德里格斯旋转公式：</li>
</ol>

\[\mathbf{R}=\mathbf{I}+\sin \phi[\mathbf{u}]_{\times}+(1-\cos \phi)[\mathbf{u}]_{\times}^{2}\]

<ol>
  <li>描述旋转群与四元数之间的关系：参考文献<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>的 4.2.2</li>
</ol>

<h4 id="eskf总结陈述">ESKF总结陈述</h4>

<p>ESKF就是用了上述“基于误差随时间变化”求解方法，首先写成error state，然后进行离散化得到IMU的递推方程。/</p>

<p>参数表如下：</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200622112302.png" alt="20200622112302" /></p>

<table>
  <thead>
    <tr>
      <th>English</th>
      <th>中文</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>nominal state</td>
      <td>标称状态</td>
    </tr>
    <tr>
      <td>true state</td>
      <td>真实状态</td>
    </tr>
    <tr>
      <td>error state</td>
      <td>误差状态</td>
    </tr>
  </tbody>
</table>

<h5 id="首先是运动学方程中">首先是运动学方程中：</h5>

<p>给出下面：</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622084611877.png" alt="image-20200622084611877" /></p>

<p>其中 𝜃𝑖 𝑤𝑖 为高斯随机脉冲噪声，均值为0，协方差为 𝑤𝑛 ，𝑤𝑏𝑛 在 𝛥𝑡时间内的积分值。</p>

<p>因此给出误差传播方程：
\(\begin{aligned}
\delta \mathbf{p} &amp; \leftarrow \delta \mathbf{p}+\delta \mathbf{v} \Delta t \\
\delta \mathbf{v} &amp; \leftarrow \delta \mathbf{v}+\left(-\mathbf{R}\left[\mathbf{a}_{m}-\mathbf{a}_{b}\right]_{\times} \delta \boldsymbol{\theta}-\mathbf{R} \delta \mathbf{a}_{b}+\delta \mathbf{g}\right) \Delta t+\mathbf{v}_{\mathbf{i}} \\
\delta \boldsymbol{\theta} &amp; \leftarrow \mathbf{R}^{\top}\left\{\left(\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{b}\right) \Delta t\right\} \delta \boldsymbol{\theta}-\delta \boldsymbol{\omega}_{b} \Delta t+\boldsymbol{\theta}_{\mathbf{i}} \\
\delta \mathbf{a}_{b} &amp; \leftarrow \delta \mathbf{a}_{b}+\mathbf{a}_{\mathbf{i}} \\
\delta \boldsymbol{\omega}_{b} &amp; \leftarrow \delta \boldsymbol{\omega}_{b}+\boldsymbol{\omega}_{\mathbf{i}} \\
\delta \mathbf{g} &amp; \leftarrow \delta \mathbf{g}
\end{aligned}\)</p>

<h5 id="其次是测量方程">其次是测量方程：</h5>

<p>测量方程求取雅可比矩阵采用链式法则。</p>

<p>此外有：</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622084626045.png" alt="image-20200622084626045" />
\(\left.\mathbf{X}_{\delta \mathbf{x}} \triangleq \frac{\partial \mathbf{x}_{t}}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\left[\begin{array}{ccc}
\mathbf{I}_{6} &amp; 0 &amp; 0 \\
0 &amp; \mathbf{Q}_{\delta \boldsymbol{\theta}} &amp; 0 \\
0 &amp; 0 &amp; \mathbf{I}_{9}
\end{array}\right]\)
总结来说，求取差分的偏导数如下，需要注意的是，我用到的是左栏的结果，右栏中未作考虑。</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623093941.png" alt="20200623093941" /></p>

<h5 id="其中有比较重要的推导方法">其中有比较重要的推导方法</h5>

<p>下面是两种链式求导的方法，比较重要。
\(\left.\mathbf{H} \triangleq \frac{\partial h}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\left.\left.\frac{\partial h}{\partial \mathbf{x}_{t}}\right|_{\mathbf{x}} \frac{\partial \mathbf{x}_{t}}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\mathbf{H}_{\mathbf{x}} \mathbf{X}_{\delta \mathbf{x}}\)</p>

\[\left.\mathbf{Q}_{\delta \boldsymbol{\theta}} \triangleq \frac{\partial(\mathbf{q} \otimes \delta \mathbf{q})}{\partial \delta \boldsymbol{\theta}}\right|_{\mathbf{q}}=\left.\left.\frac{\partial(\mathbf{q} \otimes \delta \mathbf{q})}{\partial \delta \mathbf{q}}\right|_{\mathbf{q}} \frac{\partial \delta \mathbf{q}}{\partial \delta \boldsymbol{\theta}}\right|_{\hat{\delta} \hat{\theta}=0}\]

<p><span style="color:blue;"><strong>另外一个重要的性质，在其中的旋转矩阵表示为</strong></span>：</p>

<p>其中特别要注意四元数的旋转方式。
\(R=_{b}^{w}R=Exp[_{I}^{G}\delta\theta]=_{I}^{G}\delta q\)
<img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623140517.png" alt="20200623140517" /></p>

<blockquote>
  <p>总体来说，需要区分标称值与误差状态量之间的关系。</p>
</blockquote>

<p>cv中的3d标定：<span style="color:blue;"><strong>T21 = Tbw = 2d2d(pw,pb) = 2d2d(p1,p2)</strong></span></p>

<h5 id="欧拉角的表示">欧拉角的表示</h5>

<p><span style="color:blue;"><strong>另外，观察到q与R都是有方向的，那么欧拉角有没有方向呢？</strong></span>事实证明是有的。</p>

<p><img src="/Users/chenshiming/Library/Application%20Support/typora-user-images/image-20200625102854467.png" alt="image-20200625102854467" /></p>

<p>其中，W是可逆矩阵，这里说明了欧拉角也是存在方向的。上面说明了eulerRates与bodyRates之间的关系，下面表示了逆矩阵。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">cr</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">);</span>
 <span class="n">sr</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">);</span>
 <span class="n">cp</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">);</span>
 <span class="n">sp</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">);</span>
<span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">sp</span><span class="p">;</span>
    <span class="mi">0</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">cp</span><span class="p">;</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">sr</span><span class="p">,</span> <span class="n">cr</span> <span class="o">*</span> <span class="n">cp</span><span class="p">];</span>
</code></pre></div></div>

<h5 id="四元数中参与的运算">四元数中参与的运算</h5>

<h4 id="eskf的实现">ESKF的实现</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span> <span class="o">=========================================================================</span>
<span class="o">%</span>
<span class="o">%</span>                  <span class="n">ESKF的实现</span>
<span class="o">%</span> 
<span class="o">%</span>
<span class="o">%</span> <span class="o">=========================================================================</span>
<span class="o">%</span>
<span class="o">%</span><span class="err">　</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="mi">2020</span><span class="o">-</span><span class="mi">2022</span> <span class="n">China</span> <span class="n">Academy</span> <span class="n">of</span> <span class="n">Railway</span> <span class="n">Sciences</span> 
<span class="o">%</span>   <span class="n">版本</span><span class="err">：</span><span class="n">V1</span><span class="p">.</span><span class="mi">0</span>
<span class="o">%</span>   <span class="n">日期</span><span class="err">：</span><span class="mi">2020</span><span class="n">年</span> <span class="mi">6</span><span class="n">月23日</span>
<span class="o">%</span>   <span class="n">作者</span><span class="err">：</span><span class="n">s</span><span class="p">.</span><span class="n">m</span><span class="p">.</span>
<span class="o">%--------------------------------------------------------------------------</span>
<span class="o">%</span>  <span class="n">功能</span><span class="err">：</span><span class="mf">1.</span><span class="n">实现ESKF算法</span><span class="err">，</span><span class="n">加深对于状态估计的理解</span>
<span class="o">%</span>        <span class="mf">2.</span><span class="n">其中的问题</span><span class="err">：</span>
<span class="o">%</span>     <span class="mi">1</span><span class="err">）</span> <span class="n">测量加上地磁计</span>
<span class="o">%</span>     <span class="mi">2</span><span class="err">）</span> <span class="n">注意误差量与标称量</span>
<span class="o">%</span>     <span class="mi">3</span><span class="err">）</span> <span class="n">四元数转角度时有误差</span><span class="err">，</span><span class="n">就是这个导致了误差量</span>
<span class="o">%</span>
<span class="o">%</span>
<span class="o">%</span>
<span class="o">%--------------------------------------------------------------------------</span>
<span class="n">clear</span> <span class="nb">all</span><span class="p">;</span>
<span class="n">close</span> <span class="nb">all</span><span class="p">;</span>
<span class="n">addpath</span><span class="p">(</span><span class="s">'../../ESKF-Attitude-Estimation-master'</span><span class="p">)</span>
<span class="n">addpath</span><span class="p">(</span><span class="s">'../utils'</span><span class="p">)</span>
<span class="o">%</span> <span class="o">--------------------</span> <span class="kn">import</span> <span class="nn">data</span><span class="o">-------------------</span>
<span class="n">fileName</span> <span class="o">=</span> <span class="s">'../NAV_1'</span><span class="p">;</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">importdata</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s">'%s.mat'</span><span class="p">,</span><span class="n">fileName</span><span class="p">));</span>
<span class="n">lengthtp</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="n">time</span>    <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">roll</span>    <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pitch</span>   <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">yaw</span>     <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">imuNominalStates</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthtp</span><span class="p">);</span>
<span class="n">imuErrorStates</span>   <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthtp</span><span class="p">);</span>
<span class="n">measurements</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthtp</span><span class="p">);</span>
<span class="o">%</span><span class="n">groundTruth</span>
<span class="k">for</span> <span class="n">state_k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">lengthtp</span> 
    <span class="n">measurements</span><span class="p">{</span><span class="n">state_k</span><span class="p">}.</span><span class="n">dt</span>    <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span>                      <span class="o">%</span> <span class="n">sampling</span> <span class="n">times</span> <span class="mi">50</span><span class="n">Hz</span>
    <span class="n">measurements</span><span class="p">{</span><span class="n">state_k</span><span class="p">}.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">state_k</span><span class="p">,</span><span class="mi">27</span><span class="p">:</span><span class="mi">29</span><span class="p">)</span><span class="s">';            
    measurements{state_k}.acc   = Data(state_k,9:11)'</span><span class="p">;</span>
    <span class="n">measurements</span><span class="p">{</span><span class="n">state_k</span><span class="p">}.</span><span class="n">mag</span>   <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">state_k</span><span class="p">,</span><span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">)</span><span class="s">';
    time(state_k)=state_k*0.02;
end
rad2deg = 180/pi;
rollRef   = Data(:,30)*rad2deg;
pitchRef  = Data(:,31)*rad2deg;
yawRef    = Data(:,32)*rad2deg;
% --------------------Data analysis------------------
% ++++++++++++++++++++1.initialization++++++++++++++++
dt = measurements{1}.dt;

% 怎么处理初始化的theta？
omega_b = zeros(3,1);%%这个用到
theta = zeros(3,1);%%这个用不到

% error state initialization
dt_theta = zeros(3,1);
dt_omega_b = zeros(3,1);

% Keep updated status
err_state = [dt_theta;dt_omega_b];
quat = zeros(4,1);

% --------Refer to previous practice for initialization-----------------------------------
init_angle = [Data(1,30),Data(1,31),Data(1,32)]'</span><span class="p">;</span>
<span class="n">init_quat</span> <span class="o">=</span> <span class="n">oula2q</span><span class="p">(</span><span class="n">init_angle</span><span class="p">);</span>
<span class="n">quat</span> <span class="o">=</span> <span class="n">init_quat</span><span class="s">';
% -------------------------2.covariance matrix ---------------------
p1 = 1e-5;p2 =  1e-7;
P = blkdiag(p1,p1,p1,p2,p2,p2);%%初始化

sigma_wn = 1e-5;
sigma_wbn = 1e-9;
Theta_i = sigma_wn*dt^2*eye(3);
Omega_i = sigma_wbn*dt^2*eye(3);
Fi = eye(6);
Qi = blkdiag(Theta_i , Omega_i);
Q = Fi*Qi*Fi'</span><span class="p">;</span>

<span class="n">sigma_acc</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">;</span>
<span class="n">sigma_mn</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">;</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">blkdiag</span><span class="p">(</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sigma_acc</span><span class="p">,</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sigma_mn</span><span class="p">);</span>
<span class="k">for</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">lengthtp</span><span class="o">-</span><span class="mi">1</span>
    <span class="o">%</span> <span class="o">--------------------------</span><span class="n">forecast</span><span class="o">------------</span>
    <span class="n">omega_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">}.</span><span class="n">omega</span> <span class="o">+</span> <span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="p">}.</span><span class="n">omega</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">av</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega_m</span> <span class="o">-</span> <span class="n">omega_b</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">;</span>
     <span class="n">det_q</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">av</span><span class="p">];</span>
     <span class="n">quat</span> <span class="o">=</span> <span class="n">quatLeftComp</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span><span class="o">*</span><span class="n">det_q</span><span class="p">;</span>
     <span class="n">omega_b</span> <span class="o">=</span> <span class="n">omega_b</span><span class="p">;</span>
     <span class="o">%</span> <span class="n">计算标称值</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="n">Exp_lee</span><span class="p">((</span><span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">}.</span><span class="n">omega</span> <span class="o">-</span> <span class="n">omega_b</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="n">F1</span><span class="s">';
    Fx = [F1  , -eye(3)*dt;
    zeros(3)  , eye(3)];
     P_ = Fx*P*Fx'</span> <span class="o">+</span> <span class="n">Q</span><span class="p">;</span>
     <span class="o">%</span> <span class="o">-----------------------</span><span class="n">observation</span><span class="o">---------------------</span>
     <span class="o">%</span> <span class="n">Prediction</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">observations</span>
     <span class="p">[</span><span class="n">H</span><span class="p">,</span><span class="n">detZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">calH</span><span class="p">(</span><span class="n">quat</span><span class="p">,</span>  <span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">});</span>
     <span class="o">%</span> <span class="o">--------------------</span><span class="n">update</span><span class="o">-----------------</span>
     <span class="n">K</span> <span class="o">=</span> <span class="n">P_</span><span class="o">*</span><span class="n">H</span><span class="s">'*inv(H*P_*H'</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
     <span class="n">err_state</span> <span class="o">=</span> <span class="n">K</span><span class="o">*</span><span class="n">detZ</span><span class="p">;</span>
     <span class="n">P</span> <span class="o">=</span> <span class="n">P_</span> <span class="o">-</span> <span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">*</span><span class="n">P_</span><span class="o">*</span><span class="n">H</span><span class="s">' + R)*K'</span><span class="p">;</span>
     <span class="o">%</span> <span class="o">----------------------</span><span class="n">update</span> <span class="n">state</span><span class="o">----------------------</span>
     <span class="o">%</span> <span class="n">参考之前的函数</span><span class="err">，</span><span class="n">dt_theta</span><span class="o">--&gt;</span><span class="n">quat</span><span class="p">,</span> <span class="n">quat的左乘方法</span>
     
     <span class="n">dt_theta</span> <span class="o">=</span> <span class="n">err_state</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">);</span>
     <span class="n">dt_omega_b</span> <span class="o">=</span> <span class="n">err_state</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">);</span>
     <span class="n">dt_q</span> <span class="o">=</span> <span class="n">buildUpdateQuat</span><span class="p">(</span><span class="n">dt_theta</span><span class="p">);</span>
     <span class="n">quat</span> <span class="o">=</span> <span class="n">quatLeftComp</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span><span class="o">*</span><span class="n">dt_q</span><span class="p">;</span>
     <span class="n">quat</span> <span class="o">=</span> <span class="n">quat</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">quat</span><span class="p">);</span>
     <span class="n">omega_b</span> <span class="o">=</span> <span class="n">omega_b</span> <span class="o">+</span> <span class="n">dt_omega_b</span><span class="p">;</span>
     
     <span class="o">%</span> <span class="o">------</span><span class="n">save</span> <span class="n">angle</span><span class="o">-----------------------------</span>
     <span class="p">[</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quattoeuler</span><span class="p">(</span><span class="n">quat</span><span class="p">);</span>
     <span class="n">oula</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">[</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">]</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">pi</span><span class="p">;</span>
     <span class="n">dt_theta_save</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">err_state</span><span class="s">';
     % ----------------------------reset-------------------
     err_state = zeros(6,1);
     G = blkdiag(eye(3) - omegaMatrix(dt_theta/2) ,eye(3));
     P = G*P*G'</span><span class="p">;</span>
<span class="n">end</span>

<span class="o">%</span> <span class="n">figure</span><span class="p">;</span>
<span class="o">%</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="o">%</span> <span class="n">plot</span><span class="p">(</span><span class="n">pitchRef</span><span class="p">);</span>
<span class="o">%</span> <span class="n">hold</span> <span class="n">on</span><span class="p">;</span><span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">);</span>
<span class="o">%</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="o">%</span> <span class="n">plot</span><span class="p">(</span><span class="n">rollRef</span><span class="p">);</span>
<span class="o">%</span> <span class="n">hold</span> <span class="n">on</span><span class="p">;</span><span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">);</span>
<span class="o">%</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="o">%</span> <span class="n">plot</span><span class="p">(</span><span class="n">yawRef</span><span class="p">);</span>
<span class="o">%</span> <span class="n">hold</span> <span class="n">on</span><span class="p">;</span><span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">);</span>
<span class="o">%</span> <span class="n">legend</span> <span class="mi">1</span> <span class="mi">2</span> 

 <span class="n">rotLim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span> <span class="mi">5</span><span class="p">];</span>
<span class="n">figure</span><span class="p">;</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span> <span class="o">-</span> <span class="n">rollRef</span><span class="p">);</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span> <span class="o">-</span> <span class="n">pitchRef</span><span class="p">);</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span> <span class="o">-</span> <span class="n">yawRef</span><span class="p">);</span>
<span class="n">legend</span> <span class="mi">1</span> <span class="mi">2</span> 
<span class="o">%</span> <span class="n">ylim</span><span class="p">(</span><span class="n">rotLim</span><span class="p">)</span>



<span class="n">function</span> <span class="n">R</span> <span class="o">=</span> <span class="n">q2R</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="o">%</span><span class="n">四元数转旋转矩阵</span>
<span class="n">R</span><span class="o">=</span><span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>    <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
    <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>     <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">];</span>
<span class="n">R2</span> <span class="o">=</span> <span class="n">R</span><span class="p">;</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">Q_dt_theta</span> <span class="o">=</span> <span class="n">cal_Q_dt_theta</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
<span class="n">Q_dt_theta</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span> <span class="p">[</span><span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="p">...</span>
                <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>    <span class="n">quat</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="p">...</span>
                <span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="p">...</span>
               <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">)];</span> 
<span class="n">end</span>

<span class="n">function</span> <span class="n">F</span> <span class="o">=</span> <span class="n">Exp_lee</span><span class="p">(</span><span class="ow">in</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">omegaMatrix</span><span class="p">(</span><span class="ow">in</span><span class="p">);</span>
    <span class="n">normV</span>  <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">normV</span><span class="p">)</span><span class="o">/</span><span class="n">normV</span><span class="o">*</span><span class="n">S</span><span class="p">(:,:)</span><span class="o">+</span><span class="p">...</span>
            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">normV</span><span class="p">))</span><span class="o">/</span><span class="n">normV</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="p">(:,:)</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="n">end</span>
<span class="n">function</span> <span class="p">[</span><span class="n">omega</span><span class="p">]</span><span class="o">=</span><span class="n">omegaMatrix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="o">%</span> <span class="n">wx</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>
<span class="o">%</span> <span class="n">wy</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>
<span class="o">%</span> <span class="n">wz</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>
<span class="n">wx</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">wy</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">wz</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">omega</span><span class="o">=</span><span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">wz</span><span class="p">,</span><span class="n">wy</span><span class="p">;</span>
    <span class="n">wz</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">wx</span><span class="p">;</span>
    <span class="o">-</span><span class="n">wy</span><span class="p">,</span><span class="n">wx</span><span class="p">,</span><span class="mi">0</span>
    <span class="p">];</span>
<span class="n">end</span>
<span class="n">function</span> <span class="n">q</span> <span class="o">=</span> <span class="n">R2q</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="o">%</span><span class="n">旋转矩阵转四元数</span>
<span class="n">t</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="n">t</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="p">)];</span>
<span class="n">Q1</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
<span class="n">end</span>

<span class="n">function</span>  <span class="n">q</span> <span class="o">=</span> <span class="n">oula2q</span><span class="p">(</span><span class="ow">in</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="ow">in</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">y</span> <span class="o">=</span> <span class="ow">in</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">z</span> <span class="o">=</span> <span class="ow">in</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="o">%</span><span class="n">欧拉角转四元数</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
    <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
    <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
    <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)];</span>

<span class="n">end</span>
<span class="n">function</span> <span class="n">Ang3</span> <span class="o">=</span> <span class="n">q2oula</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="o">%</span><span class="n">四元数转欧拉角</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">));</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">));</span>
<span class="n">Ang3</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="n">y</span> <span class="n">z</span><span class="p">];</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">updateQuat</span> <span class="o">=</span> <span class="n">buildUpdateQuat</span><span class="p">(</span><span class="n">deltaTheta</span><span class="p">)</span>
    <span class="n">deltaq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">deltaTheta</span><span class="p">;</span>
    <span class="n">updateQuat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">;</span> <span class="n">deltaq</span><span class="p">];</span>
    <span class="n">updateQuat</span> <span class="o">=</span> <span class="n">updateQuat</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">updateQuat</span><span class="p">);</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">qLC</span> <span class="o">=</span> <span class="n">quatLeftComp</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">scalar</span> <span class="o">=</span> <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    
    <span class="n">qLC</span> <span class="o">=</span> <span class="p">[</span>  <span class="n">scalar</span> <span class="p">,</span>  <span class="o">-</span><span class="n">vector</span><span class="s">';
             vector , scalar*eye(3) + crossMat(vector)  ];
end

function [H,detZ] = calH(q,measurements_k)
    % Normalise magnetometer measurement
    if(norm(measurements_k.mag) == 0), return; end	% 
    measurements_k.mag = measurements_k.mag / norm(measurements_k.mag);	% normalise magnitude,very important!!!!
    % Normalise accelerometer measurement
    if(norm(measurements_k.acc) == 0), return; end	% handle NaN
    measurements_k.acc  = measurements_k.acc / norm(measurements_k.acc);	% normalise accelerometer ,very important!!!!
    % Reference direction of Earth'</span><span class="n">s</span> <span class="n">magnetic</span> <span class="n">feild</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">quaternProd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">quaternProd</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">],</span> <span class="n">quatInv</span><span class="p">(</span><span class="n">q</span><span class="p">)));</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="n">norm</span><span class="p">([</span><span class="n">h</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">h</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span> <span class="mi">0</span> <span class="n">h</span><span class="p">(</span><span class="mi">4</span><span class="p">)];</span>
    <span class="n">Ha</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                 	<span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>                    <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>                         <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
         <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>                 	<span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>                   <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>                         <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
          <span class="mi">0</span><span class="p">,</span>                         <span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>                    <span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                         <span class="mi">0</span><span class="p">];</span>
    <span class="n">Hm</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>               <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>       <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
          <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>	   <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>    <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>       <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
           <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>	   <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>        <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)];</span>
    <span class="n">Hx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ha</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
          <span class="n">Hm</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)];</span>
<span class="o">%</span>     <span class="n">Hx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ha</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)];</span>
    <span class="n">Q_detTheta</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>    <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>      <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>    <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>       <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
                    <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>     <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>      <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
                   <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>     <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>       <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)];</span>
    <span class="n">Xx</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">Q_detTheta</span> <span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
          <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>       <span class="p">,</span> <span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)];</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">Hx</span><span class="o">*</span><span class="n">Xx</span><span class="p">;</span> 
    
    <span class="n">detZ_a</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">acc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">acc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">acc</span><span class="p">(</span><span class="mi">3</span><span class="p">)];</span>
<span class="o">%</span>     <span class="n">detZ</span>   <span class="o">=</span> <span class="n">detZ_a</span><span class="p">;</span>
    <span class="n">detZ_m</span> <span class="o">=</span><span class="p">[((</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
             <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
             <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">(</span><span class="mi">3</span><span class="p">))];</span> 
    <span class="n">detZ</span>   <span class="o">=</span> <span class="p">[</span><span class="n">detZ_a</span><span class="p">;</span><span class="n">detZ_m</span><span class="p">];</span>
<span class="n">end</span>


<span class="n">function</span> <span class="p">[</span><span class="n">roll</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span><span class="n">yaw</span><span class="p">]</span> <span class="o">=</span> <span class="n">quattoeuler</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">rad2deg</span><span class="o">=</span><span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="p">;</span>
<span class="n">T</span><span class="o">=</span><span class="p">[</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>         <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>       <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>     <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>      <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>          <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))];</span><span class="o">%</span><span class="n">cnb</span>
<span class="n">roll</span>  <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="p">;</span>
<span class="n">pitch</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="p">;</span>
<span class="n">yaw</span>   <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="o">-</span><span class="mf">8.3</span><span class="p">;</span><span class="o">%%</span><span class="n">这个固定偏差是什么鬼</span>  
<span class="n">yaw</span>   <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="p">;</span><span class="o">%%</span><span class="n">这个固定偏差是什么鬼</span>  
<span class="n">end</span>
</code></pre></div></div>

<p>这里面一个很重要的性质就是：
\(\delta q=\left[\begin{array}{l}1 \\ \frac{1}{2} \delta \theta\end{array}\right]\)</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Quaternion kinematics for the error-state Kalman Filter.pdf <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>

  </div><a class="u-url" href="/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
