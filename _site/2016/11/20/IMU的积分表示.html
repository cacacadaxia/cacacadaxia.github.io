<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>IMUçš„ç§¯åˆ†è¡¨ç¤º | Your awesome title</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="IMUçš„ç§¯åˆ†è¡¨ç¤º" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="[TOC]" />
<meta property="og:description" content="[TOC]" />
<link rel="canonical" href="http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html" />
<meta property="og:url" content="http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-11-20T00:00:00+08:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html"},"description":"[TOC]","headline":"IMUçš„ç§¯åˆ†è¡¨ç¤º","dateModified":"2016-11-20T00:00:00+08:00","datePublished":"2016-11-20T00:00:00+08:00","@type":"BlogPosting","url":"http://localhost:4000/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Your awesome title</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">IMUçš„ç§¯åˆ†è¡¨ç¤º</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2016-11-20T00:00:00+08:00" itemprop="datePublished">Nov 20, 2016
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>[TOC]</p>

<p>å‚è€ƒç›®å½•ï¼š</p>

<h3 id="åšå®¢æ•´ç†">åšå®¢æ•´ç†</h3>

<p>åœ¨æ–‡çŒ®<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>çš„åšæ³•ä¸­ï¼Œ</p>

<h4 id="æƒ¯æ€§å¯¼èˆªä¸­çš„ä¸€äº›é—®é¢˜">æƒ¯æ€§å¯¼èˆªä¸­çš„ä¸€äº›é—®é¢˜</h4>

<h5 id="å››å…ƒæ•°çš„è¿ç®—æ€»ç»“">å››å…ƒæ•°çš„è¿ç®—æ€»ç»“</h5>

<p>ç¦»æ•£ä¸è¿ç»­ä¹‹é—´çš„å…³ç³»ï¼Œæ¯”è¾ƒè®©äººè¿·æƒ‘ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200629093038.png" alt="20200629093038" style="zoom:10%;" /></p>

<h5 id="å››å…ƒæ•°çš„è¡¨ç¤ºæ–¹æ³•æ˜¯ä»€ä¹ˆ">å››å…ƒæ•°çš„è¡¨ç¤ºæ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ</h5>

<p>å¯ä»¥è¿™æ ·è¡¨ç¤ºï¼š
\(\dot{q}_{e}^{b}(t)=\frac{1}{2}\left[\begin{array}{cccc}
0 &amp; -\omega_{x} &amp; -\omega_{y} &amp; -\omega_{z} \\
\omega_{x} &amp; 0 &amp; \omega_{z} &amp; -\omega_{y} \\
\omega_{y} &amp; -\omega_{z} &amp; 0 &amp; \omega_{x} \\
\omega_{z} &amp; \omega_{y} &amp; -\omega_{x} &amp; 0
\end{array}\right] q_{e}^{b}(t)\)
åœ¨MEKFç®—æ³•çš„å·®åˆ†åŒ–ä¹‹åï¼Œæœ‰è¿™æ ·çš„ç»“æœï¼š
\(\boldsymbol{q}(t+\Delta t)=\boldsymbol{q}(t) \otimes e^{\frac{1}{2} \boldsymbol{q}_{\omega} \Delta t}\)
ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºï¼š
\(\mathbf{q}_{b, b_{k}} \otimes \delta \mathbf{q}_{b_{k} b_{k}^{\prime}}=\delta \mathbf{q}_{b, b_{k}} \otimes\left[\begin{array}{c}
1 \\
\frac{1}{2} \delta \theta_{b_{k} b_{k}}
\end{array}\right]\)</p>

<h5 id="ç§‘å¼åŠ é€Ÿåº¦çš„è¡¨ç¤º">ç§‘å¼åŠ é€Ÿåº¦çš„è¡¨ç¤º</h5>

<p><a href="https://fzheng.me/2016/11/20/imu_model_eq/">å‚è€ƒ</a>ï¼›</p>

<p>ç§‘å¼åŠ é€Ÿåº¦ä¸»è¦ç”¨æ¥æè¿°å‚è€ƒç³»ä¸æƒ¯æ€§ç³»ä¹‹é—´çš„å…³ç³»ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200620182700.png" alt="20200620182700" /></p>

<p>æˆ‘ä»¬æ¥é€é¡¹åˆ†æä¸Šé¢è¿™ä¸ªå¼å­ã€‚ç¬¬ä¸€é¡¹ä¸­ Î±Î± ä¸º {B} çš„è§’åŠ é€Ÿåº¦ï¼Œæ‰€ä»¥ç¬¬ä¸€é¡¹çš„ç‰©ç†æ„ä¹‰æ˜¯ {B} æ—‹è½¬æ‰€é€ æˆçš„ P çš„åˆ‡å‘åŠ é€Ÿåº¦ã€‚ç¬¬äºŒé¡¹æ˜¯ {B} æ—‹è½¬æ‰€é€ æˆçš„å‘å¿ƒåŠ é€Ÿåº¦ã€‚ç¬¬å››é¡¹ä¸º P ç›¸å¯¹äº {B} çš„åŠ é€Ÿåº¦ï¼Œä½†åœ¨æƒ¯æ€§ç³» {A} ä¸‹è¡¨è¾¾â€”â€”ç±»ä¼¼äº vrvrï¼Œå®šä¹‰ç›¸å¯¹åŠ é€Ÿåº¦ ararã€‚ç¬¬ä¸‰é¡¹æ¯”è¾ƒç‰¹æ®Šï¼Œä¸º {B} çš„æ—‹è½¬è¿åŠ¨ä¸ P ç›¸å¯¹ {B} çš„å¹³ç§»è¿åŠ¨è€¦åˆäº§ç”Ÿçš„åŠ é€Ÿåº¦ï¼Œç§°ä¸ºã€Œç§‘æ°åŠ é€Ÿåº¦ã€ã€‚å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†ç¬¬å››é¡¹å¤–ï¼Œå¦å¤–ä¸‰é¡¹éƒ½å’Œ {B} çš„æ—‹è½¬æœ‰å…³ã€‚</p>

<h5 id="ä»€ä¹ˆæ—¶å€™èƒ½å¤Ÿç”¨åˆ°ç§‘å¼åŠ é€Ÿåº¦å‘¢">ä»€ä¹ˆæ—¶å€™èƒ½å¤Ÿç”¨åˆ°ç§‘å¼åŠ é€Ÿåº¦å‘¢ï¼Ÿ</h5>

<p>åœ¨MSCKF1ä¸­ï¼Œè€ƒè™‘çš„æ˜¯å‚è€ƒç³»ï¼ˆbï¼‰ï¼Œå› æ­¤éœ€è¦è€ƒè™‘ï¼›ä½†åœ¨MSCKF2ä¸­ï¼Œè€ƒè™‘çš„æ˜¯æƒ¯æ€§ç³»ï¼ˆaï¼‰ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦è€ƒè™‘ç§‘å¼åŠ é€Ÿåº¦äº†ã€‚</p>

<blockquote>
  <p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šæ—¢ç„¶ä¸è€ƒè™‘ç§‘å¼åŠ é€Ÿåº¦åˆç®€ä¾¿ä¹Ÿç¬¦åˆé€»è¾‘ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸€äº›æ–‡çŒ®ä¸­é‡‡ç”¨è€ƒè™‘ç§‘å¼åŠ é€Ÿåº¦çš„åšæ³•å‘¢ï¼Ÿ</p>
</blockquote>

<h5 id="åœ¨imuä¸­å¦‚ä½•ç¡®å®šåæ–¹å·®çŸ©é˜µæœ‰æ²¡æœ‰ä¸€ä¸ªç®€å•çš„ç†è§£æˆ–è€…é€šç”¨çš„è§£é‡Š">åœ¨IMUä¸­å¦‚ä½•ç¡®å®šåæ–¹å·®çŸ©é˜µï¼Ÿæœ‰æ²¡æœ‰ä¸€ä¸ªç®€å•çš„ç†è§£ï¼Ÿæˆ–è€…é€šç”¨çš„è§£é‡Šï¼Ÿ</h5>

<p>è¿™ä¸ªåˆ†æè¿‡ç¨‹éœ€è¦éšæœºè¿‡ç¨‹çš„çŸ¥è¯†ï¼Œä¸»è¦å‚è€ƒ<a href="https://fzheng.me/2016/11/20/imu_model_eq/">åšå®¢</a>ä¸<a href="https://zhuanlan.zhihu.com/p/71202672">åšå®¢</a>çš„å†…å®¹ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200620191047.png" alt="20200620191047" style="zoom:20%;" /></p>

<blockquote>
  <p>è¿™é‡Œå·²ç»ç»™å‡ºäº†æ¯”è¾ƒåˆç†çš„è§£é‡Šï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªå…³ç³»å»ç¡®å®šQçŸ©é˜µä¸RçŸ©é˜µã€‚ä¸Šé¢çš„noiseæ˜¯ç™½å™ªå£°ï¼Œbiasä»£è¡¨éšæœºæ¸¸èµ°åå·®ï¼Œä¸ºç™½å™ªå£°çš„ç§¯åˆ†ã€‚</p>

  <p>è¿™é‡Œçš„é—®é¢˜æ˜¯ï¼š<strong>è¿™ä¸ªéƒ¨åˆ†åˆ°åº•æ˜¯ä¸æ˜¯ä¸ºäº†ç¡®å®šQçš„å¤§å°ï¼Ÿ</strong>å…¶å®æˆ‘è§‰å¾—è¿™é‡Œçš„æè¿°æœªå¿…å‡†ç¡®ã€‚</p>

  <p><span style="color:blue;"><strong>è¿™é‡Œç»™å‡ºäº†è¿ç»­ä¸ç¦»æ•£ä¹‹é—´çš„å…³ç³»ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æœ‰ä¸€å±‚å…³ç³»ï¼šç§¯åˆ†ä¸æœªç§¯åˆ†çš„å…³ç³»</strong></span>ã€‚</p>
</blockquote>

<ul>
  <li>åœ¨ä¹‹å‰çš„è®ºæ–‡é‡Œæ˜¯è¿™ä¹ˆåšçš„</li>
</ul>

\[Q_{d}=Q_{c} \Delta t \quad Q_{c}=\text 
{blkdiag}\left(\sigma_{a c c}^{2}\right)\]

<blockquote>
  <p>æˆ‘è§‰å¾—è¿™ä¸ªå’ŒåŠ é€Ÿåº¦è®¡çš„å›ºæœ‰æ€§è´¨ç›¸å…³ã€‚</p>
</blockquote>

<ul>
  <li><a href="https://zhuanlan.zhihu.com/p/71202672">åšå®¢</a>çš„å†…å®¹</li>
</ul>

<p>è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š<span style="color:red;">ä½†æ˜¯è¿™é‡Œæ˜¯ç™½å™ªå£°è¿˜æ˜¯éšæœºæ¸¸èµ°ï¼Ÿ</span>ç†è®ºä¸Šåº”è¯¥æ˜¯ç™½å™ªå£°ï¼Œå› ä¸ºæ²¡æœ‰è®¨è®ºéšæœºæ¸¸èµ°ã€‚
\(\frac{Q_{c}}{\Delta t} *{\Delta t}^{2}=\frac{b l k d i a g\left(\sigma_{g y r o}^{2}\right)}{\Delta t} *{\Delta t^{2}}\)</p>

<ul>
  <li>åœ¨<a href="https://zhuanlan.zhihu.com/p/88756311">åšå®¢</a>ä¸­ï¼Œæåˆ°ä¸€ç§ESKFçš„å§¿æ€è§’åº¦ä¼°è®¡æ–¹æ³•ï¼Œå¯¹äºQçš„æ±‚è§£ï¼Œç»™å‡ºä¸‹é¢çš„ç»“æœï¼š</li>
</ul>

\[\begin{array}{l}
\boldsymbol{V}_{i}=\sigma_{a_{n}}^{2} \Delta t^{2} \boldsymbol{I} \\
\mathbf{\Theta}_{i}=\sigma_{\omega_{n}}^{2} \Delta t^{2} \boldsymbol{I} \\
\boldsymbol{A}_{i}=\sigma_{a_{\omega}}^{2} \Delta t \boldsymbol{I} \\
\boldsymbol{\Omega}_{i}=\sigma_{\omega_{\omega}}^{2} \Delta t \boldsymbol{I}
\end{array}\]

<blockquote>
  <p>ä½†æ˜¯è¿™é‡Œé¢çš„åŠ é€Ÿåº¦è®¡äºé™€èºçš„è¡¨ç¤ºéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ€ä¹ˆè§£é‡Šï¼Ÿ</p>

  <p>è¿™é‡Œæåˆ°äº†ä¸€ä¸ªç§¯åˆ†çš„è¿‡ç¨‹ã€‚</p>
</blockquote>

<p>æ˜¾ç„¶ä¸ä¸Šé¢çš„çŸ›ç›¾ï¼Œè¿™æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>

<h5 id="å¦‚ä½•ç¡®å®šåæ–¹å·®çŸ©é˜µçš„æ›´æ–°">å¦‚ä½•ç¡®å®šåæ–¹å·®çŸ©é˜µçš„æ›´æ–°ï¼Ÿ</h5>

<p>è¦æ¨å¯¼é¢„ç§¯åˆ†é‡çš„åæ–¹å·®ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ imu å™ªå£°å’Œé¢„ç§¯åˆ†é‡ ä¹‹é—´çš„çº¿æ€§é€’æ¨å…³ç³»ã€‚åæ–¹å·®çŸ©é˜µå¯ä»¥è¿™æ ·æ¨å¯¼ï¼š<span style="color:blue;"><strong>è¿™ä¸ªæ–¹å·®çš„ç§¯ç´¯å…¬å¼éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå®é™…ä¸ŠçŠ¶æ€ä¼°è®¡å¤§å¤šéƒ½æ˜¯è¿™ä¹ˆåšçš„ã€‚</strong></span>
\(\boldsymbol{\Sigma}_{i k}=\mathbf{F}_{k-1} \boldsymbol{\Sigma}_{i k-1} \mathbf{F}_{k-1}^{\top}+\mathbf{G}_{k-1} \boldsymbol{\Sigma}_{\mathbf{n}} \mathbf{G}_{k-1}^{\top}\)
å…¶ä¸­ï¼Œ$Î£_n$ æ˜¯æµ‹é‡å™ªå£°çš„åæ–¹å·®çŸ©é˜µï¼Œæ–¹å·®ä» i æ—¶åˆ»å¼€å§‹è¿›è¡Œé€’æ¨ï¼Œ$Î£_{ii} = 0$ã€‚</p>

<p>ä½†æ˜¯åœ¨ä¼ ç»Ÿçš„å¡å°”æ›¼æ»¤æ³¢å™¨çš„é€’æ¨å…¬å¼ä¸­ï¼Œæœ‰ä¸‹é¢çš„ç»“æœï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200621091350.png" alt="20200621091350" style="zoom:50%;" /></p>

<p>åœ¨è¿™é‡Œæ›´æ–°çš„è¿‡ç¨‹å¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ§åˆ¶é‡uçš„é›…å¯æ¯”çŸ©é˜µï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<span style="color:blue;"><strong>å› ä¸ºuçš„é›…å¯æ¯”çŸ©é˜µåªå½±å“åˆ°PçŸ©é˜µçš„æ›´æ–°ï¼Œè€Œå¹¶ä¸å½±å“æ ‡ç§°å€¼çš„æ›´æ–°ã€‚ï¼ˆæ ‡ç§°å€¼çš„æ›´æ–°ä¾èµ–äºæ›´åŠ å‡†ç¡®çš„éçº¿æ€§çŠ¶æ€æ›´æ–°æ–¹ç¨‹ï¼‰</strong></span>ã€‚</p>

<p>è¿™é‡ŒQä»£è¡¨çš„è¿‡ç¨‹è¯¯å·®æ–¹å·®çŸ©é˜µï¼Œå¯¹åº”çš„ç»´åº¦æ˜¯çŠ¶æ€é‡ã€‚åˆ©ç”¨æ§åˆ¶é‡ä¸è¿åŠ¨å­¦æ–¹ç¨‹ï¼Œç¡®å®å¯ä»¥æ±‚å‡ºæ¥çŠ¶æ€é‡çš„è¯¯å·®æ–¹å·®çŸ©é˜µã€‚ç›¸å½“äºçŠ¶æ€é‡çš„æ–¹å·®æœ‰ä¸€éƒ¨åˆ†æ˜¯ç”±æ§åˆ¶é‡å†³å®šçš„ã€‚ä½†æ˜¯å¦‚æœç³»ç»Ÿä¸­æ²¡æœ‰æ§åˆ¶é‡ï¼Œåªæœ‰çŠ¶æ€é‡ï¼Œé‚£ä¹ˆå°±éœ€è¦ç›´æ¥ç»™å‡ºQçŸ©é˜µçš„å€¼ã€‚å®é™…ä¸Šè¿™ç§ç³»ç»Ÿä¹Ÿæ˜¯æ¯”è¾ƒå¤šçš„ã€‚</p>

<p>åœ¨ä¸€ä¸ªå¼€æºé¡¹ç›®ä¸­æ˜¯è¿™æ ·ç¡®å®šQçš„å¤§å°çš„ï¼š</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sGPS</span>     <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="mf">8.8</span><span class="o">*</span><span class="n">dt</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># assume 8.8m/s2 as maximum acceleration, forcing the vehicle
</span><span class="n">sCourse</span>  <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># assume 0.1rad/s as maximum turn rate for the vehicle
</span><span class="n">sVelocity</span><span class="o">=</span> <span class="mf">8.8</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># assume 8.8m/s2 as maximum acceleration, forcing the vehicle
</span><span class="n">sYaw</span>     <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">dt</span> <span class="c1"># assume 1.0rad/s2 as the maximum turn rate acceleration for the vehicle
</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">diag</span><span class="p">([</span><span class="n">sGPS</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sGPS</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sCourse</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sVelocity</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sYaw</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div></div>

<blockquote>
  <p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„Qæ˜¯ç”¨æ¥æè¿°è¿ç»­å¾®åˆ†è¿åŠ¨å­¦æ–¹ç¨‹ä¸­çš„å¾®åˆ†é‡çš„ã€‚å› ä¸ºè¿™é‡Œçš„Qåªæ˜¯åœ¨å®šä¹‰è¯¯å·®é‡çš„è¿‡ç¨‹å™ªå£°ï¼Œæ‰€ä»¥æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚</p>

</blockquote>

<p>æœ€ç»ˆåœ¨MEKF<a href="https://zhuanlan.zhihu.com/p/71202815">çš„åšå®¢ä¸­æ‰¾åˆ°ç­”æ¡ˆ</a>ï¼š</p>

<p>åœ¨æ–‡çŒ®1ä¸­æ‰¾åˆ°ä¸‹é¢çš„ä½è¯ï¼ˆé™„å½•éƒ¨åˆ†ï¼‰ã€‚ä¸‹é¢çš„å·®åˆ†åŒ–æ˜¯åˆ©ç”¨äº†ç¬¬äºŒç§çŠ¶æ€æ–¹ç¨‹çš„é€’æ¨æ–¹æ³•ï¼Œç„¶åè¿›è¡Œç¦»æ•£åŒ–ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623100552.png" alt="20200623100552" style="zoom:25%;" /></p>

<p>ç”±æ­¤ä¾¿å¾—çŸ¥åæ–¹å·®QçŸ©é˜µçš„ç¡®å®šè¿‡ç¨‹ã€‚å®é™…ä¸Š<span style="color:green;"><strong>åœ¨å®éªŒä¸­ï¼Œå¹¶æ²¡æœ‰ç‰¹åˆ«ä¸¥æ ¼çš„å®šä¹‰ï¼Œå®é™…ä¸Šä¸¤ç§éƒ½å¯ä»¥</strong></span>ã€‚å¯¹æ¯”è¯•éªŒç»“æœå‘ç°å…¶å½±å“æ¯”è¾ƒå°ã€‚</p>

<h5 id="å¦‚ä½•å°†è§’åº¦ç§¯åˆ†å·®åˆ†åŒ–è¡¨ç¤º">å¦‚ä½•å°†è§’åº¦ç§¯åˆ†å·®åˆ†åŒ–è¡¨ç¤ºï¼Ÿ</h5>

<p>åœ¨VIOä¸­ï¼Œå¯¹äºIMUçš„å¤„ç†æµç¨‹æ˜¯ï¼šé¢„ç§¯åˆ†â€“é¢„ç§¯åˆ†çš„ç¦»æ•£å½¢å¼â€“æ¨å¯¼é¢„ç§¯åˆ†çš„æ–¹å·®ã€‚</p>

<table>
  <thead>
    <tr>
      <th>ç±»åˆ«</th>
      <th>æ–¹æ³•</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>åšä¸»</td>
      <td>å·®åˆ†åŒ–â€“&gt;ç¦»æ•£åŒ–</td>
    </tr>
    <tr>
      <td>VIO</td>
      <td>ç¦»æ•£åŒ–â€“&gt;å·®åˆ†åŒ–</td>
    </tr>
    <tr>
      <td>Â </td>
      <td><span style="color:blue;"><strong>å®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼šç¦»æ•£åŒ–ï¼Œå·®åˆ†åŒ–ã€‚è™½ç„¶éƒ½ä¸æ˜¯<br />ä»€ä¹ˆå¤æ‚çš„æ•°å­¦ç†è®ºï¼Œä½†æ˜¯å¸¸å¸¸è®©äººæ„Ÿåˆ°confused</strong></span></td>
    </tr>
  </tbody>
</table>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619081139836.png" alt="image-20200619081139836" /></p>

<blockquote>
  <p>å®é™…ä¸ŠIMUç»„ä»¶ç»™ç³»ç»Ÿç³»ç»Ÿçš„è¿åŠ¨å­¦æ–¹ç¨‹ï¼Œåœ¨çŠ¶æ€ä¼°è®¡ä¸­å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§çº¦æŸã€‚åŒæ—¶æµ‹é‡æ–¹ç¨‹ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯å¦å¤–ä¸€ç§çº¦æŸã€‚</p>

  <p>åœ¨ä¼˜åŒ–ç³»ç»Ÿä¸­ï¼Œå°†è¿™ä¸¤ç§çº¦æŸéƒ½å†™å…¥åˆ°ä¼˜åŒ–å‡½æ•°ä¸­ï¼Œå¹¶ä¸”ä¿è¯æƒ©ç½šå‡½æ•°æ˜¯çº¿æ€§çš„ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨æ¢¯åº¦ä¸‹é™æ³•ç®€å•æ±‚è§£äº†ã€‚</p>
</blockquote>

<table>
  <thead>
    <tr>
      <th>ç±»åˆ«</th>
      <th>æ–¹æ³•</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>åŸºäºä¸€é˜¶æ³°å‹’å±•å¼€è¯¯å·®é€’æ¨æ–¹ç¨‹ï¼šæ–¹æ³•1</td>
      <td>ç¦»æ•£åŒ–â€“&gt;å·®åˆ†åŒ–</td>
    </tr>
    <tr>
      <td>åŸºäºè¯¯å·®éšæ—¶é—´å˜åŒ–çš„é€’æ¨æ–¹ç¨‹ï¼šæ–¹æ³•2</td>
      <td>å·®åˆ†åŒ–â€“&gt;ç¦»æ•£åŒ–</td>
    </tr>
    <tr>
      <td>å¤‡æ³¨</td>
      <td><span style="color:blue;"><strong>å®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªéƒ¨åˆ†ï¼šç¦»æ•£åŒ–ï¼Œå·®åˆ†åŒ–ã€‚è™½ç„¶éƒ½ä¸æ˜¯<br />ä»€ä¹ˆå¤æ‚çš„æ•°å­¦ç†è®ºï¼Œä½†æ˜¯å¸¸å¸¸è®©äººæ„Ÿåˆ°confused<br />å¦å¤–ï¼Œå·®åˆ†åŒ–å°±æ˜¯å°†å…¶å†™æˆè¯¯å·®çŠ¶æ€çš„å½¢å¼</strong></span></td>
    </tr>
  </tbody>
</table>

<p>ä½†æ˜¯å› ä¸ºæ–¹æ³•2ä¸­éœ€è¦çŸ¥é“çŠ¶æ€é‡çš„è¿ç»­å¯¼æ•°å…³ç³»ï¼ˆéšæ—¶é—´å˜åŒ–çš„å…³ç³»ï¼‰ï¼Œå¾ˆå¤šç³»ç»Ÿéƒ½æ²¡åŠæ³•æ±‚è§£è¿™éƒ¨åˆ†ï¼ˆåœ¨PVQç³»ç»Ÿä¸­å¯ä»¥åšï¼‰ã€‚æ–¹æ³•1ä¸­çš„ç¦»æ•£å½¢å¼æ¯”è¾ƒç¬¦åˆå¯¹EKFçš„è§£é‡Šå’ŒEKFä¸­åæ–¹å·®æ›´æ–°çš„æ–¹æ³•ï¼Œå› æ­¤æ›´åŠ å¸¸ç”¨ã€‚</p>

<p><span style="color:blue;"><strong>æ€»ç»“æ¥è¯´ï¼Œå¦‚æœç³»ç»Ÿæ˜¯è¿ç»­æ–¹ç¨‹ï¼Œé‚£ä¹ˆéœ€è¦å…ˆè¿›è¡Œerror stateåŒ–ä¹‹åå†è¿›è¡Œç¦»æ•£åŒ–ã€‚å¦‚æœç³»ç»Ÿæ˜¯ç¦»æ•£æ–¹ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥è¿›è¡Œerror stateåŒ–å³å¯</strong></span>ã€‚</p>

<p>ä¸‹é¢æ˜¯è¯¦ç»†å®šä¹‰ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619092634104.png" alt="image-20200619092634104" /></p>

<p><span style="color:blue;"><strong>äºæ˜¯æœ‰ä¸‹é¢çš„ç»“æœï¼Œè¿™é‡Œçš„å˜åŒ–å¾ˆé‡è¦</strong></span>ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200619092641.png" alt="20200619092641" /></p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200619092726511.png" alt="image-20200619092726511" /></p>

<h5 id="ä½†æ˜¯æœ€åä¸€æ­¥æ˜¯æ€ä¹ˆæ¨å¯¼çš„">ä½†æ˜¯æœ€åä¸€æ­¥æ˜¯æ€ä¹ˆæ¨å¯¼çš„ï¼Ÿ</h5>

<p>åœ¨ä¸Šé¢çš„ä¸¤ç§æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€ç§æ˜¯ç¬¦åˆEKFçš„çŠ¶æ€æ–¹ç¨‹çš„é€’æ¨å…³ç³»çš„ï¼›ç¬¬äºŒç§æ˜¯ç›®å‰VIOç®—æ³•ä¸­çš„ä¸»æµåšæ³•ã€‚åº”è¯¥æ˜¯æ®Šé€”åŒå½’çš„ä¸¤ç§åšæ³•ï¼Œä½†æ˜¯ç¬¬ä¸€ç§æ›´ä¸ºé€šç”¨ã€‚</p>

<p><span style="color:red;">ä¸‹é¢çš„æ¨å¯¼æ˜¯æ€ä¹ˆå®Œæˆçš„</span>ï¼Ÿ
\(\begin{array}{l}
\dot{\delta \mathbf{v}}=\mathbf{R} \delta \mathbf{a}^{b}+\mathbf{R}[\delta \boldsymbol{\theta}]_{\times}\left(\mathbf{a}^{b}+\delta \mathbf{a}^{b}\right)+\delta \mathbf{g} \\
\dot{\delta \mathbf{v}}=\mathbf{R} \delta \mathbf{a}^{\mathbf{b}}-\mathbf{R}\left[\mathbf{a}^{b}\right]_{\times} \delta \boldsymbol{\theta}+\delta \mathbf{g}
\end{array}\)</p>

<p>æœ€ç¬¦åˆé€»è¾‘çš„å°±æ˜¯ï¼š<span style="color:red;"><strong>ä¸¤ä¸ªå°é‡ç›¸ä¹˜ï¼Œæœ€åçš„ç»“æœå°±æ˜¯æ— ç©·å°ï¼Œå¯ä»¥å¿½ç•¥</strong></span>ã€‚</p>

<p>ä¸ESKFçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸‹é¢ç»™å‡ºESKFçš„å®šä¹‰ã€‚
\(\dot{\delta \mathbf{v}}=-\mathbf{R}\left[\mathbf{a}_{m}-\mathbf{a}_{b}\right]_{\times} \delta \boldsymbol{\theta}-\mathbf{R} \delta \mathbf{a}_{b}+\delta \mathbf{g}-\mathbf{R} \mathbf{a}_{n}\)
ä½†æ˜¯å¦‚ä½•æ¯”è¾ƒä¸¤è€…çš„åŒºåˆ«ï¼Ÿæœ‰å¾…åç»­å®Œæˆã€‚</p>

<h5 id="ä¸ºä»€ä¹ˆè¦ç”¨è¯¯å·®çŠ¶æ€é‡å»è¡¨ç¤ºå‘¢">ä¸ºä»€ä¹ˆè¦ç”¨è¯¯å·®çŠ¶æ€é‡å»è¡¨ç¤ºå‘¢ï¼Ÿ</h5>

<p>è¿™éƒ¨åˆ†å‚è€ƒQuaternion kinematics for the error-state Kalman filte<a href="https://zhuanlan.zhihu.com/p/88756311">å’Œåšå®¢</a>ã€‚</p>

<ul>
  <li>å®šå‘è¯¯å·®çŠ¶æ€æ˜¯æœ€å°çš„ï¼Œé¿å…äº†ä¸è¿‡åº¦å‚æ•°åŒ–ç›¸å…³çš„é—®é¢˜ï¼Œä»¥åŠç›¸å…³åæ–¹å·®çŸ©é˜µå¥‡å¼‚æ€§çš„é£é™©ï¼Œè¿™é€šå¸¸æ˜¯ç”±å¼ºåˆ¶çº¦æŸå¼•èµ·çš„</li>
  <li>è¯¯å·®çŠ¶æ€ç³»ç»Ÿæ€»æ˜¯åœ¨æ¥è¿‘åŸå§‹ç³»ç»Ÿçš„æƒ…å†µä¸‹è¿è¡Œï¼Œå› æ­¤è¿œç¦»å¯èƒ½çš„å‚æ•°å¥‡ç‚¹ã€ä¸‡å‘é”é—®é¢˜ç­‰ï¼Œä»è€Œä¿è¯çº¿æ€§åŒ–çš„æœ‰æ•ˆæ€§å§‹ç»ˆä¿æŒä¸å˜</li>
  <li>é”™è¯¯çŠ¶æ€æ€»æ˜¯å¾ˆå°ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰äºŒé˜¶éƒ¨åˆ†éƒ½å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è¿™ä½¿å¾—é›…å¯æ¯”çŸ©é˜µçš„è®¡ç®—å˜å¾—éå¸¸ç®€å•å’Œå¿«é€Ÿã€‚æœ‰äº›é›…å¯æ¯”æ•°ç”šè‡³å¯èƒ½æ˜¯å¸¸æ•°æˆ–ç­‰äºå¯ç”¨çŠ¶æ€é‡ã€‚</li>
  <li>è¯¯å·®åŠ¨åŠ›å­¦æ˜¯ç¼“æ…¢çš„ï¼Œå› ä¸ºæ‰€æœ‰çš„å¤§ä¿¡å·åŠ¨åŠ›å­¦éƒ½å·²é›†æˆåˆ°æ ‡ç§°çŠ¶æ€ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä»¥ä½äºé¢„æµ‹çš„é€Ÿåº¦åº”ç”¨KFä¿®æ­£</li>
</ul>

<blockquote>
  <p>ä»€ä¹ˆæ˜¯åŠ¨åŠ›å­¦æ˜¯ç¼“æ…¢çš„ï¼Ÿå˜åŒ–æ˜¯ç¼“æ…¢çš„ï¼Ÿ</p>
</blockquote>

<blockquote>
  <p><span style="color:green;"><strong>æ˜¯ä¸æ˜¯ç”¨æ¥æè¿°æŒ¯åŠ¨å˜åŒ–ï¼Œæœ‰ç€æ›´ä¸ºå‡ºè‰²çš„æ€§èƒ½</strong></span>ï¼Ÿå¦‚æœæ˜¯çš„è¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¯ä»¥å‘è®ºæ–‡çš„ç‚¹ã€‚</p>

  <p>æ˜¯ä¸æ˜¯å’Œæä»£æ•°å»è¡¨ç¤ºæ˜¯æœ‰å…³ç³»çš„ï¼Œåªæœ‰åœ¨å°é‡çš„æ—¶å€™ï¼Œåœ¨åˆ‡ç©ºé—´çš„æ€§è´¨æ‰å¯ä»¥æˆç«‹ã€‚</p>
</blockquote>

<h5 id="æ˜¯å¦‚ä½•å°†è¯¯å·®çŠ¶æ€ä¸æ§åˆ¶é‡ç›¸ç»“åˆçš„">æ˜¯å¦‚ä½•å°†è¯¯å·®çŠ¶æ€ä¸æ§åˆ¶é‡ç›¸ç»“åˆçš„ï¼Ÿ</h5>

<p>è§’é€Ÿåº¦ç§¯åˆ†è¡¨ç¤ºï¼š
\(\begin{aligned}
_{I}^{G} \dot{\boldsymbol{R}} &amp;=_{I}^{G} \boldsymbol{R}\left[\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}-\boldsymbol{n}_{w}\right] \times \\
\dot{\boldsymbol{b}}_{g} &amp;=\mathbf{0}+\boldsymbol{n}_{g}
\end{aligned}\)
ä¸‹é¢æ˜¯æ—‹è½¬çŸ©é˜µçš„ç§¯åˆ†è¿‡ç¨‹ï¼š
\(\frac{\mathrm{d} \mathbf{R}}{\mathrm{d} t}=\mathbf{R}[\boldsymbol{\omega}]_{\times}\)
å¾—åˆ°ç¦»æ•£åŒ–ä¹‹åçš„ï¼š
\(\mathbf{R}(t+\Delta t)=\mathbf{R}(t) e^{[\omega]_{\times} \Delta t}\)</p>

<p>å‚è€ƒEKF-Based IMU Orientation Estimationï¼Œæœ‰ä¸‹é¢çš„è¿åŠ¨å­¦æ–¹ç¨‹ï¼š
\(\begin{aligned}
\delta \boldsymbol{\theta} &amp;=\operatorname{Exp}\left[\left(\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}\right) \Delta t\right]^{T} \delta \boldsymbol{\theta}-\delta \boldsymbol{b}_{g} \Delta t+\boldsymbol{\theta}_{i} \\
\delta \boldsymbol{b}_{g} &amp;=\delta \boldsymbol{b}_{g}+\boldsymbol{\omega}_{i}
\end{aligned}\)
è¡¨ç¤ºä¸ºï¼š
\(\left[\begin{array}{c}
\delta \boldsymbol{\theta} \\
\delta \boldsymbol{b}_{g}
\end{array}\right]=\underbrace{\left[\begin{array}{cc}
\operatorname{Exp}\left[\left(\boldsymbol{\omega}_{m}-\boldsymbol{b}_{g}\right) \Delta t\right]^{T} &amp; -\boldsymbol{I} \Delta t \\
\boldsymbol{0} &amp; \boldsymbol{I}
\end{array}\right]}_{\boldsymbol{F}_{\boldsymbol{x}}}\left[\begin{array}{c}
\boldsymbol{\delta} \boldsymbol{\theta} \\
\delta \boldsymbol{b}_{g}
\end{array}\right]+\underbrace{\left[\begin{array}{cc}
\boldsymbol{I} &amp; \boldsymbol{0} \\
\boldsymbol{0} &amp; \boldsymbol{I}
\end{array}\right]}_{\boldsymbol{F}_{i}}\left[\begin{array}{c}
\boldsymbol{\theta}_{i} \\
\boldsymbol{\omega}_{i}
\end{array}\right]\)</p>

<p>è¿™é‡Œå…¶å®å°±è¯´æ˜äº†ï¼šsitaä¸delta_sitaçš„æ–¹å·®çš„å¯¹åº”å…³ç³»ã€‚</p>

<h5 id="å››å…ƒæ•°çš„è¿ç®—æ˜¯ä»€ä¹ˆæ ·çš„">å››å…ƒæ•°çš„è¿ç®—æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</h5>

<p>å››å…ƒæ•°ç›¸ä¹˜å¯ä»¥å†™æˆï¼š
\(\mathbf{q}_{1} \otimes \mathbf{q}_{2}=[\mathbf{q}]_{L} \mathbf{q}_{2}=[\mathbf{q}]_{R} \mathbf{q}\)
å…¶ä¸­
\([\mathbf{q}]_{L}=\left[\begin{array}{cccc}
q_{w} &amp; -q_{x} &amp; -q_{y} &amp; -q_{z} \\
q_{x} &amp; q_{w} &amp; -q_{z} &amp; q_{y} \\
q_{y} &amp; q_{z} &amp; q_{w} &amp; -q_{x} \\
q_{z} &amp; -q_{y} &amp; q_{x} &amp; q_{w}
\end{array}\right]=q_{w} \mathbf{I}+\left[\begin{array}{cc}
0 &amp; -\mathbf{q}_{v}^{\mathrm{T}} \\
\mathbf{q}_{v} &amp; {\left[\mathbf{q}_{v}\right]_{\times}}
\end{array}\right]\)</p>

<h5 id="æœ€åä¸€ç‚¹å››å…ƒæ•°ä¸æä»£æ•°ä¹‹é—´çš„å…³ç³»">æœ€åä¸€ç‚¹ï¼šå››å…ƒæ•°ä¸æä»£æ•°ä¹‹é—´çš„å…³ç³»ï¼Ÿ</h5>

<ol>
  <li>é¦–å…ˆæ˜¯æä»£æ•°çš„éƒ¨åˆ†ï¼š</li>
</ol>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622104950178.png" alt="image-20200622104950178" /></p>

<ol>
  <li>å…¶æ¬¡æ˜¯ç½—å¾·é‡Œæ ¼æ–¯æ—‹è½¬å…¬å¼ï¼š</li>
</ol>

\[\mathbf{R}=\mathbf{I}+\sin \phi[\mathbf{u}]_{\times}+(1-\cos \phi)[\mathbf{u}]_{\times}^{2}\]

<ol>
  <li>æè¿°æ—‹è½¬ç¾¤ä¸å››å…ƒæ•°ä¹‹é—´çš„å…³ç³»ï¼šå‚è€ƒæ–‡çŒ®<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote">1</a></sup>çš„ 4.2.2</li>
</ol>

<h4 id="eskfæ€»ç»“é™ˆè¿°">ESKFæ€»ç»“é™ˆè¿°</h4>

<p>ESKFå°±æ˜¯ç”¨äº†ä¸Šè¿°â€œåŸºäºè¯¯å·®éšæ—¶é—´å˜åŒ–â€æ±‚è§£æ–¹æ³•ï¼Œé¦–å…ˆå†™æˆerror stateï¼Œç„¶åè¿›è¡Œç¦»æ•£åŒ–å¾—åˆ°IMUçš„é€’æ¨æ–¹ç¨‹ã€‚/</p>

<p>å‚æ•°è¡¨å¦‚ä¸‹ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200622112302.png" alt="20200622112302" /></p>

<table>
  <thead>
    <tr>
      <th>English</th>
      <th>ä¸­æ–‡</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>nominal state</td>
      <td>æ ‡ç§°çŠ¶æ€</td>
    </tr>
    <tr>
      <td>true state</td>
      <td>çœŸå®çŠ¶æ€</td>
    </tr>
    <tr>
      <td>error state</td>
      <td>è¯¯å·®çŠ¶æ€</td>
    </tr>
  </tbody>
</table>

<h5 id="é¦–å…ˆæ˜¯è¿åŠ¨å­¦æ–¹ç¨‹ä¸­">é¦–å…ˆæ˜¯è¿åŠ¨å­¦æ–¹ç¨‹ä¸­ï¼š</h5>

<p>ç»™å‡ºä¸‹é¢ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622084611877.png" alt="image-20200622084611877" /></p>

<p>å…¶ä¸­ ğœƒğ‘– ğ‘¤ğ‘– ä¸ºé«˜æ–¯éšæœºè„‰å†²å™ªå£°ï¼Œå‡å€¼ä¸º0ï¼Œåæ–¹å·®ä¸º ğ‘¤ğ‘› ï¼Œğ‘¤ğ‘ğ‘› åœ¨ ğ›¥ğ‘¡æ—¶é—´å†…çš„ç§¯åˆ†å€¼ã€‚</p>

<p>å› æ­¤ç»™å‡ºè¯¯å·®ä¼ æ’­æ–¹ç¨‹ï¼š
\(\begin{aligned}
\delta \mathbf{p} &amp; \leftarrow \delta \mathbf{p}+\delta \mathbf{v} \Delta t \\
\delta \mathbf{v} &amp; \leftarrow \delta \mathbf{v}+\left(-\mathbf{R}\left[\mathbf{a}_{m}-\mathbf{a}_{b}\right]_{\times} \delta \boldsymbol{\theta}-\mathbf{R} \delta \mathbf{a}_{b}+\delta \mathbf{g}\right) \Delta t+\mathbf{v}_{\mathbf{i}} \\
\delta \boldsymbol{\theta} &amp; \leftarrow \mathbf{R}^{\top}\left\{\left(\boldsymbol{\omega}_{m}-\boldsymbol{\omega}_{b}\right) \Delta t\right\} \delta \boldsymbol{\theta}-\delta \boldsymbol{\omega}_{b} \Delta t+\boldsymbol{\theta}_{\mathbf{i}} \\
\delta \mathbf{a}_{b} &amp; \leftarrow \delta \mathbf{a}_{b}+\mathbf{a}_{\mathbf{i}} \\
\delta \boldsymbol{\omega}_{b} &amp; \leftarrow \delta \boldsymbol{\omega}_{b}+\boldsymbol{\omega}_{\mathbf{i}} \\
\delta \mathbf{g} &amp; \leftarrow \delta \mathbf{g}
\end{aligned}\)</p>

<h5 id="å…¶æ¬¡æ˜¯æµ‹é‡æ–¹ç¨‹">å…¶æ¬¡æ˜¯æµ‹é‡æ–¹ç¨‹ï¼š</h5>

<p>æµ‹é‡æ–¹ç¨‹æ±‚å–é›…å¯æ¯”çŸ©é˜µé‡‡ç”¨é“¾å¼æ³•åˆ™ã€‚</p>

<p>æ­¤å¤–æœ‰ï¼š</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/image-20200622084626045.png" alt="image-20200622084626045" />
\(\left.\mathbf{X}_{\delta \mathbf{x}} \triangleq \frac{\partial \mathbf{x}_{t}}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\left[\begin{array}{ccc}
\mathbf{I}_{6} &amp; 0 &amp; 0 \\
0 &amp; \mathbf{Q}_{\delta \boldsymbol{\theta}} &amp; 0 \\
0 &amp; 0 &amp; \mathbf{I}_{9}
\end{array}\right]\)
æ€»ç»“æ¥è¯´ï¼Œæ±‚å–å·®åˆ†çš„åå¯¼æ•°å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ç”¨åˆ°çš„æ˜¯å·¦æ çš„ç»“æœï¼Œå³æ ä¸­æœªä½œè€ƒè™‘ã€‚</p>

<p><img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623093941.png" alt="20200623093941" /></p>

<h5 id="å…¶ä¸­æœ‰æ¯”è¾ƒé‡è¦çš„æ¨å¯¼æ–¹æ³•">å…¶ä¸­æœ‰æ¯”è¾ƒé‡è¦çš„æ¨å¯¼æ–¹æ³•</h5>

<p>ä¸‹é¢æ˜¯ä¸¤ç§é“¾å¼æ±‚å¯¼çš„æ–¹æ³•ï¼Œæ¯”è¾ƒé‡è¦ã€‚
\(\left.\mathbf{H} \triangleq \frac{\partial h}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\left.\left.\frac{\partial h}{\partial \mathbf{x}_{t}}\right|_{\mathbf{x}} \frac{\partial \mathbf{x}_{t}}{\partial \delta \mathbf{x}}\right|_{\mathbf{x}}=\mathbf{H}_{\mathbf{x}} \mathbf{X}_{\delta \mathbf{x}}\)</p>

\[\left.\mathbf{Q}_{\delta \boldsymbol{\theta}} \triangleq \frac{\partial(\mathbf{q} \otimes \delta \mathbf{q})}{\partial \delta \boldsymbol{\theta}}\right|_{\mathbf{q}}=\left.\left.\frac{\partial(\mathbf{q} \otimes \delta \mathbf{q})}{\partial \delta \mathbf{q}}\right|_{\mathbf{q}} \frac{\partial \delta \mathbf{q}}{\partial \delta \boldsymbol{\theta}}\right|_{\hat{\delta} \hat{\theta}=0}\]

<p><span style="color:blue;"><strong>å¦å¤–ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œåœ¨å…¶ä¸­çš„æ—‹è½¬çŸ©é˜µè¡¨ç¤ºä¸º</strong></span>ï¼š</p>

<p>å…¶ä¸­ç‰¹åˆ«è¦æ³¨æ„å››å…ƒæ•°çš„æ—‹è½¬æ–¹å¼ã€‚
\(R=_{b}^{w}R=Exp[_{I}^{G}\delta\theta]=_{I}^{G}\delta q\)
<img src="https://chendaxiashizhu-1259416116.cos.ap-beijing.myqcloud.com/20200623140517.png" alt="20200623140517" /></p>

<blockquote>
  <p>æ€»ä½“æ¥è¯´ï¼Œéœ€è¦åŒºåˆ†æ ‡ç§°å€¼ä¸è¯¯å·®çŠ¶æ€é‡ä¹‹é—´çš„å…³ç³»ã€‚</p>
</blockquote>

<p>cvä¸­çš„3dæ ‡å®šï¼š<span style="color:blue;"><strong>T21 = Tbw = 2d2d(pw,pb) = 2d2d(p1,p2)</strong></span></p>

<h5 id="æ¬§æ‹‰è§’çš„è¡¨ç¤º">æ¬§æ‹‰è§’çš„è¡¨ç¤º</h5>

<p><span style="color:blue;"><strong>å¦å¤–ï¼Œè§‚å¯Ÿåˆ°qä¸Réƒ½æ˜¯æœ‰æ–¹å‘çš„ï¼Œé‚£ä¹ˆæ¬§æ‹‰è§’æœ‰æ²¡æœ‰æ–¹å‘å‘¢ï¼Ÿ</strong></span>äº‹å®è¯æ˜æ˜¯æœ‰çš„ã€‚</p>

<p><img src="/Users/chenshiming/Library/Application%20Support/typora-user-images/image-20200625102854467.png" alt="image-20200625102854467" /></p>

<p>å…¶ä¸­ï¼ŒWæ˜¯å¯é€†çŸ©é˜µï¼Œè¿™é‡Œè¯´æ˜äº†æ¬§æ‹‰è§’ä¹Ÿæ˜¯å­˜åœ¨æ–¹å‘çš„ã€‚ä¸Šé¢è¯´æ˜äº†eulerRatesä¸bodyRatesä¹‹é—´çš„å…³ç³»ï¼Œä¸‹é¢è¡¨ç¤ºäº†é€†çŸ©é˜µã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">cr</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">roll</span><span class="p">);</span>
 <span class="n">sr</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">roll</span><span class="p">);</span>
 <span class="n">cp</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">pitch</span><span class="p">);</span>
 <span class="n">sp</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">pitch</span><span class="p">);</span>
<span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">sp</span><span class="p">;</span>
    <span class="mi">0</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">cp</span><span class="p">;</span>
    <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">sr</span><span class="p">,</span> <span class="n">cr</span> <span class="o">*</span> <span class="n">cp</span><span class="p">];</span>
</code></pre></div></div>

<h5 id="å››å…ƒæ•°ä¸­å‚ä¸çš„è¿ç®—">å››å…ƒæ•°ä¸­å‚ä¸çš„è¿ç®—</h5>

<h4 id="eskfçš„å®ç°">ESKFçš„å®ç°</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span> <span class="o">=========================================================================</span>
<span class="o">%</span>
<span class="o">%</span>                  <span class="n">ESKFçš„å®ç°</span>
<span class="o">%</span> 
<span class="o">%</span>
<span class="o">%</span> <span class="o">=========================================================================</span>
<span class="o">%</span>
<span class="o">%</span><span class="err">ã€€</span><span class="p">(</span><span class="n">C</span><span class="p">)</span><span class="mi">2020</span><span class="o">-</span><span class="mi">2022</span> <span class="n">China</span> <span class="n">Academy</span> <span class="n">of</span> <span class="n">Railway</span> <span class="n">Sciences</span> 
<span class="o">%</span>   <span class="n">ç‰ˆæœ¬</span><span class="err">ï¼š</span><span class="n">V1</span><span class="p">.</span><span class="mi">0</span>
<span class="o">%</span>   <span class="n">æ—¥æœŸ</span><span class="err">ï¼š</span><span class="mi">2020</span><span class="n">å¹´</span> <span class="mi">6</span><span class="n">æœˆ23æ—¥</span>
<span class="o">%</span>   <span class="n">ä½œè€…</span><span class="err">ï¼š</span><span class="n">s</span><span class="p">.</span><span class="n">m</span><span class="p">.</span>
<span class="o">%--------------------------------------------------------------------------</span>
<span class="o">%</span>  <span class="n">åŠŸèƒ½</span><span class="err">ï¼š</span><span class="mf">1.</span><span class="n">å®ç°ESKFç®—æ³•</span><span class="err">ï¼Œ</span><span class="n">åŠ æ·±å¯¹äºçŠ¶æ€ä¼°è®¡çš„ç†è§£</span>
<span class="o">%</span>        <span class="mf">2.</span><span class="n">å…¶ä¸­çš„é—®é¢˜</span><span class="err">ï¼š</span>
<span class="o">%</span>     <span class="mi">1</span><span class="err">ï¼‰</span> <span class="n">æµ‹é‡åŠ ä¸Šåœ°ç£è®¡</span>
<span class="o">%</span>     <span class="mi">2</span><span class="err">ï¼‰</span> <span class="n">æ³¨æ„è¯¯å·®é‡ä¸æ ‡ç§°é‡</span>
<span class="o">%</span>     <span class="mi">3</span><span class="err">ï¼‰</span> <span class="n">å››å…ƒæ•°è½¬è§’åº¦æ—¶æœ‰è¯¯å·®</span><span class="err">ï¼Œ</span><span class="n">å°±æ˜¯è¿™ä¸ªå¯¼è‡´äº†è¯¯å·®é‡</span>
<span class="o">%</span>
<span class="o">%</span>
<span class="o">%</span>
<span class="o">%--------------------------------------------------------------------------</span>
<span class="n">clear</span> <span class="nb">all</span><span class="p">;</span>
<span class="n">close</span> <span class="nb">all</span><span class="p">;</span>
<span class="n">addpath</span><span class="p">(</span><span class="s">'../../ESKF-Attitude-Estimation-master'</span><span class="p">)</span>
<span class="n">addpath</span><span class="p">(</span><span class="s">'../utils'</span><span class="p">)</span>
<span class="o">%</span> <span class="o">--------------------</span> <span class="kn">import</span> <span class="nn">data</span><span class="o">-------------------</span>
<span class="n">fileName</span> <span class="o">=</span> <span class="s">'../NAV_1'</span><span class="p">;</span>
<span class="n">Data</span> <span class="o">=</span> <span class="n">importdata</span><span class="p">(</span><span class="n">sprintf</span><span class="p">(</span><span class="s">'%s.mat'</span><span class="p">,</span><span class="n">fileName</span><span class="p">));</span>
<span class="n">lengthtp</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">Data</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

<span class="n">time</span>    <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">roll</span>    <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">pitch</span>   <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">yaw</span>     <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">lengthtp</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">imuNominalStates</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthtp</span><span class="p">);</span>
<span class="n">imuErrorStates</span>   <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthtp</span><span class="p">);</span>
<span class="n">measurements</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">lengthtp</span><span class="p">);</span>
<span class="o">%</span><span class="n">groundTruth</span>
<span class="k">for</span> <span class="n">state_k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">lengthtp</span> 
    <span class="n">measurements</span><span class="p">{</span><span class="n">state_k</span><span class="p">}.</span><span class="n">dt</span>    <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span>                      <span class="o">%</span> <span class="n">sampling</span> <span class="n">times</span> <span class="mi">50</span><span class="n">Hz</span>
    <span class="n">measurements</span><span class="p">{</span><span class="n">state_k</span><span class="p">}.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">state_k</span><span class="p">,</span><span class="mi">27</span><span class="p">:</span><span class="mi">29</span><span class="p">)</span><span class="s">';            
    measurements{state_k}.acc   = Data(state_k,9:11)'</span><span class="p">;</span>
    <span class="n">measurements</span><span class="p">{</span><span class="n">state_k</span><span class="p">}.</span><span class="n">mag</span>   <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">state_k</span><span class="p">,</span><span class="mi">15</span><span class="p">:</span><span class="mi">17</span><span class="p">)</span><span class="s">';
    time(state_k)=state_k*0.02;
end
rad2deg = 180/pi;
rollRef   = Data(:,30)*rad2deg;
pitchRef  = Data(:,31)*rad2deg;
yawRef    = Data(:,32)*rad2deg;
% --------------------Data analysis------------------
% ++++++++++++++++++++1.initialization++++++++++++++++
dt = measurements{1}.dt;

% æ€ä¹ˆå¤„ç†åˆå§‹åŒ–çš„thetaï¼Ÿ
omega_b = zeros(3,1);%%è¿™ä¸ªç”¨åˆ°
theta = zeros(3,1);%%è¿™ä¸ªç”¨ä¸åˆ°

% error state initialization
dt_theta = zeros(3,1);
dt_omega_b = zeros(3,1);

% Keep updated status
err_state = [dt_theta;dt_omega_b];
quat = zeros(4,1);

% --------Refer to previous practice for initialization-----------------------------------
init_angle = [Data(1,30),Data(1,31),Data(1,32)]'</span><span class="p">;</span>
<span class="n">init_quat</span> <span class="o">=</span> <span class="n">oula2q</span><span class="p">(</span><span class="n">init_angle</span><span class="p">);</span>
<span class="n">quat</span> <span class="o">=</span> <span class="n">init_quat</span><span class="s">';
% -------------------------2.covariance matrix ---------------------
p1 = 1e-5;p2 =  1e-7;
P = blkdiag(p1,p1,p1,p2,p2,p2);%%åˆå§‹åŒ–

sigma_wn = 1e-5;
sigma_wbn = 1e-9;
Theta_i = sigma_wn*dt^2*eye(3);
Omega_i = sigma_wbn*dt^2*eye(3);
Fi = eye(6);
Qi = blkdiag(Theta_i , Omega_i);
Q = Fi*Qi*Fi'</span><span class="p">;</span>

<span class="n">sigma_acc</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">;</span>
<span class="n">sigma_mn</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">;</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">blkdiag</span><span class="p">(</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sigma_acc</span><span class="p">,</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">sigma_mn</span><span class="p">);</span>
<span class="k">for</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">lengthtp</span><span class="o">-</span><span class="mi">1</span>
    <span class="o">%</span> <span class="o">--------------------------</span><span class="n">forecast</span><span class="o">------------</span>
    <span class="n">omega_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">}.</span><span class="n">omega</span> <span class="o">+</span> <span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="p">}.</span><span class="n">omega</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">av</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega_m</span> <span class="o">-</span> <span class="n">omega_b</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">;</span>
     <span class="n">det_q</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">;</span><span class="mf">0.5</span><span class="o">*</span><span class="n">av</span><span class="p">];</span>
     <span class="n">quat</span> <span class="o">=</span> <span class="n">quatLeftComp</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span><span class="o">*</span><span class="n">det_q</span><span class="p">;</span>
     <span class="n">omega_b</span> <span class="o">=</span> <span class="n">omega_b</span><span class="p">;</span>
     <span class="o">%</span> <span class="n">è®¡ç®—æ ‡ç§°å€¼</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="n">Exp_lee</span><span class="p">((</span><span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">}.</span><span class="n">omega</span> <span class="o">-</span> <span class="n">omega_b</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">);</span>
    <span class="n">F1</span> <span class="o">=</span> <span class="n">F1</span><span class="s">';
    Fx = [F1  , -eye(3)*dt;
    zeros(3)  , eye(3)];
     P_ = Fx*P*Fx'</span> <span class="o">+</span> <span class="n">Q</span><span class="p">;</span>
     <span class="o">%</span> <span class="o">-----------------------</span><span class="n">observation</span><span class="o">---------------------</span>
     <span class="o">%</span> <span class="n">Prediction</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">observations</span>
     <span class="p">[</span><span class="n">H</span><span class="p">,</span><span class="n">detZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">calH</span><span class="p">(</span><span class="n">quat</span><span class="p">,</span>  <span class="n">measurements</span><span class="p">{</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">});</span>
     <span class="o">%</span> <span class="o">--------------------</span><span class="n">update</span><span class="o">-----------------</span>
     <span class="n">K</span> <span class="o">=</span> <span class="n">P_</span><span class="o">*</span><span class="n">H</span><span class="s">'*inv(H*P_*H'</span> <span class="o">+</span> <span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
     <span class="n">err_state</span> <span class="o">=</span> <span class="n">K</span><span class="o">*</span><span class="n">detZ</span><span class="p">;</span>
     <span class="n">P</span> <span class="o">=</span> <span class="n">P_</span> <span class="o">-</span> <span class="n">K</span><span class="o">*</span><span class="p">(</span><span class="n">H</span><span class="o">*</span><span class="n">P_</span><span class="o">*</span><span class="n">H</span><span class="s">' + R)*K'</span><span class="p">;</span>
     <span class="o">%</span> <span class="o">----------------------</span><span class="n">update</span> <span class="n">state</span><span class="o">----------------------</span>
     <span class="o">%</span> <span class="n">å‚è€ƒä¹‹å‰çš„å‡½æ•°</span><span class="err">ï¼Œ</span><span class="n">dt_theta</span><span class="o">--&gt;</span><span class="n">quat</span><span class="p">,</span> <span class="n">quatçš„å·¦ä¹˜æ–¹æ³•</span>
     
     <span class="n">dt_theta</span> <span class="o">=</span> <span class="n">err_state</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">);</span>
     <span class="n">dt_omega_b</span> <span class="o">=</span> <span class="n">err_state</span><span class="p">(</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">);</span>
     <span class="n">dt_q</span> <span class="o">=</span> <span class="n">buildUpdateQuat</span><span class="p">(</span><span class="n">dt_theta</span><span class="p">);</span>
     <span class="n">quat</span> <span class="o">=</span> <span class="n">quatLeftComp</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span><span class="o">*</span><span class="n">dt_q</span><span class="p">;</span>
     <span class="n">quat</span> <span class="o">=</span> <span class="n">quat</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">quat</span><span class="p">);</span>
     <span class="n">omega_b</span> <span class="o">=</span> <span class="n">omega_b</span> <span class="o">+</span> <span class="n">dt_omega_b</span><span class="p">;</span>
     
     <span class="o">%</span> <span class="o">------</span><span class="n">save</span> <span class="n">angle</span><span class="o">-----------------------------</span>
     <span class="p">[</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">]</span> <span class="o">=</span> <span class="n">quattoeuler</span><span class="p">(</span><span class="n">quat</span><span class="p">);</span>
     <span class="n">oula</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">[</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">]</span><span class="o">/</span><span class="mi">180</span><span class="o">*</span><span class="n">pi</span><span class="p">;</span>
     <span class="n">dt_theta_save</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">err_state</span><span class="s">';
     % ----------------------------reset-------------------
     err_state = zeros(6,1);
     G = blkdiag(eye(3) - omegaMatrix(dt_theta/2) ,eye(3));
     P = G*P*G'</span><span class="p">;</span>
<span class="n">end</span>

<span class="o">%</span> <span class="n">figure</span><span class="p">;</span>
<span class="o">%</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="o">%</span> <span class="n">plot</span><span class="p">(</span><span class="n">pitchRef</span><span class="p">);</span>
<span class="o">%</span> <span class="n">hold</span> <span class="n">on</span><span class="p">;</span><span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">);</span>
<span class="o">%</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="o">%</span> <span class="n">plot</span><span class="p">(</span><span class="n">rollRef</span><span class="p">);</span>
<span class="o">%</span> <span class="n">hold</span> <span class="n">on</span><span class="p">;</span><span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">);</span>
<span class="o">%</span> <span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="o">%</span> <span class="n">plot</span><span class="p">(</span><span class="n">yawRef</span><span class="p">);</span>
<span class="o">%</span> <span class="n">hold</span> <span class="n">on</span><span class="p">;</span><span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span><span class="p">);</span>
<span class="o">%</span> <span class="n">legend</span> <span class="mi">1</span> <span class="mi">2</span> 

 <span class="n">rotLim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span> <span class="mi">5</span><span class="p">];</span>
<span class="n">figure</span><span class="p">;</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span> <span class="o">-</span> <span class="n">rollRef</span><span class="p">);</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span> <span class="o">-</span> <span class="n">pitchRef</span><span class="p">);</span>
<span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">oula</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="o">*</span><span class="mi">180</span> <span class="o">-</span> <span class="n">yawRef</span><span class="p">);</span>
<span class="n">legend</span> <span class="mi">1</span> <span class="mi">2</span> 
<span class="o">%</span> <span class="n">ylim</span><span class="p">(</span><span class="n">rotLim</span><span class="p">)</span>



<span class="n">function</span> <span class="n">R</span> <span class="o">=</span> <span class="n">q2R</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="o">%</span><span class="n">å››å…ƒæ•°è½¬æ—‹è½¬çŸ©é˜µ</span>
<span class="n">R</span><span class="o">=</span><span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>    <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
    <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>     <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">];</span>
<span class="n">R2</span> <span class="o">=</span> <span class="n">R</span><span class="p">;</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">Q_dt_theta</span> <span class="o">=</span> <span class="n">cal_Q_dt_theta</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
<span class="n">Q_dt_theta</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span> <span class="p">[</span><span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="p">...</span>
                <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>    <span class="n">quat</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="p">...</span>
                <span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="p">...</span>
               <span class="o">-</span><span class="n">quat</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>    <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">)];</span> 
<span class="n">end</span>

<span class="n">function</span> <span class="n">F</span> <span class="o">=</span> <span class="n">Exp_lee</span><span class="p">(</span><span class="ow">in</span><span class="p">)</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">omegaMatrix</span><span class="p">(</span><span class="ow">in</span><span class="p">);</span>
    <span class="n">normV</span>  <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">S</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">sin</span><span class="p">(</span><span class="n">normV</span><span class="p">)</span><span class="o">/</span><span class="n">normV</span><span class="o">*</span><span class="n">S</span><span class="p">(:,:)</span><span class="o">+</span><span class="p">...</span>
            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">normV</span><span class="p">))</span><span class="o">/</span><span class="n">normV</span><span class="o">^</span><span class="mi">2</span><span class="o">*</span><span class="n">S</span><span class="p">(:,:)</span><span class="o">^</span><span class="mi">2</span><span class="p">;</span>
<span class="n">end</span>
<span class="n">function</span> <span class="p">[</span><span class="n">omega</span><span class="p">]</span><span class="o">=</span><span class="n">omegaMatrix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="o">%</span> <span class="n">wx</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>
<span class="o">%</span> <span class="n">wy</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>
<span class="o">%</span> <span class="n">wz</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">;</span>
<span class="n">wx</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">wy</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">wz</span><span class="o">=</span><span class="n">data</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">omega</span><span class="o">=</span><span class="p">[</span>
    <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">wz</span><span class="p">,</span><span class="n">wy</span><span class="p">;</span>
    <span class="n">wz</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">wx</span><span class="p">;</span>
    <span class="o">-</span><span class="n">wy</span><span class="p">,</span><span class="n">wx</span><span class="p">,</span><span class="mi">0</span>
    <span class="p">];</span>
<span class="n">end</span>
<span class="n">function</span> <span class="n">q</span> <span class="o">=</span> <span class="n">R2q</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<span class="o">%</span><span class="n">æ—‹è½¬çŸ©é˜µè½¬å››å…ƒæ•°</span>
<span class="n">t</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="n">t</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">R</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">t</span><span class="p">)];</span>
<span class="n">Q1</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
<span class="n">end</span>

<span class="n">function</span>  <span class="n">q</span> <span class="o">=</span> <span class="n">oula2q</span><span class="p">(</span><span class="ow">in</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="ow">in</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">y</span> <span class="o">=</span> <span class="ow">in</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">z</span> <span class="o">=</span> <span class="ow">in</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="o">%</span><span class="n">æ¬§æ‹‰è§’è½¬å››å…ƒæ•°</span>
<span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
    <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
    <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">...</span>
    <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="mi">2</span><span class="p">)];</span>

<span class="n">end</span>
<span class="n">function</span> <span class="n">Ang3</span> <span class="o">=</span> <span class="n">q2oula</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="o">%</span><span class="n">å››å…ƒæ•°è½¬æ¬§æ‹‰è§’</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)),</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">));</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">));</span>
<span class="n">Ang3</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="n">y</span> <span class="n">z</span><span class="p">];</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">updateQuat</span> <span class="o">=</span> <span class="n">buildUpdateQuat</span><span class="p">(</span><span class="n">deltaTheta</span><span class="p">)</span>
    <span class="n">deltaq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">deltaTheta</span><span class="p">;</span>
    <span class="n">updateQuat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">;</span> <span class="n">deltaq</span><span class="p">];</span>
    <span class="n">updateQuat</span> <span class="o">=</span> <span class="n">updateQuat</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">updateQuat</span><span class="p">);</span>
<span class="n">end</span>

<span class="n">function</span> <span class="n">qLC</span> <span class="o">=</span> <span class="n">quatLeftComp</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">quat</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">scalar</span> <span class="o">=</span> <span class="n">quat</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    
    <span class="n">qLC</span> <span class="o">=</span> <span class="p">[</span>  <span class="n">scalar</span> <span class="p">,</span>  <span class="o">-</span><span class="n">vector</span><span class="s">';
             vector , scalar*eye(3) + crossMat(vector)  ];
end

function [H,detZ] = calH(q,measurements_k)
    % Normalise magnetometer measurement
    if(norm(measurements_k.mag) == 0), return; end	% 
    measurements_k.mag = measurements_k.mag / norm(measurements_k.mag);	% normalise magnitude,very important!!!!
    % Normalise accelerometer measurement
    if(norm(measurements_k.acc) == 0), return; end	% handle NaN
    measurements_k.acc  = measurements_k.acc / norm(measurements_k.acc);	% normalise accelerometer ,very important!!!!
    % Reference direction of Earth'</span><span class="n">s</span> <span class="n">magnetic</span> <span class="n">feild</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">quaternProd</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">quaternProd</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">],</span> <span class="n">quatInv</span><span class="p">(</span><span class="n">q</span><span class="p">)));</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="n">norm</span><span class="p">([</span><span class="n">h</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">h</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span> <span class="mi">0</span> <span class="n">h</span><span class="p">(</span><span class="mi">4</span><span class="p">)];</span>
    <span class="n">Ha</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                 	<span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>                    <span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>                         <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
         <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>                 	<span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>                   <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>                         <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
          <span class="mi">0</span><span class="p">,</span>                         <span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>                    <span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                         <span class="mi">0</span><span class="p">];</span>
    <span class="n">Hm</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>               <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>       <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
          <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>	   <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>    <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>       <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
           <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>                <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>	   <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>        <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)];</span>
    <span class="n">Hx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ha</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
          <span class="n">Hm</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)];</span>
<span class="o">%</span>     <span class="n">Hx</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ha</span><span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)];</span>
    <span class="n">Q_detTheta</span>  <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>    <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>      <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>    <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>       <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
                    <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>     <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>      <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
                   <span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>     <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>       <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)];</span>
    <span class="n">Xx</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">Q_detTheta</span> <span class="p">,</span> <span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
          <span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>       <span class="p">,</span> <span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)];</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">Hx</span><span class="o">*</span><span class="n">Xx</span><span class="p">;</span> 
    
    <span class="n">detZ_a</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">acc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
               <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">acc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
               <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">acc</span><span class="p">(</span><span class="mi">3</span><span class="p">)];</span>
<span class="o">%</span>     <span class="n">detZ</span>   <span class="o">=</span> <span class="n">detZ_a</span><span class="p">;</span>
    <span class="n">detZ_m</span> <span class="o">=</span><span class="p">[((</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
             <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
             <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span> <span class="o">-</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">measurements_k</span><span class="p">.</span><span class="n">mag</span><span class="p">(</span><span class="mi">3</span><span class="p">))];</span> 
    <span class="n">detZ</span>   <span class="o">=</span> <span class="p">[</span><span class="n">detZ_a</span><span class="p">;</span><span class="n">detZ_m</span><span class="p">];</span>
<span class="n">end</span>


<span class="n">function</span> <span class="p">[</span><span class="n">roll</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span><span class="n">yaw</span><span class="p">]</span> <span class="o">=</span> <span class="n">quattoeuler</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">rad2deg</span><span class="o">=</span><span class="mi">180</span><span class="o">/</span><span class="n">pi</span><span class="p">;</span>
<span class="n">T</span><span class="o">=</span><span class="p">[</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>         <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>       <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>     <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>      <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">q</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>          <span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span><span class="n">q</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">))];</span><span class="o">%</span><span class="n">cnb</span>
<span class="n">roll</span>  <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="p">;</span>
<span class="n">pitch</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="p">;</span>
<span class="n">yaw</span>   <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="o">-</span><span class="mf">8.3</span><span class="p">;</span><span class="o">%%</span><span class="n">è¿™ä¸ªå›ºå®šåå·®æ˜¯ä»€ä¹ˆé¬¼</span>  
<span class="n">yaw</span>   <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">rad2deg</span><span class="p">;</span><span class="o">%%</span><span class="n">è¿™ä¸ªå›ºå®šåå·®æ˜¯ä»€ä¹ˆé¬¼</span>  
<span class="n">end</span>
</code></pre></div></div>

<p>è¿™é‡Œé¢ä¸€ä¸ªå¾ˆé‡è¦çš„æ€§è´¨å°±æ˜¯ï¼š
\(\delta q=\left[\begin{array}{l}1 \\ \frac{1}{2} \delta \theta\end{array}\right]\)</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Quaternion kinematics for the error-state Kalman Filter.pdfÂ <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>

  </div><a class="u-url" href="/2016/11/20/IMU%E7%9A%84%E7%A7%AF%E5%88%86%E8%A1%A8%E7%A4%BA.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Your awesome title</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Your awesome title</li><li><a class="u-email" href="mailto:your-email@example.com">your-email@example.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/jekyll"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">jekyll</span></a></li><li><a href="https://www.twitter.com/jekyllrb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">jekyllrb</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
